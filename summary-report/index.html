<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>×“×•"×— 1001 ××¡×›× ×œ×“×™×•×Ÿ ×¦×• ×©×™×§×•×</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    * { box-sizing: border-box; }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      direction: rtl;
      text-align: right;
      margin: 0;
      background: #e5f6ff; /* ×—×–×¨×” ×œ×¨×§×¢ ×”××§×•×¨×™ */
      font-size: 12px;
      -webkit-font-smoothing: antialiased;
    }

    /* --- ×©×—×–×•×¨ ×”×¢×™×¦×•×‘ ×”××§×•×¨×™ ×©×œ ×”×›×•×ª×¨×ª --- */
    .top-bar {
      background: #0f766e;
      color: #fff;
      padding: 10px 18px;
      font-size: 18px;
      font-weight: 700;
      text-align: center;
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .page {
      max-width: 1100px;
      margin: 8px auto;
      padding: 8px;
    }

    /* --- ×©×—×–×•×¨ ×”×›×¨×˜×™×¡×™×•×ª ×”××§×•×¨×™×•×ª --- */
    .card {
      background: #f8fafc;
      border-radius: 14px;
      border: 1px solid #dbeafe;
      box-shadow: 0 6px 14px rgba(15, 23, 42, 0.06);
      padding: 8px 10px;
      margin-bottom: 8px;
    }

    .section-title {
      font-size: 13px;
      font-weight: 700;
      color: #0f172a;
      border-bottom: 1px solid #e2e8f0;
      padding-bottom: 4px;
      margin-bottom: 6px;
    }

    .sub-title {
      font-size: 12px;
      font-weight: 600;
      color: #0f766e; /* ×”×¦×‘×¢ ×”××§×•×¨×™ */
      margin: 6px 0 2px;
      text-align: right;
    }

    /* --- ×©×“×•×ª ×”×§×œ×˜ ×”××§×•×¨×™×™× --- */
    .row {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 6px;
      margin-bottom: 4px;
    }

    label {
      font-size: 11px;
      display: inline-flex;
      align-items: center;
      gap: 2px;
      color: #0f172a;
    }

    input[type="text"],
    input[type="number"],
    input[type="date"],
    select,
    textarea {
      font-size: 11px;
      padding: 3px 5px;
      border-radius: 8px;
      border: 1px solid #cbd5f5;
      background: #ffffff;
      font-weight: 600;
      color: #1d4ed8; /* ×›×—×•×œ ××§×•×¨×™ */
      line-height: 1.4;
    }
    
    input:disabled {
      background: #f1f5f9;
      color: #94a3b8;
      border-color: #e2e8f0;
    }

    textarea { resize: vertical; min-height: 28px; }

    /* --- ×’×“×œ×™× --- */
    .short { width: 80px; }
    .tiny { width: 50px; text-align: center; }
    .mini { width: 35px; text-align: center; }
    .medium { width: 120px; }
    .flex-1 { flex: 1; }

    /* --- ×¢×™×¦×•×‘×™× ×¡×¤×¦×™×¤×™×™× ×©×‘×™×§×©×ª --- */
    .currency-input { font-weight: 700; }
    
    /* ×¦×‘×¢×™× ××•×“×’×©×™× ×œ×¡×›×•××™× */
    .text-green { color: #15803d !important; font-weight: 800; }
    .text-red { color: #b91c1c !important; font-weight: 800; }
    
    /* × ×¢×™×œ×” ××“×•××” */
    .locked-section input, 
    .locked-section select {
      border: 1px solid #fecaca !important;
      background: #fef2f2 !important;
      color: #991b1b !important;
      pointer-events: none;
    }

    /* ×ª×•×•×™×•×ª ×‘×’×œ×™×©×ª ×˜×§×¡×˜ (×¢×‘×•×¨ ×”×©×•×¨×•×ª ×”×¦×¤×•×¤×•×ª) */
    .label-stack {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      line-height: 1;
      font-size: 10px;
      text-align: center;
      margin-inline-end: 2px;
      min-width: 35px;
    }

    /* --- ×’×¨×™×“ ×¨××©×™ --- */
    @media (min-width: 800px) {
      .layout-main {
        display: grid;
        grid-template-columns: 1fr 1.5fr; /* ×©×××œ ×™××™×Ÿ */
        gap: 8px;
        align-items: start;
      }
    }

    /* --- ×‘×œ×•×§ ×”××œ×¦×•×ª ×××•×—×“ --- */
    .recom-block {
      background: #f0fdf4; /* ×¨×§×¢ ×™×¨×§×¨×§ ×¢×“×™×Ÿ ×œ× ×××Ÿ */
      border: 1px solid #bbf7d0;
      border-radius: 8px;
      padding: 6px;
      margin-bottom: 6px;
    }
    .recom-block.comm {
      background: #eff6ff; /* ×¨×§×¢ ×›×—×œ×—×œ ×œ×××•× ×” */
      border-color: #bfdbfe;
    }

    .recom-grid {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 4px;
      margin-bottom: 4px;
      text-align: center;
    }
    .recom-grid label { display: block; font-size: 10px; margin-bottom: 2px; }
    .recom-grid input { width: 95%; text-align: center; }

    /* --- ×”×“×¤×¡×” (A4 ×‘×•×œ) --- */
    @media print {
      @page { size: A4 portrait; margin: 5mm; }
      body { background: white; -webkit-print-color-adjust: exact; }
      .top-bar { background: white; color: black; border-bottom: 2px solid black; position: static; padding: 0; margin-bottom: 10px; }
      .page { max-width: 100%; margin: 0; padding: 0; transform: scale(0.95); transform-origin: top center; }
      .card { border: none; border-bottom: 1px solid #000; box-shadow: none; padding: 2px 0; margin-bottom: 5px; border-radius: 0; background: transparent; }
      .section-title { color: black; border-bottom: 1px solid black; }
      .sub-title { color: black; text-decoration: underline; margin-top: 5px; }
      
      /* ××™×¤×•×¡ ×©×“×•×ª ×œ×”×“×¤×¡×” */
      input, select, textarea {
        border: none;
        border-bottom: 1px dotted #ccc;
        background: transparent !important;
        border-radius: 0;
        padding: 0;
        color: black !important;
        box-shadow: none !important;
      }
      
      /* ×ª×¨×’×•× ×¦×‘×¢×™× ×œ×”×“×¤×¡×” */
      .text-green, .text-red { color: black !important; font-weight: 900; text-decoration: underline; }
      .locked-section input { border-bottom: none !important; color: #ccc !important; }
      
      /* ×”×¡×ª×¨×ª ×›×¤×ª×•×¨×™× */
      button { display: none !important; }
      
      /* ×’×¨×™×“ ×œ×”×“×¤×¡×” */
      .layout-main { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    }
  </style>
</head>
<body>

  <div class="top-bar">
    ×“×•"×— ××¡×›× ×œ×“×™×•×Ÿ ×¦×• ×©×™×§×•×
  </div>

  <div class="page">
    <form id="mainForm">

      <div class="card">
        <div class="section-title">
          <span>×¤×¨×˜×™ ×ª×™×§ ×•×¦×• ×ª×©×œ×•××™×</span>
          <button type="button" onclick="window.print()" style="float:left; font-size:11px;">ğŸ–¨ ×”×“×¤×¡×”</button>
        </div>

        <div style="display:flex; gap:10px; justify-content:space-between;">
          <div style="flex:1;">
            <div class="row">
              <label>×ª×™×§ ×××•× ×”:</label><input type="text" class="short">
              <label>×ª×™×§ ×‘×™×”×"×©:</label><input type="text" class="short">
            </div>
            <div class="row">
              <label>×©× ×”×—×™×™×‘:</label><input type="text" class="medium">
              <label>×©× ×”× ×××Ÿ:</label><input type="text" class="medium">
            </div>
            <div class="row">
              <label>×ª××¨×™×š ×¦×•:</label><input type="date" id="orderDate" class="medium">
            </div>
          </div>

          <div style="flex:1.4; border-right:2px solid #e2e8f0; padding-right:8px;">
            <div class="row">
              <label>×ª×©×œ×•× ×—×•×“×©×™:</label>
              <input type="text" id="monthlyPayment" class="short currency-input" placeholder="â‚ª">
              <label>× ×›×•×Ÿ ×œ×™×•×:</label>
              <input type="date" id="calcDate" class="medium">
            </div>
            <div class="row">
              <label>×ª×©×œ×•× ××“×•×¨×’:</label>
              <input type="text" id="gradedPayment" class="short currency-input" placeholder="â‚ª">
              <label>×œ××©×š:</label>
              <input type="number" id="gradedMonths" class="mini" value="3">
              <label>×—×•×“×©×™×</label>
            </div>
            <div class="row" style="background:#ecfeff; padding:4px; border-radius:6px; border:1px solid #a5f3fc;">
              <label class="text-green">×¡×”"×›:</label>
              <input type="text" id="totalToPay" class="short currency-input text-green" readonly>
              <label>×—×•×“×©×™× ××”×¦×•:</label>
              <input type="text" id="monthsSinceOrder" class="mini" readonly>
            </div>
          </div>
        </div>

        <hr style="border-top:1px dashed #cbd5e1; margin:6px 0;">
        <div style="background:#fffbeb; padding:4px; border-radius:6px; border:1px solid #fde68a;">
          <div class="sub-title" style="margin-top:0; color:#b45309;">×”×—×œ×˜×•×ª ×××•× ×” (×¢×“×›×•×Ÿ ×¦×•)</div>
          
          <div class="row">
            <label>×ª××¨×™×š ×”×—×œ×˜×”:</label><input type="date" id="commDecDate">
            <label>×¡×›×•× ×§×‘×•×¢:</label><input type="text" id="commNewFixed" class="short currency-input">
            
            <label style="margin-right:8px;"><input type="checkbox" id="chkCustomDate" onchange="toggleField('commEffectiveDate', this.checked)"> ×ª×—×•×œ×” ××•×ª×××ª</label>
            <input type="date" id="commEffectiveDate" class="medium" disabled>
          </div>

          <div class="row">
            <label style="font-weight:bold;">×ª×©×œ×•× ××“×•×¨×’:</label>
            <input type="text" id="commGradedAmt" class="short currency-input">
            <label>××™×•×:</label><input type="date" id="commGradedDate">
            <label>×œ××©×š:</label><input type="number" id="commGradedDur" class="mini"><label>×—×•×“'</label>
          </div>
          
          <div class="row">
            <label>×”×¢×¨×•×ª ×”×××•× ×”:</label>
            <input type="text" class="flex-1" placeholder="×”×¢×¨×•×ª ×œ×”×—×œ×˜×”...">
          </div>
        </div>
      </div>

      <div class="layout-main">

        <div>
          <div class="card" id="debtorBlock">
            <div class="section-title">
              ×”×›× ×¡×•×ª ×”×—×™×™×‘
              <label style="font-size:11px; color:#b91c1c;">
                <input type="checkbox" onchange="toggleLock('debtorInputs', this.checked)"> ×”×—×™×™×‘ ××™× ×• ×¢×•×‘×“
              </label>
            </div>
            
            <div id="debtorInputs">
              <div class="row" style="flex-wrap:nowrap; gap:4px;">
                <input type="text" class="short" placeholder="××§×¦×•×¢">
                <input type="text" class="medium" placeholder="××§×•× ×¢×‘×•×“×”">
                <input type="text" class="short" placeholder="×”×™×§×£ ××©×¨×”">
                <input type="text" id="debtorNet" class="short currency-input text-green" placeholder="× ×˜×•">
              </div>
              
              <div class="row">
                <input type="text" class="short currency-input" placeholder="×¤×•×˜× ×¦×™××œ">
                <input type="text" class="flex-1" placeholder="×”×¢×¨×•×ª...">
              </div>
            </div>

            <div class="row" style="margin-top:6px; font-size:11px; align-items:center;">
              <label><input type="checkbox"> × ×›×•×ª</label>
              <label><input type="checkbox"> ×”.×”×›× ×¡×”</label>
              <label><input type="checkbox"> ×¡×™×•×¢ ×‘×©×›"×“</label>
              <div style="flex:1;"></div> <label>×¡×”"×› ×§×¦×‘××•×ª:</label>
              <input type="text" id="totalAllow" class="short currency-input">
            </div>
          </div>

          <div class="card">
            <div class="section-title">
              ×”×›× ×¡×•×ª ×‘×Ÿ/×ª ×”×–×•×’
              <label style="font-size:11px; color:#b91c1c;">
                <input type="checkbox" onchange="toggleLock('spouseInputs', this.checked)"> ××™× ×•/×” ×¢×•×‘×“/×ª
              </label>
            </div>
            <div id="spouseInputs" class="row" style="flex-wrap:nowrap;">
              <input type="text" class="medium" placeholder="××§×¦×•×¢">
              <input type="text" id="spouseNet" class="short currency-input text-green" placeholder="× ×˜×•">
              <input type="text" class="flex-1" placeholder="×”×¢×¨×•×ª...">
            </div>
            
            <div class="row" style="justify-content:flex-end; margin-top:8px; padding-top:4px; border-top:1px solid #e2e8f0;">
              <label>×¡×”"×› ×”×›× ×¡×•×ª:</label>
              <input type="text" id="grandTotalIncome" class="short currency-input text-green" readonly>
              <div style="width:20px;"></div>
              <label>×¡×”"×› ×”×•×¦××•×ª:</label>
              <input type="text" id="grandTotalExpenses" class="short currency-input text-red">
            </div>
          </div>
          
          <div class="card">
            <div class="sub-title" style="margin-top:0;">×¤×¨×˜×™× ××™×©×™×™× ×•××–×•× ×•×ª</div>
            <div class="row">
              <label>××¦×‘ ××©×¤×—×ª×™:</label>
              <select class="short"><option>× ×©×•×™</option><option>×¨×•×•×§</option><option>×’×¨×•×©</option></select>
              <label>×™×œ×“×™×:</label><input type="number" class="mini">
              
              <label>××–×•× ×•×ª:</label>
              <input type="checkbox" id="chkAlimony" onchange="toggleField('valAlimony', this.checked)">
              <input type="text" id="valAlimony" class="short currency-input" disabled>
            </div>
          </div>
        </div>

        <div>
          <div class="card">
            <div class="section-title">×”×ª× ×”×œ×•×ª ×•×—×•×‘×•×ª</div>
            
            <div class="sub-title">×”×ª× ×”×œ×•×ª</div>
            <div class="row">
              <label><input type="radio" name="rep" checked> ×›×¡×“×¨×</label>
              <label><input type="radio" name="rep"> ×—×œ×§×™</label>
              <label><input type="radio" name="rep"> ×œ× ×”×•×’×©×•</label>
            </div>
            <div class="row"><input type="text" class="flex-1" placeholder="×”×¢×¨×•×ª..."></div>

            <div class="row" style="background:#f1f5f9; padding:4px; border-radius:6px; flex-wrap:nowrap; margin-top:4px;">
              <div class="label-stack">××¡××›×™×<br>×—×¡×¨×™×</div>
              <select class="tiny" style="width:40px;"><option>×œ×</option><option>×›×Ÿ</option></select>
              
              <div style="width:10px; border-right:1px solid #ccc; height:20px; margin:0 5px;"></div>
              
              <div class="label-stack">×›××•×ª<br>×¤×™×’×•×¨×™×</div>
              <input type="number" class="tiny">
              
              <div class="label-stack">×¡×š<br>×¤×™×’×•×¨×™×</div>
              <input type="text" class="short currency-input text-red">
            </div>

            <div class="sub-title">×—×•×‘×•×ª</div>
            <div class="row">
              <label>××¡' × ×•×©×™×:</label><input type="number" class="tiny">
              <label>×¡×›×•× ×—×•×‘:</label><input type="text" class="short currency-input">
            </div>
            <div class="row" style="justify-content:center; background:#fff1f2; padding:2px; border-radius:4px;">
              <label class="text-red">×“×™×Ÿ ×§×“×™××”:</label>
              <input type="text" class="medium currency-input">
            </div>
            <div class="row" style="margin-top:4px;">
              <label><input type="checkbox" onchange="toggleField('valNonDis', this.checked)"> ×—×•×‘×•×ª ×œ× ×‘×¨×™ ×”×¤×˜×¨</label>
              <input type="text" id="valNonDis" class="short currency-input" disabled>
            </div>

            <div class="sub-title">× ×›×¡×™×</div>
            <div class="row" style="flex-wrap:nowrap; align-items:flex-end;">
              <div class="label-stack" style="text-align:right;">×“×™×¨×ª<br>××’×•×¨×™×</div>
              <input type="checkbox" style="margin-bottom:5px;">
              <input type="text" class="flex-1 currency-input" placeholder="×”×¢×¨×›×ª ×©×•×•×™">
            </div>
            <div class="row">
              <label><input type="checkbox"> ×¨×›×‘</label>
              <label><input type="checkbox"> ×–×›×•×™×•×ª</label>
              <label><input type="checkbox"> ××—×¨</label>
              <input type="text" class="flex-1 currency-input" placeholder="×©×•×•×™ ××™××•×©">
            </div>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="section-title">×¡×™×›×•× ×•×”××œ×¦×•×ª</div>
        
        <div class="recom-block">
          <div class="sub-title" style="margin-top:0;">×ª×•×›× ×™×ª ×”× ×××Ÿ</div>
          <div class="recom-grid">
            <div><label>×¡×›×•× ×—×•×“×©×™</label><input type="text" class="currency-input" id="trusM"></div>
            <div><label>×œ××©×š (×—×•×“')</label><input type="number" id="trusD"></div>
            <div><label>×¡×”"×› ×ª×•×›× ×™×ª</label><input type="text" class="currency-input" id="trusTot" readonly style="background:#dcfce7;"></div>
            <div><label>×ª×•×¡×¤×ª × ×›×¡×™×</label><input type="text" class="currency-input" id="trusAdd"></div>
            <div><label>×¡×”"×› ×œ×§×•×¤×”</label><input type="text" class="currency-input" id="trusGrand" readonly style="font-weight:900;"></div>
          </div>
          <div class="row">
            <textarea rows="2" class="flex-1" placeholder="×ª××¦×™×ª ×¢××“×ª ×”× ×××Ÿ..."></textarea>
          </div>
        </div>

        <div class="recom-block comm">
          <div class="sub-title" style="margin-top:0;">×ª×•×›× ×™×ª ×”×××•× ×”</div>
          <div class="recom-grid">
            <div><label>×¡×›×•× ×—×•×“×©×™</label><input type="text" class="currency-input" id="commM"></div>
            <div><label>×œ××©×š (×—×•×“')</label><input type="number" id="commD"></div>
            <div><label>×¡×”"×› ×ª×•×›× ×™×ª</label><input type="text" class="currency-input" id="commTot" readonly style="background:#ffffff;"></div>
            <div><label>×”×¢×¨×”/×ª×•×¡×¤×ª</label><input type="text" placeholder="×”×¢×¨×” ×§×¦×¨×”"></div>
            <div><label>×¡×”"×› ×œ×§×•×¤×”</label><input type="text" class="currency-input" id="commGrand" readonly style="font-weight:900;"></div>
          </div>
          <div class="row">
            <textarea rows="2" class="flex-1" placeholder="×ª××¦×™×ª ×¢××“×ª ×”×××•× ×”..."></textarea>
          </div>
        </div>
      </div>
      
      <div class="card" style="page-break-inside: avoid;">
        <div class="sub-title">××—×©×‘×•×Ÿ ×¢×–×¨</div>
        <iframe src="payment-order-calculator.html" style="width:100%; height:320px; border:none; border-radius:8px;"></iframe>
      </div>

    </form>
  </div>

  <script>
    // --- ×œ×•×’×™×§×” ×•×—×™×©×•×‘×™× --- //

    // 1. ××ª×—×•×œ
    document.addEventListener("DOMContentLoaded", () => {
       document.getElementById('calcDate').valueAsDate = new Date();
       setupCurrency();
       setupCalculations();
    });

    // 2. ×¤×•× ×§×¦×™×•×ª ×¢×–×¨ ×•×™×–×•××œ×™×•×ª
    function toggleField(id, state) {
      const el = document.getElementById(id);
      el.disabled = !state;
      if(!state) el.value = '';
    }

    function toggleLock(containerId, state) {
      const el = document.getElementById(containerId);
      if(state) {
        el.classList.add('locked-section');
        el.querySelectorAll('input').forEach(i => i.value = '');
      } else {
        el.classList.remove('locked-section');
      }
      calcIncomeTotal(); // ×—×™×©×•×‘ ××—×“×©
    }

    // 3. ×˜×™×¤×•×œ ×‘××˜×‘×¢ (×©"×— ×•×¤×¡×™×§×™×)
    function setupCurrency() {
      document.querySelectorAll('.currency-input').forEach(input => {
        input.addEventListener('blur', function() {
          let val = this.value.replace(/[^\d.]/g, '');
          if(val) this.value = parseFloat(val).toLocaleString('he-IL') + ' â‚ª';
        });
        input.addEventListener('focus', function() {
          this.value = this.value.replace(/[^\d.]/g, '');
        });
      });
    }
    
    function parseVal(val) {
      if(!val) return 0;
      return parseFloat(val.replace(/[^\d.]/g, '')) || 0;
    }

    // 4. ×›×œ ×”×—×™×©×•×‘×™× ×‘×“×£
    function setupCalculations() {
      // ×”××–× ×” ×œ×—×™×©×•×‘ ×”×›× ×¡×•×ª
      ['debtorNet', 'spouseNet', 'totalAllow'].forEach(id => {
        document.getElementById(id).addEventListener('blur', calcIncomeTotal);
      });

      // ×”××–× ×” ×œ×—×™×©×•×‘×™ ×”××œ×¦×•×ª (× ×××Ÿ/×××•× ×”)
      ['trus', 'comm'].forEach(p => {
        const m = document.getElementById(p+'M');
        const d = document.getElementById(p+'D');
        const a = document.getElementById(p+'Add') || {value:0}; // dummy if not exists
        
        const run = () => {
          const mon = parseVal(m.value);
          const dur = parseFloat(d.value) || 0;
          const add = p === 'trus' ? parseVal(a.value) : 0; // ×ª×•×¡×¤×ª ×¨×œ×•×•× ×˜×™×ª ×œ× ×××Ÿ
          
          const sum = mon * dur;
          document.getElementById(p+'Tot').value = sum.toLocaleString() + ' â‚ª';
          document.getElementById(p+'Grand').value = (sum + add).toLocaleString() + ' â‚ª';
        };
        
        if(m) m.addEventListener('blur', run);
        if(d) d.addEventListener('input', run);
        if(p==='trus' && a) a.addEventListener('blur', run);
      });

      // ×”××–× ×” ×œ×—×™×©×•×‘ ×¦×™×¨ ×”×–××Ÿ (Timeline)
      const timelineInputs = [
        'orderDate', 'calcDate', 'monthlyPayment', 'gradedPayment', 'gradedMonths',
        'commDecDate', 'commNewFixed', 'chkCustomDate', 'commEffectiveDate',
        'commGradedAmt', 'commGradedDate', 'commGradedDur'
      ];
      
      timelineInputs.forEach(id => {
        const el = document.getElementById(id);
        if(el) {
          el.addEventListener('blur', calcTimeline);
          if(el.type !== 'text') el.addEventListener('change', calcTimeline);
        }
      });
    }

    function calcIncomeTotal() {
      const d = parseVal(document.getElementById('debtorNet').value);
      const s = parseVal(document.getElementById('spouseNet').value);
      const a = parseVal(document.getElementById('totalAllow').value);
      document.getElementById('grandTotalIncome').value = (d+s+a).toLocaleString() + ' â‚ª';
    }

    // --- ×”"××•×—" ×©×œ ×”××—×©×‘×•×Ÿ (×œ×•×’×™×§×” ××œ××”) --- //
    function calcTimeline() {
      const orderDateStr = document.getElementById('orderDate').value;
      const calcDateStr = document.getElementById('calcDate').value;
      if(!orderDateStr || !calcDateStr) return;

      const start = new Date(orderDateStr);
      const end = new Date(calcDateStr);
      
      // ×ª××¨×™×š ×ª×©×œ×•× ×¨××©×•×Ÿ = ×—×•×“×© ××—×¨×™ ×”×¦×•
      const firstPay = new Date(start);
      firstPay.setMonth(start.getMonth() + 1);
      
      // × ×ª×•× ×™ ×‘×¡×™×¡
      const baseMon = parseVal(document.getElementById('monthlyPayment').value);
      const baseGrad = parseVal(document.getElementById('gradedPayment').value);
      const baseGradMonths = parseInt(document.getElementById('gradedMonths').value) || 3;

      // × ×ª×•× ×™ ×××•× ×”
      const commFixed = parseVal(document.getElementById('commNewFixed').value);
      const commDateRaw = document.getElementById('commDecDate').value;
      const commCustom = document.getElementById('chkCustomDate').checked;
      const commEffRaw = document.getElementById('commEffectiveDate').value;
      
      // ×§×‘×™×¢×ª ×ª××¨×™×š ×ª×—×•×œ×” ×œ×§×‘×•×¢ ×”×—×“×©
      let commEffDate = null;
      if(commFixed > 0 && (commDateRaw || (commCustom && commEffRaw))) {
        commEffDate = new Date(commCustom && commEffRaw ? commEffRaw : commDateRaw);
      }

      // × ×ª×•× ×™ ×××•× ×” - ××“×•×¨×’
      const cGradAmt = parseVal(document.getElementById('commGradedAmt').value);
      const cGradStartStr = document.getElementById('commGradedDate').value;
      const cGradDur = parseInt(document.getElementById('commGradedDur').value) || 0;
      
      let cGradStart = null;
      let cGradEnd = null;
      if(cGradAmt > 0 && cGradStartStr && cGradDur > 0) {
        cGradStart = new Date(cGradStartStr);
        cGradEnd = new Date(cGradStart);
        cGradEnd.setMonth(cGradEnd.getMonth() + cGradDur);
      }

      // ×”×¨×¦×” ×¢×œ ×¦×™×¨ ×”×–××Ÿ
      let total = 0;
      let months = 0;
      let curr = new Date(firstPay);
      curr.setDate(1); // × ×¨××•×œ ×œ-1 ×‘×—×•×“×©
      
      let safety = 0;
      while(curr <= end && safety < 300) {
        months++;
        let monthPay = 0;

        // ×”×™×¨×¨×›×™×”:
        // 1. ×”×× ×™×© ××“×•×¨×’ ×××•× ×” ×¤×¢×™×œ?
        let isCG = false;
        if(cGradStart && cGradEnd && curr >= cGradStart && curr < cGradEnd) {
          monthPay = cGradAmt;
          isCG = true;
        }

        if(!isCG) {
          // 2. ×”×× ×™×© ×§×‘×•×¢ ×××•× ×” ×¤×¢×™×œ?
          let isCF = false;
          if(commEffDate && curr >= commEffDate) {
             monthPay = commFixed;
             isCF = true;
          }

          if(!isCF) {
             // 3. ×‘×“×™×§×ª ××“×•×¨×’ ××§×•×¨×™ (×œ×¤×™ ×—×•×“×©×™× ××ª×—×™×œ×ª ×ª×©×œ×•×)
             if(months <= baseGradMonths && baseGrad > 0) {
                monthPay = baseGrad;
             } else {
                monthPay = baseMon;
             }
          }
        }
        
        total += monthPay;
        curr.setMonth(curr.getMonth() + 1);
        safety++;
      }

      document.getElementById('monthsSinceOrder').value = months;
      document.getElementById('totalToPay').value = total.toLocaleString() + ' â‚ª';
    }

  </script>
</body>
</html>
