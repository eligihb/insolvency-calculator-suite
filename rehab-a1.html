<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>מחשבון שיקום — v1.1 (Shell)</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#f4f7fb; --card:#fff; --ink:#0b1d2a; --muted:#516274; --line:#e8eef4; --accent:#0ea5e9;
      --warn:#f59e0b; --ok:#22c55e; --err:#ef4444; --past:#cbd5e1; --future:#e6f4ff; --partial:#e9d5ff;
      --rad:16px; --shadow:0 10px 30px rgba(15,23,42,.08);
      --panel-w: 28rem; --gap: 1rem; --pad: 14px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0; background:var(--bg); color:var(--ink); font-family:Heebo,system-ui,-apple-system,"Segoe UI",Arial;}

    /* Header */
    .topbar{position:sticky; top:0; z-index:20; background:rgba(255,255,255,.85); backdrop-filter:blur(10px); border-bottom:1px solid var(--line)}
    .topbar-inner{max-width:1400px; margin-inline:auto; padding:.6rem 1rem; display:flex; align-items:center; gap:.8rem}
    .brand{font-weight:700}
    .tabs{display:flex; gap:.5rem; margin-inline-start:auto}
    .tab{height:38px; padding:0 14px; border-radius:12px; border:1px solid var(--line); background:#fff; cursor:pointer}
    .tab[aria-current="page"]{background:var(--accent); color:#fff; border-color:var(--accent)}

    /* App layout */
    .wrap{max-width:1400px; margin-inline:auto; padding:1rem; display:grid; grid-template-columns:minmax(18rem,var(--panel-w)) 1fr; gap:var(--gap)}

    .card{background:var(--card); border:1px solid var(--line); border-radius:var(--rad); box-shadow:var(--shadow)}
    .panel{padding:var(--pad)}

    /* Controls (right) */
    .controls{position:sticky; top:84px; align-self:start; display:flex; flex-direction:column; gap:.8rem; max-height:calc(100dvh - 110px); overflow:auto}
    .controls h3{margin:.2rem 0 .3rem; font-size:1.05rem}
    .row{display:grid; grid-template-columns:1fr 1fr; gap:.6rem}
    label{font-size:.9rem; color:var(--muted)}
    input,select,button,textarea{width:100%; height:38px; padding:.45rem .6rem; border:1px solid #d7dee6; border-radius:12px; background:#fff; font-family:inherit}
    textarea{height:88px; resize:vertical}
    .actions{display:flex; flex-wrap:wrap; gap:.5rem}
    .btn{height:36px; padding:0 .9rem; border-radius:12px; border:1px solid #cfd8e3; background:#f7fafc; cursor:pointer}
    .btn.primary{background:var(--accent); border-color:var(--accent); color:#fff}

    /* Main (left) */
    .main{display:flex; flex-direction:column; gap:1rem}

    /* Sticky top actions in setup view */
    .sticky-top{position:sticky; top:84px; z-index:10; background:#ffffffcc; backdrop-filter:blur(6px); border-bottom:1px solid var(--line); padding:.5rem; display:flex; gap:.5rem}

    /* Widgets */
    .kpis{display:grid; grid-template-columns:repeat(4,1fr); gap:.8rem}
    .kpi{padding:12px; border-radius:14px; border:1px solid var(--line); background:linear-gradient(180deg,#fff,#fbfdff 80%)}
    .kpi .label{font-size:.85rem; color:var(--muted)}
    .kpi .value{font-size:1.4rem; font-weight:700}

    .flex{display:flex; gap:1rem}
    .grow{flex:1}

    .widget{padding:14px}
    .widget h4{margin:0 0 .6rem; font-size:1rem}

    .progressbar{height:12px; border-radius:999px; background:#eef3f8; overflow:hidden}
    .progressbar > span{display:block; height:100%; background:var(--accent); width:0}

    .svgbox{display:grid; place-items:center;}

    /* Payments grid */
    .months{display:grid; grid-template-columns:repeat(12,1fr); gap:.6rem}
    .mcard{padding:.55rem; border:1px solid var(--line); border-radius:12px; background:#fff; height:120px; display:grid; grid-template-rows:auto auto auto auto}
    .mcard h5{margin:0 0 .3rem; font-size:.95rem}
    .kv{display:flex; justify-content:space-between; font-size:.9rem; margin:.15rem 0}
    .kv strong{font-weight:600}
    .mcard.sel{outline:2px solid var(--accent)}

    /* State colors */
    .state-future{background:var(--future)}
    .state-current{box-shadow:inset 0 0 0 2px var(--accent)}
    .state-past{background:linear-gradient(180deg,#fff,#f1f5f9)}
    .state-arrears{background:#fee2e2}
    .state-advance{background:#fff7ed}
    .state-partial{background:#f5f3ff}
    .state-full{background:#ecfdf5}

    .toolbar{display:flex; align-items:center; gap:.6rem}

    .sticky{position:sticky; bottom:0; padding:.5rem; background:#ffffffcc; border-top:1px solid var(--line); backdrop-filter:blur(6px); display:flex; gap:.5rem}

    /* Views */
    [data-view]{display:none}
    [data-view].on{display:block}

    @media (max-width: 1080px){
      .wrap{grid-template-columns:1fr}
      .controls{position:static; max-height:none}
      .kpis{grid-template-columns:repeat(2,1fr)}
    }
    @media (max-width: 560px){
      .months{grid-template-columns:repeat(2,1fr)}
      .kpis{grid-template-columns:1fr}
    }
    @media print{
      .topbar, .controls, .sticky, .sticky-top, .toolbar{display:none !important}
      .wrap{padding:0}
      .months{grid-template-columns:repeat(12,1fr)}
      .mcard{padding:6px}
    }
  </style>
</head>
<body>
  <header class="topbar">
    <div class="topbar-inner">
      <div class="brand">מחשבון שיקום</div>
      <div class="tabs" role="tablist" aria-label="ניווט מסכים">
        <button class="tab" id="tab-setup" data-target="setup" aria-current="page">הזנה וניהול</button>
        <button class="tab" id="tab-payments" data-target="payments">תשלומים</button>
      </div>
    </div>
  </header>

  <div class="wrap">
    <!-- Controls (Right) -->
    <aside class="card panel controls" id="controls">
      <h3>הזנת פרטי החלטה</h3>
      <div class="row">
        <div>
          <label>שם ממלא/ת</label>
          <input id="f_filler" placeholder="שם מלא" />
        </div>
        <div>
          <label>תחולת חיוב</label>
          <select id="f_effect">
            <option value="next">חודש הבא</option>
            <option value="immediate">מיידי</option>
          </select>
        </div>
        <div>
          <label>מס' חודשים</label>
          <input id="f_months" type="number" min="1" max="84" value="24" />
        </div>
        <div>
          <label>סכום חודשי (₪)</label>
          <input id="f_amount" type="number" min="0" value="1200" />
        </div>
      </div>

      <!-- שורת חוקים: מדורג / הפחתה / הקדמה -->
      <h3>כללי חישוב</h3>
      <div class="row">
        <div>
          <label>מדורג — חודשים ראשונים</label>
          <input id="tier1_months" type="number" min="0" value="0" />
        </div>
        <div>
          <label>מדורג — סכום חודשי (₪)</label>
          <input id="tier1_amount" type="number" min="0" value="0" />
        </div>
        <div>
          <label>מדורג — חודשים שניים</label>
          <input id="tier2_months" type="number" min="0" value="0" />
        </div>
        <div>
          <label>מדורג — סכום חודשי (₪)</label>
          <input id="tier2_amount" type="number" min="0" value="0" />
        </div>
        <div>
          <label>הפחתת תשלומים (סה"כ ₪)</label>
          <input id="reduction_total" type="number" min="0" value="0" />
        </div>
        <div>
          <label>הקדמות מותרות?</label>
          <select id="allow_advances">
            <option value="no">לא</option>
            <option value="yes">כן</option>
          </select>
        </div>
      </div>

      <div class="actions">
        <button class="btn" id="btn-rebuild">בנה תוכנית</button>
      </div>
    </aside>

    <!-- Main (Left) -->
    <main class="main">
      <!-- View: Setup & Progress -->
      <section class="card panel on" data-view="setup" id="view-setup">
        <div class="sticky-top">
          <button class="btn" id="btn-reset">איפוס</button>
          <button class="btn" id="btn-send">שליחת נתונים</button>
          <button class="btn" id="btn-mail">שליחה במייל</button>
          <button class="btn primary" id="btn-print">הדפסה</button>
        </div>

        <div class="kpis" style="margin-top:.4rem">
          <div class="kpi"><div class="label">סכום חודשי</div><div class="value" id="kpi-month">₪ 0</div></div>
          <div class="kpi"><div class="label">מס' חודשים</div><div class="value" id="kpi-months">0</div></div>
          <div class="kpi"><div class="label">סכום כולל</div><div class="value" id="kpi-total">₪ 0</div></div>
          <div class="kpi"><div class="label">שולם עד כה</div><div class="value" id="kpi-paid">₪ 0</div></div>
        </div>

        <div class="flex">
          <section class="card widget grow">
            <h4>התקדמות כוללת</h4>
            <div class="progressbar" aria-label="התקדמות"><span id="bar" style="width:0%"></span></div>
            <div class="svgbox" style="height:160px">
              <svg id="ring" viewBox="0 0 120 120" width="160" height="160" role="img" aria-label="תרשים טבעת">
                <circle cx="60" cy="60" r="52" fill="none" stroke="#eef3f8" stroke-width="14" />
                <circle id="ringArc" cx="60" cy="60" r="52" fill="none" stroke="var(--accent)" stroke-width="14" stroke-linecap="round" stroke-dasharray="0 999" transform="rotate(-90 60 60)" />
                <text id="ringText" x="60" y="66" text-anchor="middle" font-size="20" font-weight="700">0%</text>
              </svg>
            </div>
          </section>

          <section class="card widget" style="min-width:320px">
            <h4>פרופיל תשלומים (12 חודשים)</h4>
            <svg id="bars" viewBox="0 0 320 160" width="100%" height="160" role="img" aria-label="תרשים עמודות"></svg>
          </section>
        </div>

        <div class="toolbar" style="margin-top:.6rem">
          <button class="btn" data-goto="payments">עבור לתצוגת תשלומים</button>
        </div>
      </section>

      <!-- View: Payments (12 per row) -->
      <section class="card panel" data-view="payments" id="view-payments">
        <div class="toolbar">
          <button class="btn" data-goto="setup">חזרה למסך הזנה</button>
        </div>
        <div id="years"></div>
      </section>
    </main>
  </div>

  <script>
    // ---------- State ----------
    const monthNames = ["ינו","פבר","מרץ","אפר","מאי","יונ","יול","אוג","ספט","אוק","נוב","דצמ"];
    const money = n => new Intl.NumberFormat('he-IL').format(Math.round(n||0));

    let plan = [];// [{y,m,due,paid}]

    function todayKey(){ const d=new Date(); return {y:d.getFullYear(), m:d.getMonth()}; }

    function buildPlan({months=24, amount=1200, effect='next', t1m=0, t1a=0, t2m=0, t2a=0, reduction=0}){
      const start = new Date();
      const offset = (effect === 'immediate') ? 0 : 1;
      const out = [];
      let remainingReduction = Math.max(0, reduction|0);
      for (let i=0;i<months;i++){
        const d = new Date(start.getFullYear(), start.getMonth()+i+offset, 1);
        let due = amount;
        if(i < t1m) due = t1a || amount; else if(i < t1m + t2m) due = t2a || amount;
        if(remainingReduction>0){
          const take = Math.min(remainingReduction, due);
          due -= take; remainingReduction -= take;
        }
        out.push({ y: d.getFullYear(), m: d.getMonth(), due: Math.max(0,due), paid: 0 });
      }
      return out;
    }

    // ---------- KPI / Progress ----------
    function recomputeKpis(){
      const month = +document.getElementById('f_amount').value || 0;
      const months = plan.length;
      const total = plan.reduce((s,x)=>s+(x.due||0),0);
      const paid = plan.reduce((s,x)=>s+(x.paid||0),0);
      const pct = total ? Math.min(100, Math.round(paid/total*100)) : 0;
      document.getElementById('kpi-month').textContent = '₪ ' + money(month);
      document.getElementById('kpi-months').textContent = months;
      document.getElementById('kpi-total').textContent = '₪ ' + money(total);
      document.getElementById('kpi-paid').textContent  = '₪ ' + money(paid);
      document.getElementById('bar').style.width = pct + '%';
      const circ = 2*Math.PI*52; const dash = Math.max(0, (pct/100)*circ);
      document.getElementById('ringArc').setAttribute('stroke-dasharray', dash + ' ' + (circ-dash));
      document.getElementById('ringText').textContent = pct + '%';
      drawBars();
    }

    function drawBars(){
      const svg = document.getElementById('bars'); svg.innerHTML = '';
      const W=320, H=160, pad=20; svg.setAttribute('viewBox',`0 0 ${W} ${H}`);
      const n = Math.min(12, plan.length); const slice = plan.slice(0,n);
      const maxVal = Math.max(1, ...slice.map(x=>Math.max(x.due, x.paid)));
      const bw = (W - pad*2) / n - 6;
      slice.forEach((x,i)=>{
        const dueH  = (x.due / maxVal) * (H - pad*2);
        const paidH = (x.paid/ maxVal) * (H - pad*2);
        const x0 = pad + i*(bw+6);
        if(i===0){ const axis = document.createElementNS('http://www.w3.org/2000/svg','line'); axis.setAttribute('x1',pad);axis.setAttribute('x2',W-pad);axis.setAttribute('y1',H-pad);axis.setAttribute('y2',H-pad);axis.setAttribute('stroke','#e5e9f0'); svg.appendChild(axis); }
        const r1 = document.createElementNS('http://www.w3.org/2000/svg','rect'); r1.setAttribute('x',x0); r1.setAttribute('y',H-pad-dueH); r1.setAttribute('width',bw); r1.setAttribute('height',dueH); r1.setAttribute('fill','#e5f5fd'); r1.setAttribute('rx','4'); svg.appendChild(r1);
        const r2 = document.createElementNS('http://www.w3.org/2000/svg','rect'); r2.setAttribute('x',x0); r2.setAttribute('y',H-pad-paidH); r2.setAttribute('width',bw); r2.setAttribute('height',paidH); r2.setAttribute('fill','var(--accent)'); r2.setAttribute('rx','4'); svg.appendChild(r2);
        const t = document.createElementNS('http://www.w3.org/2000/svg','text'); t.setAttribute('x', x0 + bw/2); t.setAttribute('y', H-4); t.setAttribute('text-anchor','middle'); t.setAttribute('font-size','10'); t.textContent = monthNames[x.m]; svg.appendChild(t);
      });
    }

    // ---------- Payments grid ----------
    function groupByYear(items){
      return items.reduce((a,x)=>{ (a[x.y] ||= []).push(x); return a; },{});
    }

    function classifyMonth(x){
      const t = todayKey();
      const idx = (x.y - t.y)*12 + (x.m - t.m);
      const hasPaid = (x.paid||0) > 0; const full = (x.paid||0) >= (x.due||0) && (x.due||0)>0; const partial = hasPaid && !full;
      const arrears = (idx < 0) && ((x.paid||0) < (x.due||0));
      const advanceNoApproval = (idx > 0) && hasPaid && (document.getElementById('allow_advances').value !== 'yes');
      if(arrears) return 'state-arrears';
      if(advanceNoApproval) return 'state-advance';
      if(full) return 'state-full';
      if(partial) return 'state-partial';
      if(idx === 0) return 'state-current';
      if(idx < 0) return 'state-past';
      return 'state-future';
    }

    function renderPayments(){
      const host = document.getElementById('years'); host.innerHTML = '';
      const byYear = groupByYear(plan);
      Object.keys(byYear).sort().forEach(y=>{
        const section = document.createElement('section'); section.className='panel card'; section.style.marginTop='.8rem';
        const title = document.createElement('div'); title.style.fontWeight='700'; title.style.marginBottom='.6rem'; title.textContent = y; section.appendChild(title);
        const grid = document.createElement('div'); grid.className='months'; section.appendChild(grid);
        const months = Array.from({length:12}, (_,i)=>i);
        months.forEach(m=>{
          const data = byYear[y].find(x=>x.m===m) || {y:+y,m, due:0, paid:0};
          const card = document.createElement('article'); card.className='mcard '+ classifyMonth(data);
          const isCurrent = (function(){const t=todayKey(); return (+y===t.y && m===t.m);})();
          if(isCurrent) card.classList.add('state-current');
          const h5 = document.createElement('h5'); h5.textContent = monthNames[m]; card.appendChild(h5);
          const kv1 = document.createElement('div'); kv1.className='kv'; kv1.innerHTML = `<span>חיוב</span><strong>₪ ${money(data.due)}</strong>`; card.appendChild(kv1);
          const kv2 = document.createElement('div'); kv2.className='kv'; kv2.innerHTML = `<span>שולם</span><strong>₪ ${money(data.paid)}</strong>`; card.appendChild(kv2);
          const arrears = Math.max(0,(data.due||0)-(data.paid||0));
          const kv3 = document.createElement('div'); kv3.className='kv'; kv3.innerHTML = `<span>פיגור</span><strong>${arrears? '₪ '+money(arrears): 'אין'}</strong>`; card.appendChild(kv3);
          grid.appendChild(card);
        });
        host.appendChild(section);
      });
    }

    // ---------- View switch ----------
    function switchTo(name){
      document.querySelectorAll('[data-view]').forEach(el=>el.classList.remove('on'));
      document.querySelector(`[data-view="${name}"]`)?.classList.add('on');
      document.querySelectorAll('.tab').forEach(b=>b.removeAttribute('aria-current'));
      document.querySelector(`.tab[data-target="${name}"]`)?.setAttribute('aria-current','page');
    }

    // ---------- Events ----------
    document.querySelectorAll('[data-goto]').forEach(b=> b.addEventListener('click', ()=> switchTo(b.dataset.goto)));
    document.querySelectorAll('.tab').forEach(b=> b.addEventListener('click', ()=> switchTo(b.dataset.target)));

    document.getElementById('btn-rebuild').addEventListener('click',()=>{
      const months  = +document.getElementById('f_months').value || 24;
      const amount  = +document.getElementById('f_amount').value || 0;
      const effect  = document.getElementById('f_effect').value;
      const t1m = +document.getElementById('tier1_months').value || 0;
      const t1a = +document.getElementById('tier1_amount').value || 0;
      const t2m = +document.getElementById('tier2_months').value || 0;
      const t2a = +document.getElementById('tier2_amount').value || 0;
      const reduction = +document.getElementById('reduction_total').value || 0;
      plan = buildPlan({months, amount, effect, t1m, t1a, t2m, t2a, reduction});
      recomputeKpis(); renderPayments();
    });

    document.getElementById('btn-reset').addEventListener('click',()=>{ if(confirm('לאפס הכל?')){ plan = []; document.getElementById('f_months').value = 24; document.getElementById('f_amount').value = 1200; document.getElementById('tier1_months').value=0; document.getElementById('tier1_amount').value=0; document.getElementById('tier2_months').value=0; document.getElementById('tier2_amount').value=0; document.getElementById('reduction_total').value=0; plan = buildPlan({months:24, amount:1200, effect:'next'}); recomputeKpis(); renderPayments(); }});
    document.getElementById('btn-print').addEventListener('click',()=>window.print());
    document.getElementById('btn-send').addEventListener('click',()=> alert('שליחת נתונים — נוסיף חיבור בפאזה הבאה'));
    document.getElementById('btn-mail').addEventListener('click',()=> alert('שליחה במייל — נוסיף חיבור בפאזה הבאה'));

    // ---------- Init ----------
    plan = buildPlan({months:24, amount:1200, effect:'next'});
    recomputeKpis();
    renderPayments();
  </script>
</body>
</html>
