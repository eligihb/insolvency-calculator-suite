<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>×“×•"×— ××¡×›× ×œ×“×™×•×Ÿ ×¦×• ×©×™×§×•×</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <style>
    /* ---------------------------------------------------- */
    /* 1. ×‘×¡×™×¡ ×•×¤×•× ×˜×™× */
    /* ---------------------------------------------------- */
    * { box-sizing: border-box; }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      direction: rtl;
      text-align: right;
      margin: 0;
      background: #e5f6ff;
      font-size: 12px;
    }

    .top-bar {
      background: #0f766e;
      color: #fff;
      padding: 10px 18px;
      font-size: 18px;
      font-weight: 700;
      text-align: center;
      position: sticky; 
      top: 0;
      z-index: 100;
    }

    .page {
      max-width: 1100px;
      margin: 8px auto;
      padding: 8px;
    }

    .card {
      background: #f8fafc;
      border-radius: 14px;
      border: 1px solid #dbeafe;
      box-shadow: 0 6px 14px rgba(15, 23, 42, 0.06);
      padding: 8px 10px;
      margin-bottom: 8px; 
      page-break-inside: avoid;
      break-inside: avoid;
    }
    
    .section-title { font-size: 14px; font-weight: 700; color: #0f172a; margin: 0; text-align: center; }
    .sub-title { font-size: 12px; font-weight: 600; color: #0f766e; margin: 4px 0 2px; text-align: right; }
    .row { display: flex; flex-wrap: wrap; align-items: center; gap: 6px; margin-bottom: 4px; }
    label { font-size: 11px; display: inline-flex; align-items: center; gap: 2px; }
    
    input[type="text"], input[type="number"], input[type="date"], input[type="month"], input[type="time"], textarea, select { 
        font-size: 11px; padding: 3px 5px; border-radius: 8px; border: 1px solid #cbd5f5; background: #ffffff; min-width: 0; font-weight: 600; color: #1d4ed8; line-height: 1.4;
    }
    input:disabled, input.readonly {
        background: #f1f5f9;
        color: #64748b;
        cursor: not-allowed;
    }
    textarea { resize: vertical; }

    .short   { width: 80px; }
    .tiny    { width: 50px; }
    .xshort  { width: 60px; }
    .flex-1  { flex: 1 1 0; }
    hr { border: none; border-top: 1px dashed #e2e8f0; margin: 3px 0; }
    
    /* ---------------------------------------------------- */
    /* 2. ×›×¤×ª×•×¨×™× ×•×”×“×’×©×•×ª ×›×œ×œ×™×•×ª */
    /* ---------------------------------------------------- */
    .buttons-inline { display: flex; gap: 6px; flex-wrap: wrap; justify-content: flex-start; margin-top: 4px; margin-bottom: 8px; }
    .btn { padding: 4px 9px; border-radius: 8px; font-weight: 600; font-size: 11px; white-space: nowrap; }
    .btn-print { background: #0ea5e9; color: #fff; }
    .btn-email { background: #6366f1; color: #fff; }
    .btn-reset { background: #fef2f2; color: #b91c1c; border: 1px solid #fecaca; }
    .btn-restore { background: #eef2ff; color: #1e3a8a; border: 1px solid #c7d2fe; }

    .order-box { border: 2px solid #0f766e; border-radius: 12px; padding: 6px 8px; background: #ecfeff; }
    .hearing-box { border: 1px solid #cbd5e1; border-radius: 8px; padding: 4px 6px; background: #eff6ff; margin-top: 2px; }
    
    /* ×”×“×’×©×•×ª */
    .status-bad-bold, .arrears-active input { color: #b91c1c !important; font-weight: 700; border-color: #b91c1c; }
    .alimony-active label, .alimony-active input { color: #b91c1c; border-color: #b91c1c; font-weight: 700; }
    
    /* ××™ ×›×•×©×¨ */
    .incapacity-input { border-color: #ff7b00 !important; }
    .incapacity-input.highlight-medium { border-width: 2px !important; }
    .incapacity-input.highlight-strong { border-width: 3px !important; }

    /* ×™×™×©×•×¨ ×¢××•×“×•×ª ×¤× ×™××™×•×ª */
    .col-grid { display: grid; grid-template-columns: repeat(3, minmax(0, 1fr)); gap: 8px; align-items: flex-start; }
    .col-grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; align-items: flex-start; }

    /* ---------------------------------------------------- */
    /* 3. ×¤×¨×™×¡×ª ×“×¡×§×˜×•×¤ (Grid Layout) */
    /* ---------------------------------------------------- */
    @media (min-width: 800px) {
        /* ××‘× ×” ×¨××©×™ (2 ×¢××•×“×•×ª - ×œ×œ× ×‘×œ×•×§ 1) */
        .main-grid-container {
            display: grid;
            grid-template-columns: 1fr 1.6fr; /* ×¦×¨ | ×¨×—×‘ */
            gap: 8px;
            align-items: flex-start;
        }

        /* ×‘×œ×•×§ 8 (××—×©×‘×•×Ÿ) ×•×‘×œ×•×§ 7 (×”××œ×¦×•×ª) */
        .recom-calc-wrapper {
            display: grid;
            grid-template-columns: 1fr 1.6fr;
            gap: 8px;
            margin-top: 8px;
        }
    }
    
    /* ---------------------------------------------------- */
    /* 4. ×¤×¨×™×¡×ª ×”×“×¤×¡×” (A4) - ×›×¤×™×™×ª ×¢××•×“ ××—×“ */
    /* ---------------------------------------------------- */
    @media print {
      @page { size: A4 portrait; margin: 5mm; }
      body { background: #ffffff; font-size: 10px !important; } /* ×¤×•× ×˜ ×§×˜×Ÿ ×™×•×ª×¨ ×œ×›×¤×™×™×ª ×¢××•×“ */
      .page {
        padding: 2mm;
        /* ×›×¤×™×™×ª ×”×›×œ ×œ×¢××•×“ ××—×“ - ×§×¨×™×˜×™ ×œ×”×‘× ×” */
        transform: scale(0.86); 
        transform-origin: top center;
        max-width: 100%;
        margin: 0;
      }
      .card { box-shadow: none; border: 1px solid #0f172a; border-radius: 0; padding: 6px 8px; }
      .buttons-inline { display: none !important; }
      .top-bar { border-bottom: 1px solid #0f172a; color: #0f172a; background: #fff; box-shadow: none; position: static; }
      .sub-title { color: #0f172a; font-weight: 700; margin: 2px 0; }
      .order-box, .hearing-box { background: #fff; border: 1px solid #0f172a; }
      
      /* ××™×¤×•×¡ ×¤×¨×™×¡×•×ª ××•×‘×™×™×œ ×•×“×¡×§×˜×•×¤ ×•×”×¦×’×” ×œ×™× ×™××¨×™×ª */
      .main-grid-container, .recom-calc-wrapper {
        display: block !important;
        gap: 0 !important;
      }
      .card { width: 100%; }
      .recom-grid { display: flex; flex-wrap: wrap; } /* ×”×¤×•×š ×œ-flex ×‘×”×“×¤×¡×” */
      .calc-frame-card iframe { height: 250px; } /* ×¦××¦×•× ×’×•×‘×” ×”××—×©×‘×•×Ÿ ×‘×”×“×¤×¡×” */
    }
  </style>
</head>
<body>
  <div class="top-bar">
    ×“×•"×— ××¡×›× ×œ×“×™×•×Ÿ ×¦×• ×©×™×§×•×
  </div>

  <div class="page">
    <form id="reportForm">
        
        <div class="buttons-inline">
            <button type="button" class="btn btn-print" onclick="window.print()">ğŸ–¨ ×”×“×¤×¡×” / PDF</button>
            <button type="button" class="btn btn-email" onclick="sendEmail()">âœ‰ ×©×œ×™×—×” ×‘××™×™×œ</button>
            <button type="button" class="btn btn-reset" onclick="document.getElementById('reportForm').reset()">â†º ××™×¤×•×¡</button>
            <button type="button" class="btn btn-restore" onclick="restoreFormState()">ğŸ” ×©×—×–×•×¨</button>
        </div>

        <div class="card">
            <div class="col-grid">
                <div>
                    <div class="sub-title">â—† ×¤×¨×˜×™ ×ª×™×§ ×•×“×™×•×Ÿ</div>
                    <div class="row">×ª×™×§ ×××•× ×”: <input type="text" class="short"> ×ª×™×§ ×‘×™×”×"×©: <input type="text" class="short"></div>
                    <div class="row">×©× ×”×—×™×™×‘/×ª: <input type="text" class="short"> ×©× ×”× ×××Ÿ: <input type="text" class="short"></div>
                    <div class="row">×ª××¨×™×š ×¦×•: <input type="date" id="orderDate" class="short"> <label style="font-weight:700;">(×©×“×” ×§×¨×™×˜×™)</label></div>
                    <div class="row">×œ×‘×§×©×ª: <label><input type="radio" name="order_by"> ×—×™×™×‘</label><label><input type="radio" name="order_by"> × ×•×©×”</label></div>
                    <div class="hearing-box">
                        <div class="row no-wrap">××§×•× ×©×™×¤×•×˜: <input type="text" class="tiny"> ×ª××¨×™×š ×“×™×•×Ÿ: <input type="date" class="short"></div>
                        <div class="row">×©×¢×ª ×“×™×•×Ÿ: <input type="time" class="short" step="300"> ×©× ×”×©×•×¤×˜: <input type="text" class="short"></div>
                    </div>
                </div>

                <div>
                    <div class="sub-title">â—† ×¦×• ×ª×©×œ×•××™× (×¡×™×›×•×)</div>
                    <div class="order-box" style="margin-bottom: 8px;">
                        <div class="sub-title" style="color:#0f172a; margin-top:0;">×ª×©×œ×•× ×—×•×“×©×™ × ×•×›×—×™: <input type="text" class="short currency-input" id="currentMonthlyPayment" readonly style="font-weight:700; color:#0f766e;"></div>
                        <div class="row">××§×•×¨: <input type="text" class="medium" readonly id="paymentSource" placeholder="×¦×• ××§×•×¨×™ / ×”×—×œ×˜×ª ×××•× ×”"></div>
                        <div class="row no-wrap">×¡×”"×› ×—×•×“×©×™×: <input type="text" id="monthsSinceOrder" class="xshort readonly" readonly> ×¡×”"×› ×œ×”×™×•×: <input type="text" id="paymentsTotalAmount" class="short currency-input readonly" readonly></div>
                    </div>

                    <div class="sub-title">×¦×• ××§×•×¨×™ (×ª×©×œ×•× ×‘×¡×™×¡)</div>
                    <div class="row">
                        ×ª×©×œ×•× ×—×•×“×©×™: <input type="text" id="baseMonthlyPayment" class="short currency-input">
                        ××™×•×: <input type="date" class="short" id="basePaymentDate">
                    </div>
                    <div class="row" style="align-items: flex-start;">
                        <label><input type="checkbox" id="hasGradedPayment"> ×ª×©×œ×•× ××“×•×¨×’:</label>
                        <input type="text" id="gradedAmount" class="short currency-input" disabled>
                        <span class="pair"> ×ª×§×•×¤×”: <input type="number" id="gradedDuration" class="tiny" min="0" disabled> ×—×•×“×©×™×</span>
                    </div>

                    <div class="sub-title" style="margin-top: 8px;">×”×—×œ×˜×ª ×××•× ×” (×ª×©×œ×•××™×)</div>
                    <div class="row">
                        <label><input type="checkbox" id="hasCommissionOrder"> ×™×© ×”×—×œ×˜×”</label>
                        ×ª××¨×™×š ×”×—×œ×˜×”: <input type="date" class="short" id="commissionOrderDate" disabled>
                    </div>
                    <div class="row">
                        ×¡×›×•× ×—×•×“×©×™: <input type="text" id="commissionMonthlyPayment" class="short currency-input" disabled>
                        <span class="pair"> ×ª×§×•×¤×”: <input type="number" id="commissionDuration" class="tiny" min="0" disabled> ×—×•×“×©×™×</span>
                    </div>
                    <div class="small-text" style="color:#475569;">(×‘×¡×™×•× ×”×ª×§×•×¤×” ×”×—×™×•×‘ ×—×•×–×¨ ×œ×¡×›×•× ×”×¦×• ×”××§×•×¨×™)</div>
                </div>

                <div>
                    <div class="sub-title">â—† ×¤×¨×˜×™× ××™×©×™×™×</div>
                    <div class="row" style="flex-wrap:wrap;">
                        ××¦×‘ ××©×¤×—×ª×™: <label><input type="radio" name="family_status" value="×¨×•×•×§"> ×¨×•×•×§</label><label><input type="radio" name="family_status" value="× ×©×•×™"> × ×©×•×™</label><label><input type="radio" name="family_status" value="×’×¨×•×©"> ×’×¨×•×©</label><label><input type="radio" name="family_status" value="××œ××Ÿ"> ××œ××Ÿ</label>
                    </div>
                    <div class="row">
                        ×™×œ×“×™× ×§×˜×™× ×™×: <input type="number" id="minorChildrenCount" class="short" min="0" max="11">
                        <span id="alimonyWrapper" class="pair">
                            <label><input type="checkbox" id="hasAlimony"> ××–×•× ×•×ª</label>
                            <input type="text" id="alimonyAmount" class="short currency-input" disabled>
                        </span>
                    </div>
                    <hr>
                    <div class="sub-title">â—† ××¦×‘ ×¨×¤×•××™ ×•××™×©×•×¨×™ ××œ"×œ</div>
                    <div class="row" id="incapacityRow">
                        × ×›×•×ª: <input type="text" class="short percent-field" id="disabilityPercent" maxlength="3" placeholder="0%">
                        ××™ ×›×•×©×¨: <input type="text" class="short percent-field" id="incapacityPercent" maxlength="3" placeholder="0%">
                    </div>
                    <div class="row allowances-title-row">
                        <span class="allowance-title">×§×¦×‘××•×ª</span>
                    </div>
                    <div class="row" style="justify-content:flex-start;flex-wrap:wrap;">
                        <label><input type="checkbox"> ×§×¦×‘×ª ×™×œ×“ × ×›×”</label><label><input type="checkbox"> ×”×‘×˜×—×ª ×”×›× ×¡×”</label><label><input type="checkbox"> ×¡×™×•×¢ ×©×›"×“</label>
                    </div>
                    <div class="row medical-notes-row">×‘×¢×™×•×ª ×¨×¤×•××™×•×ª (×ª××¦×™×ª×™): <input type="text" class="flex-1"></div>
                </div>
            </div>
        </div>

        <div class="main-grid-container">
            
            <div>
                <div data-step="2" data-label="×—×•×‘×•×ª ×•× ×›×¡×™×" class="card narrow-col">
                    <div class="section-title" style="border-bottom:1px solid #e2e8f0;padding-bottom:2px;margin-bottom:4px;">×”×ª× ×”×œ×•×ª ×”×—×™×™×‘, ×—×•×‘×•×ª ×•× ×›×¡×™×</div>
                    <div class="sub-title">×”×ª× ×”×œ×•×ª ×”×—×™×™×‘</div>
                    <div class="small-text">×“×•"×—×•×ª ×—×•×“×©×™×™×:</div>
                    <div class="row">
                      <label class="reports-status-full"><input type="radio" name="reports_status" value="full"> ×”×•×’×©×•</label>
                      <label class="reports-status-partial"><input type="radio" name="reports_status" value="partial"> ×—×œ×§×™</label>
                      <label class="reports-status-none"><input type="radio" name="reports_status" value="none"> ×œ× ×”×•×’×©×•</label>
                    </div>
                    <div class="row">×”×¢×¨×•×ª: <input type="text" class="flex-1"></div>
                    <div class="sub-title" style="margin-top:4px;">××¡××›×™× ×•×ª×©×œ×•××™×</div>
                    <div class="row docs-row" style="justify-content: flex-start; gap: 10px;">
                      <span class="pair"><span>××¡××›×™× ×—×¡×¨×™×:</span> <label><input type="radio" name="missing_docs"> ×›×Ÿ</label><label><input type="radio" name="missing_docs"> ×œ×</label></span>
                      <span class="pair" style="margin-inline-start: 10px;"><span class="arrears-label">âš  ×¡×š ×¤×™×’×•×¨×™×:</span><input type="text" id="arrearsAmount" class="short currency-input status-bad-bold"></span>
                    </div>
                    <hr><div class="sub-title">×—×•×‘×•×ª</div>
                    <div class="row debts-row" style="justify-content: flex-start; gap: 4px;">
                      <span class="pair"><span class="pair-label-multiline">××¡' × ×•×©×™×</span><input type="number" class="tiny" min="0" max="99"></span>
                      <span class="pair"><span class="pair-label-multiline" style="white-space: normal; max-width: 70px;">×¡×›×•× ×›×•×œ×œ</span><input type="text" id="debtsTotal" class="short currency-input"></span>
                      <span class="pair"><span class="pair-label-multiline" style="white-space: normal; max-width: 70px;">×“×™×Ÿ ×§×“×™××”</span><input type="text" id="debtsPriority" class="short currency-input"></span>
                    </div>
                    <div class="row">×ª×‘×™×¢×•×ª ×—×•×‘ × ×‘×“×§×•: <label><input type="radio" name="claims_checked"> ×›×Ÿ</label><label><input type="radio" name="claims_checked"> ×œ×</label></div>
                    <div class="sub-title">×—×•×‘×•×ª ×œ× ×‘×¨×™ ×”×¤×˜×¨</div>
                    <div class="row" style="flex-wrap:wrap; justify-content: flex-start; gap: 10px;">
                      <span class="pair"><label><input type="checkbox" id="alimonyDebtChk"> ××–×•× ×•×ª</label><input type="text" id="alimonyDebtAmount" class="short currency-input" min="0" max="99999"></span>
                      <span class="pair"><label><input type="checkbox" id="taxDebtChk"> ×§× ×¡×•×ª</label><input type="text" id="taxDebtAmount" class="short currency-input" min="0" max="99999"></span>
                    </div>
                    <hr><div class="sub-title">× ×›×¡×™×</div>
                    <div class="row" style="justify-content: space-between; flex-wrap: wrap;">
                      <span class="pair"><label><input type="checkbox"> ×“×™×¨×ª ××’×•×¨×™×</label><label><input type="checkbox"> × ×›×¡</label><label><input type="checkbox"> ×¨×›×‘</label><label><input type="checkbox"> ×–×›×•×™×•×ª</label></span>
                      <span class="pair">×”×¢×¨×›×ª ×©×•×•×™: <input type="text" class="short currency-input"></span>
                    </div>
                </div> 
                
                <div data-step="4" data-label="×”××œ×¦×•×ª" class="card" id="trusteeCard" style="margin-top: 8px;">
                    <div class="section-title" style="border-bottom:1px solid #e2e8f0;padding-bottom:2px;margin-bottom:4px;">×¡×™×›×•× ×•×”××œ×¦×•×ª ×”× ×××Ÿ</div>
                    <div class="row" style="justify-content:space-between;align-items:center;"><div class="sub-title" style="margin-bottom:0;">×¡×™×›×•× ×”× ×××Ÿ</div><label><input type="checkbox"> ×”×›×©×¨×” ×›×œ×›×œ×™×ª</label></div>
                    <div class="row"><textarea rows="2" class="flex-1" placeholder="×ª××¦×™×ª ×¢××“×ª ×”× ×××Ÿ (×©×ª×™ ×©×•×¨×•×ª)"></textarea></div>
                    <div class="row" style="justify-content:flex-start;align-items:center;"><div class="sub-title" style="margin-bottom:0;">×”××œ×¦×ª × ×××Ÿ</div></div>
                    <div class="order-box" style="margin-top:2px;">
                        <div class="recom-grid">
                            <div class="recom-item"><label>×¡×›×•× ×—×•×“×©×™</label><input type="text" id="trusteeMonthly" class="currency-input xshort" maxlength="6"></div>
                            <div class="recom-item"><label>×ª×§×•×¤×”</label><input type="number" id="trusteeDuration" class="tiny" min="0" max="99"></div>
                            <div class="recom-item"><label>×¡×”"×›</label><input type="text" id="trusteeTotal" class="currency-input xshort recom-total" readonly></div>
                        </div>
                    </div>
                    <hr> 
                    <div class="section-title" style="border-bottom:1px solid #e2e8f0;padding-bottom:2px;margin-bottom:4px; margin-top:8px;">×¡×™×›×•× ×•×”××œ×¦×•×ª ×”×××•× ×”</div>
                    <div class="row" style="justify-content:space-between;align-items:center;margin-top:6px;"><div class="sub-title" style="margin-bottom:0;">×¡×™×›×•× ×”×××•× ×”</div><label><input type="checkbox"> ×”×›×©×¨×” ×›×œ×›×œ×™×ª</label></div>
                    <div class="row"><textarea rows="2" class="flex-1" placeholder="×ª××¦×™×ª ×¢××“×ª ×”×××•× ×” (×©×ª×™ ×©×•×¨×•×ª)"></textarea></div>
                    <div class="row" style="justify-content:flex-start;align-items:center;"><div class="sub-title" style="margin-bottom:0;">×”××œ×¦×ª ×”×××•× ×”</div></div>
                    <div class="order-box order-box-comm" style="margin-top:2px;">
                        <div class="recom-grid">
                            <div class="recom-item"><label>×¡×›×•× ×—×•×“×©×™</label><input type="text" id="commMonthly" class="currency-input xshort" maxlength="6"></div>
                            <div class="recom-item"><label>×ª×§×•×¤×”</label><input type="number" id="commDuration" class="tiny" min="0" max="99"></div>
                            <div class="recom-item"><label>×¡×”"×›</label><input type="text" id="commTotal" class="currency-input xshort recom-total" readonly></div>
                        </div>
                    </div>
                </div>
            </div>

            <div>
                <div data-step="4b" data-label="××—×©×‘×•×Ÿ" class="calc-frame-card card grid-item-B2" id="calcCard">
                    <div class="sub-title" style="margin-top:0;">××—×©×‘×•×Ÿ ×¦×• ×ª×©×œ×•××™×</div>
                    <iframe src="payment-order-calculator.html" loading="lazy"></iframe>
                </div>

                <div data-step="3" data-label="×”×›× ×¡×•×ª" class="card grid-item-A2" id="incomeCard" style="display:flex;flex-direction:column; margin-top: 8px;">
                    <div class="section-title" style="border-bottom:1px solid #e2e8f0;padding-bottom:2px;margin-bottom:4px;">×”×›× ×¡×•×ª ×”×—×™×™×‘, ×‘×Ÿ/×‘×ª ×”×–×•×’ ×•×¡×™×›×•×</div>
                    <div class="sub-title">×”×›× ×¡×•×ª ×”×—×™×™×‘</div>
                    <div class="row" style="flex-wrap:wrap;">
                      ××§×¦×•×¢: <input type="text" class="short"> ××§×•× ×¢×‘×•×“×”: <input type="text" class="short"> ×”×™×§×£ ××©×¨×”: <input type="text" class="short">
                    </div>
                    <div class="row" style="flex-wrap:wrap; justify-content: flex-start; gap: 12px;">
                        <span class="pair">
                            <label>×©×›×¨ × ×˜×•:</label><input type="text" id="debtorNetIncome" class="short currency-input">
                            <label><input type="checkbox" id="debtorNotWorking"> ×”×—×™×™×‘ ××™× ×• ×¢×•×‘×“</label>
                        </span>
                        <span class="pair" style="margin-inline-start: 10px;">
                            <label style="white-space:nowrap;">×¤×•×˜× ×¦×™××œ ×”×©×ª×›×¨×•×ª:</label><input type="text" id="earningPotential" class="short currency-input">
                        </span>
                    </div>
                    <div class="row">×”×¢×¨×•×ª: <input type="text" id="earningPotentialNotes" class="flex-1"></div>

                    <hr>
                    <div class="sub-title">×§×¦×‘××•×ª</div>
                    <div class="allowance-input-row" id="allowanceInputs">
                        <div class="row" style="justify-content: flex-start; gap: 10px;">
                            <span style="flex: 2 1 0;"><input type="text" placeholder="×¡×•×’ ×§×¦×‘×”" class="flex-1 allowance-type" id="allowanceType1"></span>
                            <span style="flex: 1 1 0;"><input type="text" placeholder="×¡×›×•×" class="currency-input allowance-amount" id="allowanceAmount1"></span>
                        </div>
                        <div class="row" style="justify-content: flex-start; gap: 10px;">
                            <span style="flex: 2 1 0;"><input type="text" placeholder="×¡×•×’ ×§×¦×‘×” × ×•×¡×¤×ª (××•×¤×¦×™×•× ×œ×™)" class="flex-1 allowance-type" id="allowanceType2"></span>
                            <span style="flex: 1 1 0;"><input type="text" placeholder="×¡×›×•×" class="currency-input allowance-amount" id="allowanceAmount2"></span>
                        </div>
                    </div>
                    <hr>
                    
                    <div class="sub-title">×”×›× ×¡×•×ª ×‘×Ÿ/×‘×ª ×”×–×•×’</div>
                    <div class="row" style="flex-wrap:wrap;">
                      ××§×¦×•×¢: <input type="text" class="short"> ××§×•× ×¢×‘×•×“×”: <input type="text" class="short"> ×”×™×§×£ ××©×¨×”: <input type="text" class="short">
                    </div>
                    <div class="row not-working-toggle-row" id="spouseIncomeRow">
                      ×©×›×¨ × ×˜×•: <input type="text" id="spouseNetIncome" class="short currency-input">
                      <label><input type="checkbox" id="spouseNotWorking"> ×‘×Ÿ/×‘×ª ×”×–×•×’ ××™× ×•/×” ×¢×•×‘×“/×ª</label>
                    </div>
                    <hr>
                    <div class="income-expense-row">
                        <span class="pair"><label>×¡×š ×”×›×œ ×”×›× ×¡×•×ª:</label><input type="text" id="familyIncomeTotal" class="currency-input short"></span>
                        <span class="pair"><label>×¡×š ×”×›×œ ×”×•×¦××•×ª:</label><input type="text" id="familyExpensesTotal" class="currency-input short"></span>
                    </div>
                </div>
            </div>

        </div> </div> </form>
    
    <div class="footer">
      × ×‘× ×” ×¢×œ ×™×“×™ ××œ×™××‘ ×™×—×™××œ
    </div>

  </div> <div class="mobile-fixed-elements mobile-navigation-wrapper">
    <div class="mobile-navigation">
        <button type="button" id="nav-prev" class="mobile-nav-btn nav-prev" disabled>â† ×§×•×“×</button>
        <button type="button" id="nav-next" class="mobile-nav-btn nav-next">×”×‘× â†’</button>
    </div>
  </div>


  <button type="button" id="scrollTopBtn" class="scroll-top-btn">â†‘</button>

  <script>
    // ×”×’×“×¨×•×ª ××¢×¨×›×ª ×”× ×™×•×•×˜ ×”×¨×‘-×©×œ×‘×™×ª (4 ×©×œ×‘×™× ×‘××•×‘×™×™×œ)
    const formFlowContainer = document.getElementById('form-flow-container');
    const navPrevBtn = document.getElementById('nav-prev');
    const navNextBtn = document.getElementById('nav-next');
    const progressFill = document.getElementById('progress-fill');
    const progressText = document.getElementById('progress-text');
    const currentStepLabel = document.getElementById('current-step-label');
    
    const allSteps = [
        document.querySelector('[data-step="1"]'), 
        document.querySelector('[data-step="2"]'), 
        document.querySelector('[data-step="3"]'),
        document.querySelector('[data-step="4"]')
    ];

    const totalSteps = allSteps.length; 
    let currentStep = 1;

    function isMobileView() {
        return window.innerWidth <= 800;
    }

    function updateFlow() {
        if (!isMobileView()) {
            formFlowContainer.style.transform = `translateX(0)`;
            return;
        }

        const offset = (currentStep - 1) * -25;
        formFlowContainer.style.transform = `translateX(${offset}%)`;

        const progressPercent = (currentStep / totalSteps) * 100;
        progressFill.style.width = `${progressPercent}%`;
        progressText.textContent = `${currentStep}/${totalSteps}`;
        
        navPrevBtn.disabled = currentStep === 1;
        navNextBtn.disabled = currentStep === totalSteps;

        let currentLabel = '×”××œ×¦×•×ª ×•××—×©×‘×•×Ÿ';
        if (currentStep === 1) currentLabel = allSteps[0].dataset.label;
        if (currentStep === 2) currentLabel = allSteps[1].dataset.label;
        if (currentStep === 3) currentLabel = allSteps[2].dataset.label;
        if (currentStep === 4) currentLabel = "×”××œ×¦×•×ª ×•××—×©×‘×•×Ÿ";

        currentStepLabel.textContent = `${currentStep}. ${currentLabel}`;

        document.body.scrollTop = 0; 
        document.documentElement.scrollTop = 0; 
    }

    function navigate(direction) {
        const newStep = currentStep + direction;
        if (newStep >= 1 && newStep <= totalSteps) {
            currentStep = newStep;
            updateFlow();
        }
    }

    if (navNextBtn) navNextBtn.addEventListener('click', () => navigate(1));
    if (navPrevBtn) navPrevBtn.addEventListener('click', () => navigate(-1));

    let touchStartX = 0;
    let touchEndX = 0;
    
    formFlowContainer.addEventListener('touchstart', e => {
      if (!isMobileView()) return;
      touchStartX = e.changedTouches[0].screenX;
    });

    formFlowContainer.addEventListener('touchend', e => {
      if (!isMobileView()) return;
      touchEndX = e.changedTouches[0].screenX;
      handleGesture();
    });

    function handleGesture() {
      const swipeThreshold = 50; 
      const diff = touchEndX - touchStartX;

      if (Math.abs(diff) > swipeThreshold) {
        if (diff > 0) { 
          navigate(-1);
        } else { 
          navigate(1);
        }
      }
    }

    function setupPercentField(id) {
      const el = document.getElementById(id);
      if (!el) return;
      el.addEventListener('focus', () => {
        el.value = el.value.replace('%','').trim();
      });
      el.addEventListener('blur', () => {
        let v = el.value.replace(/[^\d]/g,'');
        if (!v) { 
            el.value = ''; 
            updateIncapacityVisualAndCalcFlags();
            return; 
        }
        if (v.length > 3) v = v.slice(0,3);
        el.value = v + '%';
        updateIncapacityVisualAndCalcFlags();
      });
    }

    function parseNumberFromPercent(val) {
        if (!val) return 0;
        const clean = String(val).replace(/[^\d]/g,'');
        const num = parseInt(clean, 10);
        return isNaN(num) ? 0 : num;
    }

    function updateIncapacityVisualAndCalcFlags() {
        const incapacityEl = document.getElementById('incapacityPercent');
        const disabilityEl = document.getElementById('disabilityPercent');
        const incapVal = parseNumberFromPercent(incapacityEl ? incapacityEl.value : '0%');
        const disVal = disabilityEl ? parseNumberFromPercent(disabilityEl.value : '0%') : 0;
        
        const allIncapacityFields = [incapacityEl].filter(el => el);
        const allDisabilityFields = [disabilityEl].filter(el => el);

        allIncapacityFields.forEach(el => el.classList.remove('incapacity-highlight', 'incapacity-border-med', 'incapacity-border-bold'));
        allDisabilityFields.forEach(el => el.classList.remove('incapacity-highlight'));
        
        if (incapVal > 0) {
            allIncapacityFields.forEach(el => el.classList.add('incapacity-highlight'));
            
            if (incapVal === 100) {
                allIncapacityFields.forEach(el => el.classList.add('incapacity-border-bold'));
                window.__incapacityFullOnly = true; // ×“×’×œ ×œ×¦×• ××¤×¡
            } else if (incapVal >= 75) {
                allIncapacityFields.forEach(el => el.classList.add('incapacity-border-med'));
                window.__incapacityFullOnly = false;
            }
        } else {
            window.__incapacityFullOnly = false;
        }
        
        if (disVal > 0) {
             allDisabilityFields.forEach(el => el.classList.add('incapacity-highlight'));
        }
        
        // ×˜×¨×™×’×¨ ×œ×¡× ×›×¨×•×Ÿ ×”×—×™×©×•×‘
        syncCalculatorFromForm();
    }

    function setupInputDisabling() {
        const debtorChk = document.getElementById('debtorNotWorking');
        const debtorIncomeInput = document.getElementById('debtorNetIncome');
        if (debtorChk && debtorIncomeInput) {
            function updateDebtorState() {
                debtorIncomeInput.disabled = debtorChk.checked;
                if (debtorChk.checked) {
                    if(debtorIncomeInput.value !== '0') { debtorIncomeInput.value = '0'; }
                    debtorIncomeInput.dispatchEvent(new Event('input')); 
                }
            }
            debtorChk.addEventListener('change', updateDebtorState);
            updateDebtorState(); 
        }

        const alimonyChk = document.getElementById('hasAlimony');
        const alimonyAmountInput = document.getElementById('alimonyAmount');
        if (alimonyChk && alimonyAmountInput) {
            function updateAlimonyState() {
                alimonyAmountInput.disabled = !alimonyChk.checked;
                if (!alimonyChk.checked) {
                    alimonyAmountInput.value = '';
                    alimonyAmountInput.dispatchEvent(new Event('input')); 
                }
            }
            alimonyChk.addEventListener('change', updateAlimonyState);
            updateAlimonyState(); 
        }
    }


    function attachCurrencyFormatting() {
      const inputs = document.querySelectorAll(".currency-input");
      inputs.forEach(input => {
        if (input.__currencyAttached) return;
        input.__currencyAttached = true;
        
        input.addEventListener("focus", () => {
          const raw = input.value.replace(/[^\d.]/g, "");
          input.value = raw;
        });
        input.addEventListener("blur", () => {
          let v = input.value.replace(/[^\d.]/g, "");
          if (!v) {
            input.value = "";
            return;
          }
          const num = parseFloat(v.replace(/,/g, ""));
          if (!isNaN(num)) {
            input.value = num.toLocaleString("he-IL", {
              minimumFractionDigits: 0,
              maximumFractionDigits: 2
            }) + " â‚ª";
          }
        });
      });
    }

    function sendEmail() {
      const subject = encodeURIComponent('×“×•"×— ××¡×›× ×œ×“×™×•×Ÿ ×¦×• ×©×™×§×•×');
      const body = encodeURIComponent(
        '××¦×•×¨×£ ×“×•"×— ×¡×™×›×•× ×œ×“×™×•×Ÿ ×¦×• ×©×™×§×•× ×›×œ×›×œ×™.\n\n' +
        '(×œ×™×¦×™×¨×ª PDF â€“ ×”×©×ª××©/×™ ×‘×›×¤×ª×•×¨ ×”×“×¤×¡×” ×•×©××•×¨/×™ ×›-PDF.)'
      );
      window.location.href = 'mailto:?subject=' + subject + '&body=' + body;
    }
    
    // (×©××¨ ×§×•×“ ×”-JS × ×©××¨)

    document.addEventListener("DOMContentLoaded", () => {
      attachCurrencyFormatting();
      setupPercentField('disabilityPercent');
      setupPercentField('incapacityPercent');
      setupNotWorkingToggle('debtorNotWorking', 'debtorIncomeRow');
      setupNotWorkingToggle('spouseNotWorking', 'spouseIncomeRow');
      setupInputDisabling(); 
      setupReportsStatusColors();
      setupScrollTopButton();
      initCalculatorSync();
      updateFlow(); 
      updateIncapacityVisualAndCalcFlags(); 
      
      // ×—×™×‘×•×¨ ×”××™×¨×•×¢×™×
      document.getElementById('reportForm').addEventListener('input', (e) => {
        if (e.target && e.target.id === 'arrearsAmount') updateArrearsHighlight();
        if (e.target && (e.target.id === 'hasAlimony' || e.target.id === 'alimonyAmount')) updateAlimonyHighlight();
        
        if (e.target && e.target.closest('.layout-main')) syncCalculatorFromForm();
        if (e.target && e.target.closest('.recom-grid')) updateRecommendationTotals();
        if (e.target && e.target.closest('.order-box')) calculatePaymentsTotals();

        saveFormState();
      });

      document.getElementById('reportForm').addEventListener('change', (e) => {
        if (e.target && (e.target.id === 'hasAlimony' || e.target.id === 'alimonyAmount')) updateAlimonyHighlight();
        if (e.target && e.target.id === 'arrearsAmount') updateArrearsHighlight();
        
        if (e.target && e.target.closest('.layout-main')) syncCalculatorFromForm();
        if (e.target && e.target.closest('.recom-grid')) updateRecommendationTotals();
        if (e.target && e.target.closest('.order-box')) calculatePaymentsTotals();

        saveFormState();
      });

      updateArrearsHighlight();
      updateAlimonyHighlight();
      calculatePaymentsTotals();
    });
  </script>
</body>
</html>
