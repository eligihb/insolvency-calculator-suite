<!doctype html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>מחלץ דוחות — דוח ממצאי בדיקה (עם OCR)</title>
  <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@400;600&display=swap" rel="stylesheet">
  <style>
    :root{--bg:#0b1220;--panel:#111a2b;--muted:#a7b5c8;--line:#1e2b45;--accent:#4cc9f0}
    *{box-sizing:border-box}
    body{background:var(--bg);color:#e6eef6;font-family:Heebo,Arial;margin:0}
    .wrap{max-width:1100px;margin:0 auto;padding:22px}
    h1{margin:0 0 14px;font-size:clamp(20px,3vw,28px)}
    .card{background:var(--panel);border:1px solid var(--line);border-radius:14px;padding:16px;margin-bottom:16px}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .btn{background:#133159;border:1px solid #22406b;color:#fff;border-radius:10px;padding:10px 14px;cursor:pointer}
    .btn.secondary{background:#102138}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    input[type="text"],textarea{width:100%;background:#0e1a2f;border:1px solid #213053;border-radius:10px;color:#e6eef6;padding:10px 12px}
    label{font-size:13px;color:var(--muted);margin:6px 0 4px;display:block}
    .muted{color:var(--muted);font-size:13px}
    .tbl{width:100%;border-collapse:separate;border-spacing:0 6px}
    .tbl th{font-weight:600;color:#b8c4d4;text-align:right;font-size:13px}
    .tbl td,.tbl th{padding:10px 12px;background:#0d172a;border-top:1px solid #20304f;border-bottom:1px solid #20304f}
    .tbl tr td:first-child,.tbl tr th:first-child{border-right:1px solid #20304f;border-top-right-radius:12px;border-bottom-right-radius:12px}
    .tbl tr td:last-child,.tbl tr th:last-child{border-left:1px solid #20304f;border-top-left-radius:12px;border-bottom-left-radius:12px}
    .code{white-space:pre-wrap;background:#0d172a;border:1px dashed #20304f;padding:12px;border-radius:12px}
    footer{opacity:.8;margin-top:10px;font-size:12px}
    .loading{position:fixed;inset:0;background:rgba(0,0,0,.55);display:flex;align-items:center;justify-content:center;z-index:9999}
    .loading .box{background:#0e1a2f;border:1px solid #213053;padding:18px 22px;border-radius:14px;font-weight:600}
    .hidden{display:none}
  </style>

  <!-- ספריות -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
</head>
<body>
  <div class="wrap">
    <h1>דוח ממצאי בדיקה</h1>
    <div class="card">
      <div class="row">
        <input id="file" type="file" accept="application/pdf" class="btn" />
        <button class="btn" id="btnProcess">עבד דוח</button>
        <button class="btn secondary" id="btnReset">אתחל</button>
        <span class="muted">פרטיות מלאה: הכל מעובד במחשב שלך.</span>
      </div>
    </div>

    <section class="card">
      <h3>תוצאה — שדות ותקציר</h3>
      <div class="row">
        <button class="btn" id="btnEdit">מצב עריכה: פועל</button>
        <button class="btn secondary" id="btnSelectAll">סמן הכל</button>
        <button class="btn secondary" id="btnSelectNone">נקה סימון</button>
      </div>
      <table class="tbl" id="fieldsTable"></table>
      <h4>סיכום תמציתי</h4>
      <div class="code" id="summaryBox">—</div>
      <h4>המלצות (מזוהות)</h4>
      <div class="code" id="recoBox">—</div>
      <div class="row">
        <button class="btn" id="btnCSV">הורד CSV</button>
        <button class="btn" id="btnXLSX">הורד Excel</button>
        <button class="btn" id="btnJSON">הורד JSON</button>
        <button class="btn" id="btnPDF">הורד PDF</button>
        <a class="btn secondary" id="btnMail" href="#">פתח מייל חדש</a>
      </div>
      <footer class="muted">הופק על ידי אליאב יחיאל</footer>
    </section>

    <div id="loading" class="loading hidden"><div class="box">מעבד דוח…</div></div>
    <canvas id="ocrCanvas" class="hidden"></canvas>
  </div>

  <script>
    if (window.pdfjsLib) {
      pdfjsLib.GlobalWorkerOptions.workerSrc = "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";
    }

    const $ = (s)=>document.querySelector(s);
    const tbl = $('#fieldsTable');
    let pdfBytes=null, rec=null;

    async function readPDF(buf){
      const pdf = await pdfjsLib.getDocument({data: buf}).promise;
      let texts=[];
      for(let p=1;p<=pdf.numPages;p++){
        const page=await pdf.getPage(p);
        const content=await page.getTextContent();
        texts.push(content.items.map(i=>i.str).join(' '));
      }
      const plain=texts.join('\\n');
      if(!/[A-Za-zא-ת]/.test(plain)){ return await readPDF_OCR(pdf); }
      return plain;
    }

    async function readPDF_OCR(pdf){
      const canvas=$('#ocrCanvas'); const ctx=canvas.getContext('2d'); const out=[];
      for(let p=1;p<=pdf.numPages;p++){
        const page=await pdf.getPage(p); const viewport=page.getViewport({scale:2});
        canvas.width=viewport.width; canvas.height=viewport.height;
        await page.render({canvasContext:ctx,viewport}).promise;
        const box=$('#loading .box'); box.textContent=`מזהה טקסט (OCR)… עמוד ${p}/${pdf.numPages}`;
        const result=await Tesseract.recognize(canvas,'heb+eng',{logger:m=>{
          if(m.status){ box.textContent=`OCR ${p}/${pdf.numPages}: ${m.status} ${(m.progress*100|0)}%`; }
        }});
        out.push(result.data.text||'');
      }
      return out.join('\\n');
    }

    async function process(){
      if(!pdfBytes){ alert('בחר קובץ PDF'); return; }
      const loader=$('#loading'); loader.classList.remove('hidden');
      try{
        const text=await readPDF(pdfBytes);
        if(!text.trim()){ alert('לא זוהה טקסט'); loader.classList.add('hidden'); return; }
        $('#summaryBox').textContent=text.slice(0,1000)+'...'; // הדגמה
        $('#recoBox').textContent='זוהה טקסט באורך '+text.length+' תווים.';
      }catch(e){ alert('שגיאה: '+e.message); }
      loader.classList.add('hidden');
    }

    $('#file').addEventListener('change',async e=>{
      const f=e.target.files[0]; if(!f)return;
      pdfBytes=await f.arrayBuffer();
    });
    $('#btnProcess').addEventListener('click',process);
  </script>
</body>
</html>
