<!doctype html>
<html lang="he" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>מחלץ דוחות (פרטי) – PDF/תמונה → שדות</title>

<!-- PDF.js -->
<!-- PDF.js (גרסה יציבה ל-web) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
<script>
  pdfjsLib.GlobalWorkerOptions.workerSrc = "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js";
</script>

<style>
  :root{
    --bg:#f6f7fb; --card:#fff; --ink:#111; --muted:#6b7280; --accent:#0d6efd;
    --ok:#16a34a; --err:#dc2626; --warn:#d97706; --radius:14px;
  }
  body{margin:0;background:var(--bg);color:var(--ink);font-family:Heebo,system-ui,-apple-system,Segoe UI,Roboto,Arial;}
  .wrap{max-width:1120px;margin:28px auto;padding:0 16px;display:grid;grid-template-columns:1.1fr .9fr;gap:18px}
  @media (max-width:980px){.wrap{grid-template-columns:1fr}}
  .card{background:var(--card);border-radius:var(--radius);box-shadow:0 10px 30px rgba(0,0,0,.08);padding:18px 18px 20px}
  h1,h2,h3{margin:0 0 10px}
  .filebox{border:2px dashed #d1d5db;border-radius:14px;padding:18px;text-align:center;background:#fcfcfe;cursor:pointer}
  .filebox input{display:none}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .pill{display:inline-flex;gap:8px;align-items:center;border-radius:999px;padding:6px 10px;font-size:.85rem;background:#eef2ff}
  .pill.ok{background:#ecfdf5;color:#065f46}
  .pill.err{background:#fef2f2;color:#991b1b}
  .pill.warn{background:#fffbeb;color:#92400e}
  .muted{color:var(--muted);font-size:.85rem}
  .btn{background:var(--accent);color:#fff;border:none;border-radius:10px;padding:9px 14px;font-weight:600;cursor:pointer}
  .btn.secondary{background:#e5e7eb;color:#000}
  .progress{height:10px;background:#e5e7eb;border-radius:999px;overflow:hidden}
  .bar{height:100%;width:0%;background:var(--accent);transition:width .2s}
  .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
  .preview{background:#0f172a;color:#e2e8f0;border-radius:10px;padding:10px;font-size:.8rem;max-height:240px;overflow:auto;white-space:pre-wrap}
  .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:12px}
  .field{border:1px solid #e5e7eb;border-radius:10px;padding:10px}
  .field b{display:block;margin-bottom:4px}
  .statusline{margin-top:6px;font-size:.85rem}
  .statusline.ok{color:var(--ok)} .statusline.err{color:var(--err)} .statusline.warn{color:var(--warn)}
  .section-title{margin-top:16px;margin-bottom:8px;border-bottom:1px solid #e5e7eb;padding-bottom:6px}
  .small{font-size:.8rem}
</style>
</head>
<body>
  <div class="wrap">
    <!-- צד שמאל: העלאה, התקדמות, טקסט גולמי -->
    <div class="card">
      <h2>1) העלאת קובץ ובדיקת טעינה</h2>
      <div id="filebox" class="filebox">
        <p><b>לחץ לבחירת קובץ</b> או גרור לכאן</p>
        <p class="muted">נתמך: PDF (טקסטואלי/סרוק), תמונות (JPG/PNG/TIFF) – הכל מעובד מקומית בלבד.</p>
        <input type="file" id="infile" accept=".pdf,.png,.jpg,.jpeg,.tif,.tiff,image/*,application/pdf" />
      </div>

      <div style="margin:14px 0 10px" class="row">
        <button class="btn" id="btnProcess">חלץ נתונים</button>
        <button class="btn secondary" id="btnClear">נקה</button>
        <span id="filename" class="pill muted">לא נבחר קובץ</span>
        <span id="fileok" class="pill" style="display:none"></span>
      </div>

      <div class="progress" title="התקדמות"><div id="bar" class="bar"></div></div>
      <div id="status" class="statusline muted">מוכן.</div>

      <div class="row" style="margin-top:10px">
        <div class="pill" id="pageCountPill" style="display:none;"></div>
      </div>

      <h3 class="section-title">טקסט שחולץ (תצוגה)</h3>
      <div id="raw" class="preview mono" dir="ltr"></div>
    </div>

    <!-- צד ימין: תוצאות לפי נושאים -->
    <div class="card" id="resultsCard">
      <h2>2) שדות מחולצים לפי נושא</h2>
      <div id="sections"></div>

      <h3 class="section-title">JSON</h3>
      <div id="jsonOut" class="preview mono">{}</div>
      <div class="row" style="margin-top:10px">
        <button class="btn" id="btnCopy">העתק JSON</button>
        <button class="btn secondary" id="btnDownload">הורד JSON</button>
      </div>
    </div>
  </div>

<script>
/* ===================== פרטיות =====================
   כל העיבוד נעשה בדפדפן. לא נשלח אף קובץ לשום שרת.
   ספריות נטענות כקוד בלבד; הנתונים נשארים מקומית.
====================================================*/

/* ===================== סכמת שדות =====================
   מבוסס על האפיון המשותף. אפשר לעדכן/להסיר/להוסיף.
   regex מבוצע כברירת מחדל עם דגלים 'mi' (רב-שורה, case-insensitive).
======================================================*/

const FIELD_SCHEMA = [
  // ---- פרטי תיק ----
  {section:"case", groupLabel:"פרטי תיק", fields:[
    {key:"court_name", label:"בית משפט", scope:"header", regex:"בית\\s+משפט\\s+([^\\n]+)", required:true},
    {key:"insolvency_case_no", label:"מס’ הליך (בימ\"ש)", scope:"header", regex:"(?:חדל[״\"']?פ|מס'?\\s*תיק.*בית\\s*משפט)[:\\s]+([0-9\\-\\/]+)", required:true},
    {key:"commissioner_file_no", label:"מס’ תיק בממונה", scope:"a1", regex:"תיק\\s+ממונה[:\\s]+([0-9]+)", required:true},
    {key:"hearing_datetime", label:"מועד דיון", scope:"header", regex:"קבוע\\s+לדיון[:\\s]+(\\d{1,2}[\\/\\.\\-]\\d{1,2}[\\/\\.\\-]\\d{2,4}\\s+\\d{1,2}:\\d{2})", required:false}
  ]},

  // ---- פרטים אישיים ----
  {section:"debtor", groupLabel:"פרטים אישיים", fields:[
    {key:"debtor_name", label:"שם החייב/ת", scope:"a1", regex:"שם\\s+החייב(?:\\/ת)?[:\\s]+([^\\n]+)", required:true},
    {key:"id_number", label:"מספר זיהוי", scope:"a1", regex:"(?:מספר\\s+זיהוי|ת\\.?ז)[:\\s]+(\\d{5,10})", required:true}
  ]},

  // ---- החלטות ותשלומים (א.1) ----
  {section:"orders_and_payments", groupLabel:"החלטות ותשלומים (א.1)", fields:[
    {key:"opening_order_date", label:"תאריך צו פתיחת הליכים", scope:"a1", regex:"ביום\\s+(\\d{1,2}[\\/\\.\\-]\\d{1,2}[\\/\\.\\-]\\d{2,4})\\s+ניתן\\s+צו\\s+לפתיחת\\s+הליכים", required:true, normalize:"date"},
    {key:"monthly_payment_amount", label:"תשלום חודשי (סכום)", scope:"a1", regex:"תשלום\\s+חודשי.*?בסך[:\\s]+([\\d\\.,]+)", required:true, normalize:"money"},
    {key:"monthly_payment_from_date", label:"תשלום חודשי – החל מ", scope:"a1", regex:"החל\\s+מ(?:יום|תאריך)?[:\\s]+(\\d{1,2}[\\/\\.\\-]\\d{1,2}[\\/\\.\\-]\\d{2,4})", required:true, normalize:"date"},
    {key:"arrears_amount", label:"סכום פיגורים", scope:"a1_or_d", regex:"פיגורים\\s+בסך\\s+של?\\s*([\\d\\.,]+)", required:false, normalize:"money"},
    {key:"arrears_count", label:"מס’ פיגורים", scope:"d", regex:"צבר\\s+(\\d+)\\s+פיגורים", required:false, normalize:"int"},
    {key:"last_payment_date", label:"תשלום אחרון בוצע ליום", scope:"a1_or_d", regex:"תשלום\\s+אחרון\\s+בוצע\\s+ליום\\s+(\\d{1,2}[\\/\\.\\-]\\d{1,2}[\\/\\.\\-]\\d{2,4})", required:false, normalize:"date"},
    {key:"estate_cash_balance", label:"יתרה בקופת הנשייה", scope:"a1", regex:"הצטבר\\s+בקופת\\s+הנשייה\\s+סך\\s+של\\s+כ?\\s*([\\d\\.,]+)", required:false, normalize:"money"}
  ]},

  // ---- חובות ותביעות חוב (ה) ----
  {section:"debts_and_claims", groupLabel:"חובות ותביעות חוב (ה)", fields:[
    {key:"declared_debt_total", label:"חובות מוצהרים", scope:"e", regex:"חובותיו\\s+נאמדים\\s+בסך\\s+של?\\s*([\\d\\.,]+)", required:false, normalize:"money"},
    {key:"claims_filed_count", label:"מס' תביעות שהוגשו", scope:"e", regex:"הוגשו\\s+(\\d+)\\s+תביעות\\s+חוב", required:false, normalize:"int"},
    {key:"claims_filed_total", label:"סך תביעות שהוגשו", scope:"e", regex:"בסך\\s+כולל\\s+של?\\s*([\\d\\.,]+)\\s*₪", required:false, normalize:"money"},
    {key:"claims_approved_total", label:"סך שאושר", scope:"e", regex:"אישר(?:\\s+\\d+\\s+תביעות\\s+חוב)?\\s+בסך\\s+([\\d\\.,]+)", required:false, normalize:"money"}
  ]},

  // ---- נכסים (ו) ----
  {section:"assets", groupLabel:"נכסים (ו)", fields:[
    {key:"assets_total_to_realize", label:"שווי סך הנכסים למימוש", scope:"f", regex:"שווי\\s+סך\\s+הנכסים\\s+למימוש\\s+הינו\\s+([\\d\\.,]+)", required:false, normalize:"money"}
  ]},

  // ---- פרק ז' – מסקנות הנאמן ----
  {section:"chapter_g_trustee", groupLabel:"פרק ז’ – מסקנות הנאמן", fields:[
    {key:"trustee_recommendation", label:"המלצת הנאמן (enum)", scope:"g", regex:"ביטול\\s+הצו|הפטר\\s+לאלתר", required:true, normalize:"recommendation"},
    {key:"trustee_reasons_text", label:"נימוקים עיקריים (טקסט)", scope:"g", regex:"(חוסר\\s+תום\\-לב|פיגורים|אי\\-הגשת\\s+דוחות|אי\\-המצאת\\s+מסמכים|סתירות)", required:false, normalize:"reasonsCollect"},
    {key:"trustee_summary_ch7", label:"סיכום פרק ז' (תמציתי)", scope:"g", regex:".*", required:true, synthesize:"summaryG"}
  ]},

  // ---- נתוני מסמך ----
  {section:"document_meta", groupLabel:"נתוני מסמך", fields:[
    {key:"report_date", label:"תאריך הדוח", scope:"any", regex:"תאריך\\s+(\\d{1,2}[\\/\\.\\-]\\d{1,2}[\\/\\.\\-]\\d{2,4})", required:false, normalize:"date"},
    {key:"pages_count", label:"מס’ עמודים (PDF)", scope:"meta", regex:"", required:false}
  ]}
];

// קבוצות להצגה מסודרת
const GROUP_ORDER = ["case","debtor","orders_and_payments","debts_and_claims","assets","chapter_g_trustee","document_meta"];

/* ===================== אלמנטים ===================== */
const infile = document.getElementById('infile');
const filebox = document.getElementById('filebox');
const btnProcess = document.getElementById('btnProcess');
const btnClear = document.getElementById('btnClear');
const statusEl = document.getElementById('status');
const bar = document.getElementById('bar');
const filenameEl = document.getElementById('filename');
const fileokEl = document.getElementById('fileok');
const pageCountPill = document.getElementById('pageCountPill');
const rawEl = document.getElementById('raw');
const sectionsEl = document.getElementById('sections');
const jsonOut = document.getElementById('jsonOut');
const btnCopy = document.getElementById('btnCopy');
const btnDownload = document.getElementById('btnDownload');

/* ===================== עזר ===================== */
const setStatus = (txt, cls) => {
  statusEl.textContent = txt;
  statusEl.className = 'statusline ' + (cls||'');
};
const setProgress = (pct) => { bar.style.width = Math.max(0, Math.min(100, pct)) + '%'; };
const human = n => (n==null?'-':n);
const cleanSpaces = s => (s||'').replace(/\u200f|\u200e/g,'').replace(/\s+/g,' ').trim();
const normMoney = s => {
  if(!s) return null;
  let t = (''+s).replace(/[^\d.,]/g,'').replace(/\./g,'').replace(/,/g,'.');
  const v = parseFloat(t);
  return isNaN(v)?null:+v.toFixed(2);
};
const normInt = s => { const n = parseInt((''+s).replace(/[^\d]/g,''),10); return isNaN(n)?null:n; };
const normDate = s => {
  if(!s) return '';
  const m = (''+s).match(/(\d{1,2})[\/\.\-](\d{1,2})[\/\.\-](\d{2,4})/);
  if(!m) return cleanSpaces(s);
  let [_,d,mo,y]=m; if(y.length===2) y='20'+y;
  const dd=String(d).padStart(2,'0'), mm=String(mo).padStart(2,'0');
  return `${y}-${mm}-${dd}`;
};
// enum המלצת נאמן
const normRecommendation = (txt) => {
  if(!txt) return '';
  if(/ביטול\s+הצו/.test(txt)) return 'cancel_opening_order';
  if(/הפטר\s+לאלתר/.test(txt)) return 'grant_discharge_immediately';
  return 'other';
};
// איסוף נימוקים מפרק ז'
const collectReasons = (gText) => {
  if(!gText) return '';
  const keys = ["חוסר תום-לב","פיגורים","אי-הגשת דוחות","אי-המצאת מסמכים","סתירות"];
  const got = keys.filter(k => gText.includes(k));
  return got.join(', ');
};

// חלוקת טקסט לפרקי חיפוש בסיסיים
function sliceScopes(fullText){
  const t = fullText;
  // נזהה קטעי "פרק" בסיסיים; ניתן לשפר לפי המסמכים שלך
  const idx = (label) => {
    const r = new RegExp(label.replace(/\./g,'\\.').replace(/\s/g,'\\s*'),'m');
    const m = r.exec(t);
    return m?m.index:-1;
  };
  const iA = idx('פרק\\s*A\\.?\\s*1') >=0 ? idx('פרק\\s*A\\.?\\s*1') : idx('א\\.\\s*1|א\\.?\\s*1');
  const iB = idx('פרק\\s*ב')>=0?idx('פרק\\s*ב'): -1;
  const iD = idx('פרק\\s*ד')>=0?idx('פרק\\s*ד'): -1;
  const iE = idx('פרק\\s*ה')>=0?idx('פרק\\s*ה'): -1;
  const iF = idx('פרק\\s*ו')>=0?idx('פרק\\s*ו'): -1;
  const iG = idx('פרק\\s*ז')>=0?idx('פרק\\s*ז'): -1;

  const scope = {};
  scope.header = t.slice(0, Math.max(0, iA, iB, iD, iE, iF, iG).filter?0:0); // פותח – אם אין, ישאר ריק
  scope.a1 = iA>=0 ? t.slice(iA, (iB>iA?iB: (iD>iA?iD:(iE>iA?iE:(iF>iA?iF:(iG>iA?iG:t.length)))))) : '';
  scope.d = iD>=0 ? t.slice(iD, (iE>iD?iE:(iF>iD?iF:(iG>iD?iG:t.length)))) : '';
  scope.e = iE>=0 ? t.slice(iE, (iF>iE?iF:(iG>iE?iG:t.length))) : '';
  scope.f = iF>=0 ? t.slice(iF, (iG>iF?iG:t.length)) : '';
  scope.g = iG>=0 ? t.slice(iG) : '';
  scope.a1_or_d = cleanSpaces(scope.a1 + ' ' + scope.d);
  scope.any = t;
  return scope;
}

// חילוץ לפי סכימה
function extractBySchema(fullText, pagesCount){
  const scopes = sliceScopes(fullText);
  const out = {
    case:{}, debtor:{}, orders_and_payments:{}, debts_and_claims:{}, assets:{},
    chapter_g_trustee:{}, document_meta:{ pages_count: pagesCount ?? null }
  };
  const foundFlags = {};

  for(const group of FIELD_SCHEMA){
    for(const f of group.fields){
      let val = '';
      if(f.key === 'pages_count'){ // ממלאים ממטא
        val = pagesCount ?? null;
        out[group.section][f.key] = val;
        continue;
      }
      // טקסט יעד לפי scope
      let pool = scopes[f.scope] || '';
      if(!pool && f.scope==='header'){ pool = scopes.any.slice(0, 2000); } // גרייס ל-header
      const re = f.regex ? new RegExp(f.regex, 'mi') : null;
      if(re){
        const m = pool.match(re);
        if(m && m[1]) val = cleanSpaces(m[1]);
        else if(m && !m[1]) val = cleanSpaces(m[0]); // fallback אם אין קבוצה
      }
      // נרמול
      if(val){
        if(f.normalize === 'money') val = normMoney(val);
        if(f.normalize === 'int') val = normInt(val);
        if(f.normalize === 'date') val = normDate(val);
        if(f.normalize === 'recommendation') val = normRecommendation(val);
        if(f.normalize === 'reasonsCollect') val = collectReasons(scopes.g);
      }
      // סינתזה (לדוגמה: סיכום פרק ז')
      if(f.synthesize === 'summaryG'){
        // נוסח תמציתי קבוע כפי שסיכמנו אם ההמלצה היא ביטול:
        const rec = normRecommendation(scopes.g);
        if(rec === 'cancel_opening_order'){
          val = "הנאמן מציין חוסר תום-לב מתמשך, מחדלי דיווח ותשלומים, ואי-המצאת מסמכים; לפיכך ממליץ לבטל את הצו לפתיחת ההליכים ולא להעניק הפטר.";
        }else if(rec === 'grant_discharge_immediately'){
          val = "הנאמן ממליץ על הפטר לאלתר.";
        }else{
          val = "סיכום הנאמן לא זוהה חד-משמעית מהטקסט.";
        }
      }

      out[group.section][f.key] = (val===undefined? '': val);
      foundFlags[f.key] = !!val;
    }
  }
  return {out, foundFlags};
}

// UI – בניית תצוגה לפי קבוצות
function renderResults(struct, found){
  sectionsEl.innerHTML = '';
  for(const groupKey of GROUP_ORDER){
    const group = FIELD_SCHEMA.find(g => g.section===groupKey);
    if(!group) continue;
    const groupDiv = document.createElement('div');
    groupDiv.innerHTML = `<h3 class="section-title">${group.groupLabel}</h3>`;
    const grid = document.createElement('div'); grid.className='grid';
    for(const f of group.fields){
      const v = struct[groupKey][f.key];
      const ok = (v!=='' && v!==null && v!==undefined);
      const card = document.createElement('div'); card.className='field';
      card.innerHTML = `
        <b>${f.label}</b>
        <div>${ok ? `<span class="pill ok">נמצא</span>` : `<span class="pill">לא נמצא</span>`}</div>
        <div class="small mono" style="margin-top:6px;word-break:break-word;" dir="ltr">${ok ? v : '—'}</div>
      `;
      grid.appendChild(card);
    }
    groupDiv.appendChild(grid);
    sectionsEl.appendChild(groupDiv);
  }
  jsonOut.textContent = JSON.stringify(struct, null, 2);
}

/* ===================== קריאת קובץ & חילוץ ===================== */
let fileObj = null;
filenameEl.textContent = 'לא נבחר קובץ';

filebox.addEventListener('click', ()=> infile.click());
filebox.addEventListener('dragover', (e)=>{e.preventDefault(); filebox.style.background='#eef6ff';});
filebox.addEventListener('dragleave', ()=>{filebox.style.background='#fcfcfe';});
filebox.addEventListener('drop', (e)=>{
  e.preventDefault(); filebox.style.background='#fcfcfe';
  if(e.dataTransfer.files?.length){ infile.files = e.dataTransfer.files; handleFilePick(); }
});
infile.addEventListener('change', handleFilePick);

function handleFilePick(){
  fileObj = infile.files && infile.files[0] ? infile.files[0] : null;
  if(!fileObj){
    filenameEl.textContent = 'לא נבחר קובץ'; fileokEl.style.display='none';
    return;
  }
  filenameEl.textContent = fileObj.name;
  fileokEl.style.display='inline-flex';
  fileokEl.className='pill ok';
  fileokEl.textContent='הקובץ נטען (מוכן לעיבוד)';
  setStatus('קובץ נבחר. לחץ "חלץ נתונים".','ok');
  pageCountPill.style.display='none';
}

btnClear.addEventListener('click', ()=>{
  infile.value = '';
  fileObj = null;
  filenameEl.textContent='לא נבחר קובץ';
  fileokEl.style.display='none';
  rawEl.textContent='';
  sectionsEl.innerHTML='';
  jsonOut.textContent='{}';
  setProgress(0);
  setStatus('נוקה.','');
  pageCountPill.style.display='none';
});

btnProcess.addEventListener('click', async ()=>{
  if(!fileObj){ setStatus('לא נבחר קובץ.', 'err'); return; }
  try{
    setProgress(2);
    setStatus('טוען קובץ…', '');
    fileokEl.style.display='inline-flex'; fileokEl.className='pill'; fileokEl.textContent='טוען…';

    const ext = (fileObj.name.split('.').pop()||'').toLowerCase();
    const isPDF = fileObj.type==='application/pdf' || ext==='pdf';
    const isImage = /^image\//.test(fileObj.type) || ['jpg','jpeg','png','tif','tiff'].includes(ext);

    let pagesCount = 1;
    let fullText = '';

    if(isPDF){
      const ab = await fileObj.arrayBuffer();
      const pdf = await pdfjsLib.getDocument({data:ab}).promise;
      pagesCount = pdf.numPages;
      pageCountPill.style.display='inline-flex';
      pageCountPill.className='pill'; pageCountPill.textContent = `עמודים: ${pagesCount}`;
      setStatus(`קורא PDF טקסטואלי… (0/${pagesCount})`, '');

      // נסיון ראשון: טקסט מובנה
      let textBuilt = '';
      for(let i=1;i<=pdf.numPages;i++){
        const page = await pdf.getPage(i);
        const content = await page.getTextContent();
        const strings = content.items.map(it=>it.str);
        textBuilt += strings.join(' ') + '\n';
        setProgress( Math.round((i/pdf.numPages)*50) );
        setStatus(`קורא PDF טקסטואלי… (${i}/${pagesCount})`, '');
      }
      const textLen = textBuilt.replace(/\s/g,'').length;
      if(textLen>100){ // מספיק טקסט → נשתמש
        fullText = textBuilt;
        setStatus('טקסט PDF נטען בהצלחה.', 'ok');
        setProgress(60);
      } else {
        // פולבק: OCR לכל עמוד
        setStatus('לא זוהה טקסט מובנה. מתחיל OCR (פועל מקומית)…', 'warn');
        const scale = 1.8;
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');

        for(let i=1;i<=pdf.numPages;i++){
          const page = await pdf.getPage(i);
          const viewport = page.getViewport({scale});
          canvas.width = viewport.width; canvas.height = viewport.height;
          await page.render({canvasContext:ctx, viewport}).promise;

          const { data: { text } } = await Tesseract.recognize(canvas, 'heb+eng', {
            logger: m => {
              if(m.status==='recognizing text' && m.progress!=null){
                setStatus(`OCR עמוד ${i}/${pagesCount}… ${Math.round(m.progress*100)}%`, 'warn');
              }
            }
          });
          fullText += text + '\n';
          setProgress(60 + Math.round((i/pdf.numPages)*40));
        }
        setStatus('OCR הושלם.', 'ok');
      }
    } else if(isImage){
      // תמונה בודדת = עמוד אחד
      pagesCount = 1;
      pageCountPill.style.display='inline-flex';
      pageCountPill.className='pill'; pageCountPill.textContent = `עמודים: ${pagesCount}`;
      setStatus('OCR על תמונה (מקומי)…','');
      const img = await fileToImage(fileObj);
      const canvas = document.createElement('canvas');
      const ctx = canvas.getContext('2d');
      const scale = fitScale(img.width, img.height, 2000);
      canvas.width = Math.round(img.width*scale);
      canvas.height = Math.round(img.height*scale);
      ctx.drawImage(img,0,0,canvas.width,canvas.height);

      const { data: { text } } = await Tesseract.recognize(canvas, 'heb+eng', {
        logger: m => {
          if(m.status==='recognizing text' && m.progress!=null){
            setStatus(`OCR… ${Math.round(m.progress*100)}%`, '');
            setProgress(Math.round(60 + m.progress*40));
          }
        }
      });
      fullText = text || '';
      setStatus('OCR הושלם.', 'ok');
    } else {
      setStatus('סוג קובץ לא נתמך. יש לבחור PDF או תמונה.', 'err');
      return;
    }

    // תצוגת טקסט
    rawEl.textContent = (fullText || '').trim();
    // חילוץ לפי הסכמה
    const {out, foundFlags} = extractBySchema(fullText, pagesCount);
    renderResults(out, foundFlags);
    setProgress(100);
    fileokEl.className='pill ok'; fileokEl.textContent='נטען בהצלחה';
    setStatus('הסתיים בהצלחה.', 'ok');

  } catch(err){
    console.error(err);
    setStatus('שגיאה: ' + err.message, 'err');
    fileokEl.style.display='inline-flex'; fileokEl.className='pill err'; fileokEl.textContent='שגיאה בטעינה';
    setProgress(0);
  }
});

// עזר: המרת קובץ לתמונה
function fileToImage(file){
  return new Promise((resolve,reject)=>{
    const fr = new FileReader();
    fr.onload = () => {
      const img = new Image();
      img.onload = ()=> resolve(img);
      img.onerror = reject;
      img.src = fr.result;
    };
    fr.onerror = reject;
    fr.readAsDataURL(file);
  });
}
// קנה מידה לתמונה ל-OCR
function fitScale(w,h,maxSide){
  const m = Math.max(w,h);
  return m>maxSide ? maxSide/m : 1.6; // הקטנה/הגדלה קלה לשיפור OCR
}

/* ===================== כלים: העתק/הורדה ===================== */
btnCopy.addEventListener('click', ()=>{
  const txt = jsonOut.textContent || '{}';
  navigator.clipboard.writeText(txt).then(()=>{
    setStatus('JSON הועתק ללוח.', 'ok');
  });
});
btnDownload.addEventListener('click', ()=>{
  const blob = new Blob([jsonOut.textContent || '{}'], {type:'application/json;charset=utf-8'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'extracted.json';
  a.click();
  URL.revokeObjectURL(a.href);
});

</script>
</body>
</html>
