<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>דו"ח מסכם לדיון צו שיקום</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <style>
    /* --- CSS בסיסי --- */
    * { box-sizing: border-box; }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      direction: rtl;
      text-align: right;
      margin: 0;
      background: #e5f6ff;
      font-size: 12px;
      -webkit-font-smoothing: antialiased;
      overflow-y: scroll; /* מאפשר גלילה בדסקטופ */
    }

    .top-bar {
      background: #0f766e;
      color: #fff;
      padding: 10px 18px;
      font-size: 18px;
      font-weight: 700;
      text-align: center;
      position: sticky; 
      top: 0;
      z-index: 100;
    }

    .page {
      max-width: 1100px;
      margin: 8px auto;
      padding: 8px;
    }

    .card {
      background: #f8fafc;
      border-radius: 14px;
      border: 1px solid #dbeafe;
      box-shadow: 0 6px 14px rgba(15, 23, 42, 0.06);
      padding: 8px 10px;
      margin-bottom: 8px; 
      page-break-inside: avoid;
      break-inside: avoid;
    }

    /* --- סגנונות כלליים ורספונסיביות --- */

    .section-title { font-size: 13px; font-weight: 700; color: #0f172a; margin: 0; }
    .sub-title { font-size: 12px; font-weight: 600; color: #0f766e; margin: 4px 0 2px; text-align: right; }
    .row { display: flex; flex-wrap: wrap; align-items: center; gap: 6px; margin-bottom: 4px; }
    label { font-size: 11px; display: inline-flex; align-items: center; gap: 2px; }
    input[type="text"], input[type="number"], input[type="date"], input[type="month"], input[type="time"], textarea, select { font-size: 11px; padding: 3px 5px; border-radius: 8px; border: 1px solid #cbd5f5; background: #ffffff; min-width: 0; font-weight: 600; color: #1d4ed8; }
    textarea { resize: vertical; }

    .short   { width: 80px; }
    .tiny    { width: 50px; }
    .medium  { width: 120px; }
    .xshort  { width: 60px; }
    .flex-1  { flex: 1 1 0; }
    
    hr { border: none; border-top: 1px dashed #e2e8f0; margin: 3px 0; }
    
    /* סגנונות ספציפיים לשדות */
    .status-bad-bold { color: #b91c1c; font-weight: 700; border-color: #b91c1c; }

    /* הבלטות אי כושר */
    .incapacity-highlight { color: #b91c1c !important; font-weight: 700; border-color: #b91c1c; }
    .incapacity-border-med { border: 2px solid #b91c1c !important; }
    .incapacity-border-bold { border: 3px solid #b91c1c !important; }
    
    /* התאמות לעמודת החובות המצומצמת */
    .narrow-col .row input[type="text"], .narrow-col .row input[type="number"] { width: 70px; }
    .recom-grid { 
        display: grid; 
        grid-template-columns: 1fr 1fr 1fr; 
        gap: 4px; 
        margin-bottom: 4px; 
        align-items: end; 
    }
    .recom-item { display: flex; flex-direction: column; justify-content: flex-end; height: 100%; }

    /* פריסת 2 העמודות החדשה והרציפה בדסקטופ */
    @media (min-width: 800px) {
        /* מבנה Grid בדסקטופ */
        .layout-main {
            display: grid;
            grid-template-columns: 1fr 1.6fr; 
            gap: 4px; 
            align-items: flex-start;
            margin-bottom: 8px;
            grid-template-rows: auto auto auto; 
            grid-template-areas: 
                "A1 B2" 
                "B1 A2" 
                "B1 C2"; 
        }

        /* הגדרת Grid Areas - מחשבון למעלה */
        .grid-item-A1 { grid-area: 1 / 1 / 2 / 2; } 
        .grid-item-B2 { grid-area: 1 / 2 / 2 / 3; margin-bottom: 0; } 
        
        .grid-item-A2 { grid-area: 2 / 2 / 3 / 3; margin-bottom: 0; } 
        .grid-item-B1 { grid-area: 2 / 1 / 4 / 2; } 
        .grid-item-C2 { grid-area: 3 / 2 / 4 / 3; } 
        
        /* הסתרת בלוקים שפוצלו רק לצרכי מובייל */
        .mobile-only-step { display: none; }
    }


    /* --- גודל הדפסה A4 (תיקון: הסרת הסקייל ודחיסת פריסה) --- */
    @media print {
      @page { size: A4 portrait; margin: 5mm; }
      body { background: #ffffff; font-size: 11px; }
      .page { transform: none; } /* הסרת הסקייל */
      .mobile-fixed-elements { display: none !important; }
      /* יישור Grid להדפסה - 2 עמודות צפופות */
      .layout-main { 
        display: grid !important; 
        grid-template-columns: 1fr 1.2fr !important; 
        grid-template-rows: auto auto auto !important;
        gap: 3px; 
      }
      .mobile-only-step { display: block !important; }
    }
    
    /* --- ממשק מובייל רב-שלבי (חווית אפליקציה) --- */
    
    @media (max-width: 800px) {
        body { 
            padding-top: 50px; 
            padding-bottom: 70px; 
            /* הסרת גלילה גלובלית ואילוף גובה */
            overflow: hidden; 
            height: 100vh;
        } 
        .page {
            /* מתיחת אזור הטופס לגובה המסך הפנוי */
            min-height: calc(100vh - 50px - 70px - 16px); /* 100vh פחות Top/Bottom Bars וריווח */
            overflow-y: hidden;
            margin-top: 0;
            padding-top: 0;
        }

        /* מיכל המסכים הראשי (Flexbox) */
        #form-flow-container {
            display: flex;
            overflow-x: hidden;
            transition: transform 0.4s ease-in-out;
            width: 600%; /* 6 מסכים * 100% */
            min-height: 100%;
        }
        
        /* כל בלוק ניווט תופס 16.66% מהמיכל (100% מהמסך) */
        #form-flow-container > div {
            flex: 0 0 16.666%; 
            padding: 0 4px;
            overflow-y: auto; /* גלילה פנימית לתוכן אם הוא ארוך */
            max-height: 100%; /* מוגבל לגובה המסך הפנוי */
            display: block !important;
        }
        
        /* הבלוקים הגדולים ב-Grid יופיעו כבלוקים יחידים */
        .layout-main { display: block; }
        
        /* פיצול הבלוקים למובייל */
        .desktop-only-content { display: none; }
        .mobile-only-step { display: block !important; }
    }
    
    /* סגנונות Fixed bars */
    .mobile-fixed-elements { position: fixed; width: 100%; left: 0; z-index: 60; padding: 0 8px; }
    .progress-container { top: 50px; border-radius: 0 0 12px 12px; }
    .mobile-navigation { bottom: 0; border-radius: 12px 12px 0 0; }
  </style>
</head>
<body id="body">
  <div class="top-bar">
    דו"ח מסכם לדיון צו שיקום-206
  </div>
  
  <div class="page">
    <div style="display:flex; flex-direction: column;">
        <div style="display:flex; justify-content: flex-end;">
            <div class="section-title" style="margin-inline-end: auto;">פרטי תיק וצו תשלומים</div>
        </div>
        <div class="buttons-inline">
          <button type="button" class="btn btn-print" onclick="window.print()">🖨 הדפסה / PDF</button>
          <button type="button" class="btn btn-email" onclick="sendEmail()">✉ שליחה במייל</button>
          <button type="button" class="btn btn-reset" onclick="document.getElementById('reportForm').reset()">↺ איפוס</button>
          <button type="button" class="btn btn-restore" onclick="restoreFormState()">🔁 שחזור</button>
        </div>
    </div>
    
    <div class="mobile-fixed-elements progress-container-wrapper">
        <div class="progress-container">
            <span id="current-step-label" class="step-label">1. פרטי תיק</span>
            <div class="progress-bar">
                <div id="progress-fill" class="progress-fill"></div>
            </div>
            <span id="progress-text">1/6</span>
        </div>
    </div>
    
    <form id="reportForm">
      
      <div id="form-flow-container">
      
        <div data-step="1" data-label="פרטי תיק" class="card">
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;align-items:flex-start;">
                <div>
                    <div class="sub-title">פרטי תיק</div>
                    <div class="row">
                        תיק ממונה: <input type="text" class="short" maxlength="5">
                        תיק ביהמ"ש: <input type="text" class="short" placeholder="">
                    </div>
                    <div class="row">
                        שם החייב/ת: <input type="text" class="short">
                        שם הנאמן: <input type="text" class="short">
                    </div>
                    <div class="row">
                        תאריך צו: <input type="date" id="orderDate" class="medium">
                        לבקשת: <label><input type="radio" name="order_by"> חייב</label>
                        <label><input type="radio" name="order_by"> נושה</label>
                    </div>
                    <div class="hearing-box">
                        <div class="row no-wrap">
                            מקום שיפוט: <input type="text" class="tiny">
                            תאריך דיון: <input type="date" class="medium">
                        </div>
                        <div class="row">
                            שעת דיון: <input type="time" class="short" step="300">
                        </div>
                    </div>
                </div>
                <div>
                    <div class="order-box">
                        <div class="sub-title">צו תשלומים</div>
                        <div class="row no-wrap">
                            תשלום חודשי: <input type="text" id="monthlyPayment" class="xshort currency-input" maxlength="6">
                        </div>
                        <div class="row no-wrap">
                            תשלום מדורג: <input type="text" id="gradedPayment" class="xshort currency-input" maxlength="6" placeholder="">
                            מיום: <input type="date" id="gradedFromDate" class="medium">
                        </div>
                        <div class="row">
                            מסירה לנושים: <label><input type="radio" name="notices"> כן</label>
                            <label><input type="radio" name="notices"> לא</label>
                        </div>
                        <hr>
                        <div class="row no-wrap">
                            סה"כ נכון ליום: <input type="text" id="paymentsTotalDate" class="short" readonly>
                        </div>
                        <div class="row">
                            <input type="text" id="paymentsTotalAmount" class="short currency-input" readonly>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div data-step="2" data-label="מצב רפואי ואישי" class="card mobile-only-step">
            <div class="sub-title">פרטים אישיים</div>

            <div class="row" style="flex-wrap:wrap;">
                מצב משפחתי:
                <label><input type="radio" name="family_status" value="רווק"> רווק</label>
                <label><input type="radio" name="family_status" value="נשוי"> נשוי</label>
                <label><input type="radio" name="family_status" value="גרוש"> גרוש</label>
                <label><input type="radio" name="family_status" value="אלמן"> אלמן</label>
            </div>

            <div class="row">
                ילדים קטינים:
                <input type="number" id="minorChildrenCount" class="short" min="0" max="11">
                תשלום מזונות:
                <label><input type="checkbox" id="hasAlimony"> כן</label>
                <input type="text" id="alimonyAmount" class="short currency-input" disabled>
            </div>

            <hr>

            <div class="sub-title">מצב רפואי ואישורי מל"ל</div>

            <div class="row medical-highlight-row">
                נכות:
                <input type="text" class="short percent-field" id="disabilityPercent" maxlength="3" placeholder="0%">
                אי כושר:
                <input type="text" class="short percent-field" id="incapacityPercent" maxlength="3" placeholder="0%">
            </div>

            <div class="row allowances-title-row">
                <span class="allowance-title">קצבאות</span>
            </div>
            <div class="row" style="justify-content:flex-start;flex-wrap:wrap;">
                <label><input type="checkbox"> קצבת ילד נכה</label>
                <label><input type="checkbox"> הבטחת הכנסה</label>
                <label><input type="checkbox"> סיוע שכ"ד</label>
            </div>

            <div class="row medical-notes-row">
                בעיות רפואיות (תמציתי):
                <input type="text" class="flex-1">
            </div>
        </div>

        <div data-step="3" data-label="חובות ונכסים" class="card narrow-col mobile-only-step">
            <div class="section-title" style="border-bottom:1px solid #e2e8f0;padding-bottom:2px;margin-bottom:4px;">
                התנהלות החייב, חובות ונכסים
            </div>
            <div class="sub-title">התנהלות החייב</div>
            <div class="small-text">דו"חות חודשיים:</div>
            <div class="row">
                <label class="reports-status-full"><input type="radio" name="reports_status" value="full"> הוגשו</label>
                <label class="reports-status-partial"><input type="radio" name="reports_status" value="partial"> חלקי</label>
                <label class="reports-status-none"><input type="radio" name="reports_status" value="none"> לא הוגשו</label>
            </div>
            <div class="row">הערות: <input type="text" class="flex-1"></div>
            <div class="sub-title" style="margin-top:4px;">מסמכים ותשלומים</div>
            <div class="row docs-row" style="justify-content: flex-start; gap: 10px;">
                <span class="pair"><span>מסמכים חסרים:</span> <label><input type="radio" name="missing_docs"> כן</label><label><input type="radio" name="missing_docs"> לא</label></span>
                <span class="pair" style="margin-inline-start: 10px;"><span class="arrears-label">סך פיגורים:</span><input type="text" class="short currency-input status-bad-bold"></span>
            </div>
            <hr>
            <div class="sub-title">חובות</div>
            <div class="row debts-row" style="justify-content: flex-start; gap: 4px;">
                <span class="pair"><span class="pair-label-multiline">מס' נושים</span><input type="number" class="tiny" min="0" max="99"></span>
                <span class="pair"><span class="pair-label-multiline" style="white-space: normal; max-width: 70px;">סכום כולל</span><input type="text" class="short currency-input"></span>
                <span class="pair"><span class="pair-label-multiline" style="white-space: normal; max-width: 70px;">דין קדימה</span><input type="text" class="short currency-input"></span>
            </div>
            <div class="row">תביעות חוב נבדקו: <label><input type="radio" name="claims_checked"> כן</label><label><input type="radio" name="claims_checked"> לא</label></div>
            <div class="sub-title">חובות לא ברי הפטר</div>
            <div class="row" style="flex-wrap:wrap; justify-content: flex-start; gap: 10px;">
                <span class="pair"><label><input type="checkbox" id="alimonyDebtChk"> מזונות</label><input type="text" id="alimonyDebtAmount" class="short currency-input" min="0" max="99999"></span>
                <span class="pair"><label><input type="checkbox" id="taxDebtChk"> רשויות אכיפה</label><input type="text" id="taxDebtAmount" class="short currency-input" min="0" max="99999"></span>
            </div>
            <hr>
            <div class="sub-title">נכסים</div>
            <div class="row" style="justify-content: space-between; flex-wrap: wrap;">
                <span class="pair"><label><input type="checkbox"> דירת מגורים</label><label><input type="checkbox"> נכס</label><label><input type="checkbox"> רכב</label><label><input type="checkbox"> זכויות</label></span>
                <span class="pair">הערכת שווי: <input type="text" class="short currency-input"></span>
            </div>
        </div>


        <div data-step="4" data-label="הכנסות" class="card mobile-only-step">
            <div class="section-title" style="border-bottom:1px solid #e2e8f0;padding-bottom:2px;margin-bottom:4px;">
              הכנסות החייב, בן/בת הזוג וסיכום
            </div>

            <div class="sub-title">הכנסות החייב</div>

            <div class="row" style="flex-wrap:wrap;">
              מקצוע: <input type="text" class="short">
              מקום עבודה: <input type="text" class="short">
              היקף משרה: <input type="text" class="short">
            </div>
            <div class="row" style="flex-wrap:wrap; justify-content: flex-start; gap: 12px;">
                <span class="pair">
                    <label>שכר נטו:</label>
                    <input type="text" id="debtorNetIncome" class="short currency-input">
                    <label><input type="checkbox" id="debtorNotWorking"> החייב אינו עובד</label>
                </span>
                <span class="pair" style="margin-inline-start: 10px;">
                    <label style="white-space:nowrap;">פוטנציאל השתכרות:</label>
                    <input type="text" id="earningPotential" class="short currency-input">
                </span>
            </div>
            <div class="row">הערות: <input type="text" id="earningPotentialNotes" class="flex-1"></div>
            <hr>
            
            <div class="sub-title">קצבאות</div>
            <div class="allowance-input-row" id="allowanceInputs">
                <div class="row" style="justify-content: flex-start; gap: 10px;">
                    <span style="flex: 2 1 0;"><input type="text" placeholder="סוג קצבה" class="flex-1 allowance-type"></span>
                    <span style="flex: 1 1 0;"><input type="text" placeholder="סכום" class="currency-input allowance-amount"></span>
                </div>
                <div class="row" style="justify-content: flex-start; gap: 10px;">
                    <span style="flex: 2 1 0;"><input type="text" placeholder="סוג קצבה נוספת (אופציונלי)" class="flex-1 allowance-type"></span>
                    <span style="flex: 1 1 0;"><input type="text" placeholder="סכום" class="currency-input allowance-amount"></span>
                </div>
            </div>
            <hr>
            
            <div class="sub-title">הכנסות בן/בת הזוג</div>
            <div class="row" style="flex-wrap:wrap;">
              מקצוע: <input type="text" class="short">
              מקום עבודה: <input type="text" class="short">
              היקף משרה: <input type="text" class="short">
            </div>
            <div class="row not-working-toggle-row" id="spouseIncomeRow">
              שכר נטו: <input type="text" id="spouseNetIncome" class="short currency-input">
              <label><input type="checkbox" id="spouseNotWorking"> בן/בת הזוג אינו/ה עובד/ת</label>
            </div>
            <hr>
            <div class="income-expense-row">
                <span class="pair">
                    <label>סך הכל הכנסות:</label>
                    <input type="text" id="familyIncomeTotal" class="currency-input short">
                </span>
                <span class="pair">
                    <label>סך הכל הוצאות:</label>
                    <input type="text" id="familyExpensesTotal" class="currency-input short">
                </span>
            </div>
            
        </div>
        
        <div data-step="5" data-label="מחשבון" class="card mobile-only-step">
             <div class="sub-title" style="margin-top:0;">מחשבון צו תשלומים</div>
             <div class="calc-frame-card" style="margin-top:0; padding-bottom: 0;">
                <iframe src="payment-order-calculator.html" loading="lazy"></iframe>
            </div>
        </div>

        <div data-step="6" data-label="המלצות" class="card mobile-only-step">
             <div class="section-title" style="border-bottom:1px solid #e2e8f0;padding-bottom:2px;margin-bottom:4px;">
              סיכום והמלצות הנאמן
            </div>
            <div class="row" style="justify-content:space-between;align-items:center;"><div class="sub-title" style="margin-bottom:0;">סיכום הנאמן</div><label><input type="checkbox"> הכשרה כלכלית</label></div>
            <div class="row"><textarea rows="2" class="flex-1" placeholder="תמצית עמדת הנאמן (שתי שורות)"></textarea></div>
            <div class="row" style="justify-content:flex-start;align-items:center;"><div class="sub-title" style="margin-bottom:0;">המלצת נאמן</div></div>
            <div class="order-box" style="margin-top:2px;">
                <div class="recom-grid">
                    <div class="recom-item"><label>סכום חודשי</label><input type="text" id="trusteeMonthly" class="currency-input xshort" maxlength="6"></div>
                    <div class="recom-item"><label>משך</label><input type="number" id="trusteeDuration" class="tiny" min="0" max="99"></div>
                    <div class="recom-item"><label>סכום כולל</label><input type="text" id="trusteeTotal" class="currency-input xshort recom-total" readonly></div>
                </div>
            </div>
            <hr> 
            <div class="section-title" style="border-bottom:1px solid #e2e8f0;padding-bottom:2px;margin-bottom:4px; margin-top:8px;">
              סיכום והמלצות הממונה
            </div>
            <div class="row" style="justify-content:space-between;align-items:center;margin-top:6px;"><div class="sub-title" style="margin-bottom:0;">סיכום הממונה</div><label><input type="checkbox"> הכשרה כלכלית</label></div>
            <div class="row"><textarea rows="2" class="flex-1" placeholder="תמצית עמדת הממונה (שתי שורות)"></textarea></div>
            <div class="row" style="justify-content:flex-start;align-items:center;"><div class="sub-title" style="margin-bottom:0;">המלצת הממונה</div></div>
            <div class="order-box order-box-comm" style="margin-top:2px;">
                <div class="recom-grid">
                    <div class="recom-item"><label>סכום חודשי</label><input type="text" id="commMonthly" class="currency-input xshort" maxlength="6"></div>
                    <div class="recom-item"><label>משך</label><input type="number" id="commDuration" class="tiny" min="0" max="99"></div>
                    <div class="recom-item"><label>סכום כולל</label><input type="text" id="commTotal" class="currency-input xshort recom-total" readonly></div>
                </div>
            </div>
            <div class="row">נימוקים להמלצת הממונה: <textarea rows="2" class="flex-1" placeholder="נימוקים קצרים"></textarea></div>
        </div>

        <div class="layout-main desktop-only-content">

          <div data-step="D2" class="card narrow-col grid-item-A1">
            <div class="section-title" style="border-bottom:1px solid #e2e8f0;padding-bottom:2px;margin-bottom:4px;">
              התנהלות החייב, חובות ונכסים
            </div>
            <div class="sub-title">התנהלות החייב</div>
            <div class="small-text">דו"חות חודשיים:</div>
            <div class="row">
              <label class="reports-status-full"><input type="radio" name="reports_status" value="full"> הוגשו</label>
              <label class="reports-status-partial"><input type="radio" name="reports_status" value="partial"> חלקי</label>
              <label class="reports-status-none"><input type="radio" name="reports_status" value="none"> לא הוגשו</label>
            </div>
            <div class="row">הערות: <input type="text" class="flex-1"></div>
            <div class="sub-title" style="margin-top:4px;">מסמכים ותשלומים</div>
            <div class="row docs-row" style="justify-content: flex-start; gap: 10px;">
              <span class="pair"><span>מסמכים חסרים:</span> <label><input type="radio" name="missing_docs"> כן</label><label><input type="radio" name="missing_docs"> לא</label></span>
              <span class="pair" style="margin-inline-start: 10px;"><span class="arrears-label">סך פיגורים:</span><input type="text" class="short currency-input status-bad-bold"></span>
            </div>
            <hr><div class="sub-title">חובות</div>
            <div class="row debts-row" style="justify-content: flex-start; gap: 4px;">
              <span class="pair"><span class="pair-label-multiline">מס' נושים</span><input type="number" class="tiny" min="0" max="99"></span>
              <span class="pair"><span class="pair-label-multiline" style="white-space: normal; max-width: 70px;">סכום כולל</span><input type="text" class="short currency-input"></span>
              <span class="pair"><span class="pair-label-multiline" style="white-space: normal; max-width: 70px;">דין קדימה</span><input type="text" class="short currency-input"></span>
            </div>
            <div class="row">תביעות חוב נבדקו: <label><input type="radio" name="claims_checked"> כן</label><label><input type="radio" name="claims_checked"> לא</label></div>
            <div class="sub-title">חובות לא ברי הפטר</div>
            <div class="row" style="flex-wrap:wrap; justify-content: flex-start; gap: 10px;">
              <span class="pair"><label><input type="checkbox" id="alimonyDebtChk"> מזונות</label><input type="text" id="alimonyDebtAmount" class="short currency-input" min="0" max="99999"></span>
              <span class="pair"><label><input type="checkbox" id="taxDebtChk"> רשויות אכיפה</label><input type="text" id="taxDebtAmount" class="short currency-input" min="0" max="99999"></span>
            </div>
            <hr><div class="sub-title">נכסים</div>
            <div class="row" style="justify-content: space-between; flex-wrap: wrap;">
              <span class="pair"><label><input type="checkbox"> דירת מגורים</label><label><input type="checkbox"> נכס</label><label><input type="checkbox"> רכב</label><label><input type="checkbox"> זכויות</label></span>
              <span class="pair">הערכת שווי: <input type="text" class="short currency-input"></span>
            </div>
          </div> 
          
          <div data-step="D5" class="calc-frame-card card grid-item-B2" style="padding-top: 0; padding-bottom: 0;">
              <div class="sub-title" style="margin-top:0;">מחשבון צו תשלומים</div>
              <iframe src="payment-order-calculator.html" loading="lazy"></iframe>
          </div>

          <div data-step="D3" class="card grid-item-A2" style="display:flex;flex-direction:column; padding-bottom: 0;">
            <div class="section-title" style="border-bottom:1px solid #e2e8f0;padding-bottom:2px;margin-bottom:4px;">
              הכנסות החייב, בן/בת הזוג וסיכום
            </div>
            <div class="sub-title">הכנסות החייב</div>
            <div class="row" style="flex-wrap:wrap;">
              מקצוע: <input type="text" class="short"> מקום עבודה: <input type="text" class="short"> היקף משרה: <input type="text" class="short">
            </div>
            <div class="row" style="flex-wrap:wrap; justify-content: flex-start; gap: 12px;">
                <span class="pair"><label>שכר נטו:</label><input type="text" id="debtorNetIncomeD" class="short currency-input"><label><input type="checkbox" id="debtorNotWorkingD"> החייב אינו עובד</label></span>
                <span class="pair" style="margin-inline-start: 10px;"><label style="white-space:nowrap;">פוטנציאל השתכרות:</label><input type="text" id="earningPotentialD" class="short currency-input"></span>
            </div>
            <div class="row">הערות: <input type="text" id="earningPotentialNotesD" class="flex-1"></div>
            <hr>
            <div class="sub-title">קצבאות</div>
            <div class="allowance-input-row" id="allowanceInputsD">
                <div class="row" style="justify-content: flex-start; gap: 10px;">
                    <span style="flex: 2 1 0;"><input type="text" placeholder="סוג קצבה" class="flex-1 allowance-type"></span>
                    <span style="flex: 1 1 0;"><input type="text" placeholder="סכום" class="currency-input allowance-amount"></span>
                </div>
                <div class="row" style="justify-content: flex-start; gap: 10px;">
                    <span style="flex: 2 1 0;"><input type="text" placeholder="סוג קצבה נוספת (אופציונלי)" class="flex-1 allowance-type"></span>
                    <span style="flex: 1 1 0;"><input type="text" placeholder="סכום" class="currency-input allowance-amount"></span>
                </div>
            </div>
            <hr>
            <div class="sub-title">הכנסות בן/בת הזוג</div>
            <div class="row" style="flex-wrap:wrap;">
              מקצוע: <input type="text" class="short"> מקום עבודה: <input type="text" class="short"> היקף משרה: <input type="text" class="short">
            </div>
            <div class="row not-working-toggle-row" id="spouseIncomeRowD">
              שכר נטו: <input type="text" id="spouseNetIncomeD" class="short currency-input">
              <label><input type="checkbox" id="spouseNotWorkingD"> בן/בת הזוג אינו/ה עובד/ת</label>
            </div>
            <hr>
            <div class="income-expense-row">
                <span class="pair"><label>סך הכל הכנסות:</label><input type="text" id="familyIncomeTotalD" class="currency-input short"></span>
                <span class="pair"><label>סך הכל הוצאות:</label><input type="text" id="familyExpensesTotalD" class="currency-input short"></span>
            </div>
          </div>

          <div data-step="D4" class="card grid-item-B1">
            <div class="section-title" style="border-bottom:1px solid #e2e8f0;padding-bottom:2px;margin-bottom:4px;">סיכום והמלצות הנאמן</div>
            <div class="row" style="justify-content:space-between;align-items:center;"><div class="sub-title" style="margin-bottom:0;">סיכום הנאמן</div><label><input type="checkbox"> הכשרה כלכלית</label></div>
            <div class="row"><textarea rows="2" class="flex-1" placeholder="תמצית עמדת הנאמן (שתי שורות)"></textarea></div>
            <div class="row" style="justify-content:flex-start;align-items:center;"><div class="sub-title" style="margin-bottom:0;">המלצת נאמן</div></div>
            <div class="order-box" style="margin-top:2px;">
                <div class="recom-grid">
                    <div class="recom-item"><label>סכום חודשי</label><input type="text" id="trusteeMonthlyD" class="currency-input xshort" maxlength="6"></div>
                    <div class="recom-item"><label>משך</label><input type="number" id="trusteeDurationD" class="tiny" min="0" max="99"></div>
                    <div class="recom-item"><label>סכום כולל</label><input type="text" id="trusteeTotalD" class="currency-input xshort recom-total" readonly></div>
                </div>
            </div>
            <hr> 
            <div class="section-title" style="border-bottom:1px solid #e2e8f0;padding-bottom:2px;margin-bottom:4px; margin-top:8px;">סיכום והמלצות הממונה</div>
            <div class="row" style="justify-content:space-between;align-items:center;margin-top:6px;"><div class="sub-title" style="margin-bottom:0;">סיכום הממונה</div><label><input type="checkbox"> הכשרה כלכלית</label></div>
            <div class="row"><textarea rows="2" class="flex-1" placeholder="תמצית עמדת הממונה (שתי שורות)"></textarea></div>
            <div class="row" style="justify-content:flex-start;align-items:center;"><div class="sub-title" style="margin-bottom:0;">המלצת הממונה</div></div>
            <div class="order-box order-box-comm" style="margin-top:2px;">
                <div class="recom-grid">
                    <div class="recom-item"><label>סכום חודשי</label><input type="text" id="commMonthlyD" class="currency-input xshort" maxlength="6"></div>
                    <div class="recom-item"><label>משך</label><input type="number" id="commDurationD" class="tiny" min="0" max="99"></div>
                    <div class="recom-item"><label>סכום כולל</label><input type="text" id="commTotalD" class="currency-input xshort recom-total" readonly></div>
                </div>
            </div>
            <div class="row">נימוקים להמלצת הממונה: <textarea rows="2" class="flex-1" placeholder="נימוקים קצרים"></textarea></div>
          </div>
          
          <div data-step="D6" class="card grid-item-C2">
            <div class="section-title" style="border-bottom:1px solid #e2e8f0;padding-bottom:2px;margin-bottom:4px;">
              סיכום והמלצות הממונה
            </div>
            <div class="row" style="justify-content:space-between;align-items:center;margin-top:6px;"><div class="sub-title" style="margin-bottom:0;">סיכום הממונה</div><label><input type="checkbox"> הכשרה כלכלית</label></div>
            <div class="row"><textarea rows="2" class="flex-1" placeholder="תמצית עמדת הממונה (שתי שורות)"></textarea></div>
            <div class="row" style="justify-content:flex-start;align-items:center;"><div class="sub-title" style="margin-bottom:0;">המלצת הממונה</div></div>
            <div class="order-box order-box-comm" style="margin-top:2px;">
                <div class="recom-grid">
                    <div class="recom-item"><label>סכום חודשי</label><input type="text" id="commMonthlyD" class="currency-input xshort" maxlength="6"></div>
                    <div class="recom-item"><label>משך</label><input type="number" id="commDurationD" class="tiny" min="0" max="99"></div>
                    <div class="recom-item"><label>סכום כולל</label><input type="text" id="commTotalD" class="currency-input xshort recom-total" readonly></div>
                </div>
            </div>
            <div class="row">נימוקים להמלצת הממונה: <textarea rows="2" class="flex-1" placeholder="נימוקים קצרים"></textarea></div>
          </div>

        </div> </div> </form>
    
    <div class="footer">
      נבנה על ידי אליאב יחיאל
    </div>

  </div> <div class="mobile-fixed-elements mobile-navigation-wrapper">
    <div class="mobile-navigation">
        <button type="button" id="nav-prev" class="mobile-nav-btn nav-prev" disabled>← קודם</button>
        <button type="button" id="nav-next" class="mobile-nav-btn nav-next">הבא →</button>
    </div>
  </div>


  <button type="button" id="scrollTopBtn" class="scroll-top-btn">↑</button>

  <script>
    // הגדרות מערכת הניווט הרב-שלבית (6 שלבים)
    const formFlowContainer = document.getElementById('form-flow-container');
    const navPrevBtn = document.getElementById('nav-prev');
    const navNextBtn = document.getElementById('nav-next');
    const progressFill = document.getElementById('progress-fill');
    const progressText = document.getElementById('progress-text');
    const currentStepLabel = document.getElementById('current-step-label');
    
    // מזהה את 6 הבלוקים הנפרדים לניווט במובייל
    const allSteps = [
        document.querySelector('[data-step="1"]'), 
        document.querySelector('[data-step="2"]'), 
        document.querySelector('[data-step="3"]'),
        document.querySelector('[data-step="4"]'),
        document.querySelector('[data-step="5"]'),
        document.querySelector('[data-step="6"]')
    ];

    const totalSteps = 6; 
    let currentStep = 1;

    function isMobileView() {
        return window.innerWidth <= 800;
    }

    function updateFlow() {
        if (!isMobileView()) {
            formFlowContainer.style.transform = `translateX(0)`;
            return;
        }

        // 1. הזזה פיזית של המסך
        // 6 מסכים, כל אחד 16.666%
        const offset = (currentStep - 1) * -16.666;
        formFlowContainer.style.transform = `translateX(${offset}%)`;

        // 2. עדכון פס ההתקדמות והטקסט
        const progressPercent = (currentStep / totalSteps) * 100;
        progressFill.style.width = `${progressPercent}%`;
        progressText.textContent = `${currentStep}/${totalSteps}`;
        
        // 3. עדכון כפתורי הניווט והכותרת
        navPrevBtn.disabled = currentStep === 1;
        navNextBtn.disabled = currentStep === totalSteps;

        // מציאת הבלוק הנוכחי לפי Step
        const currentStepElement = document.querySelector(`[data-step="${currentStep}"]`);
        currentStepLabel.textContent = currentStepElement ? `${currentStep}. ${currentStepElement.dataset.label}` : '';

        // גלילה לראש המסך (בגלל שהניווט מקובע)
        document.body.scrollTop = 0; 
        document.documentElement.scrollTop = 0; 
    }

    function navigate(direction) {
        const newStep = currentStep + direction;
        if (newStep >= 1 && newStep <= totalSteps) {
            currentStep = newStep;
            updateFlow();
        }
    }

    // ניווט באמצעות כפתורים
    if (navNextBtn) navNextBtn.addEventListener('click', () => navigate(1));
    if (navPrevBtn) navPrevBtn.addEventListener('click', () => navigate(-1));

    // --- הוספת תמיכה בגרירה (Swipe) ---
    let touchStartX = 0;
    let touchEndX = 0;
    
    formFlowContainer.addEventListener('touchstart', e => {
      if (!isMobileView()) return;
      touchStartX = e.changedTouches[0].screenX;
    });

    formFlowContainer.addEventListener('touchend', e => {
      if (!isMobileView()) return;
      touchEndX = e.changedTouches[0].screenX;
      handleGesture();
    });

    function handleGesture() {
      const swipeThreshold = 50; // מינימום מרחק החלקה
      const diff = touchEndX - touchStartX;

      if (Math.abs(diff) > swipeThreshold) {
        if (diff > 0) { // החלקה ימינה (מעבר למסך קודם)
          navigate(-1);
        } else { // החלקה שמאלה (מעבר למסך הבא)
          navigate(1);
        }
      }
    }

    // --- קוד JavaScript ללוגיקה ואינטראקציה ---

    // פורמט אחוזים – 3 ספרות + %
    function setupPercentField(id) {
      const el = document.getElementById(id);
      if (!el) return;
      el.addEventListener('focus', () => {
        el.value = el.value.replace('%','').trim();
      });
      el.addEventListener('blur', () => {
        let v = el.value.replace(/[^\d]/g,'');
        if (!v) { 
            el.value = ''; 
            checkDisabilityHighlight();
            return; 
        }
        if (v.length > 3) v = v.slice(0,3);
        el.value = v + '%';
        checkDisabilityHighlight();
      });
    }

    function parseNumberFromPercent(val) {
        if (!val) return 0;
        const clean = String(val).replace(/[^\d]/g,'');
        const num = parseInt(clean, 10);
        return isNaN(num) ? 0 : num;
    }

    function checkDisabilityHighlight() {
        const disabilityEl = document.getElementById('disabilityPercent');
        const incapacityEl = document.getElementById('incapacityPercent');
        const iVal = parseNumberFromPercent(incapacityEl ? incapacityEl.value : '0%');
        const dVal = parseNumberFromPercent(disabilityEl ? disabilityEl.value : '0%');
        
        // 1. הסרת כל הבלטות האי כושר תחילה
        if(incapacityEl) {
            incapacityEl.classList.remove('incapacity-highlight', 'incapacity-border-med', 'incapacity-border-bold');
        }
        if (disabilityEl) {
             disabilityEl.classList.remove('incapacity-highlight');
        }
        
        // 2. הפעלת הבלטה לפי ערך אי כושר
        if (iVal > 0 && incapacityEl) {
            incapacityEl.classList.add('incapacity-highlight'); // צבע אדום
            
            if (iVal === 100) {
                incapacityEl.classList.add('incapacity-border-bold'); // מסגרת בולטת (3px)
            } else if (iVal > 75) {
                incapacityEl.classList.add('incapacity-border-med'); // מסגרת רגילה (2px)
            }
        }
        
        // נכות רגילה - רק אם יש ערך
        if (dVal > 0 && disabilityEl) {
             disabilityEl.classList.add('incapacity-highlight');
        }
    }


    setupPercentField('disabilityPercent');
    setupPercentField('incapacityPercent');

    // ניהול שדות מבוטלים
    function setupInputDisabling() {
        // --- החייב אינו עובד ---
        const debtorChk = document.getElementById('debtorNotWorking');
        const debtorIncomeInput = document.getElementById('debtorNetIncome');
        if (debtorChk && debtorIncomeInput) {
            function updateDebtorState() {
                // ביטול הקלדה בהכנסה נטו כאשר מסומן 'אינו עובד'
                debtorIncomeInput.disabled = debtorChk.checked;
                if (debtorChk.checked) {
                    if(debtorIncomeInput.value !== '0') {
                        debtorIncomeInput.value = '0';
                    }
                    debtorIncomeInput.dispatchEvent(new Event('input')); 
                }
            }
            debtorChk.addEventListener('change', updateDebtorState);
            updateDebtorState(); 
        }

        // --- תשלום מזונות ---
        const alimonyChk = document.getElementById('hasAlimony');
        const alimonyAmountInput = document.getElementById('alimonyAmount');
        if (alimonyChk && alimonyAmountInput) {
            function updateAlimonyState() {
                alimonyAmountInput.disabled = !alimonyChk.checked;
                if (!alimonyChk.checked) {
                    alimonyAmountInput.value = '';
                    alimonyAmountInput.dispatchEvent(new Event('input')); 
                }
            }
            alimonyChk.addEventListener('change', updateAlimonyState);
            updateAlimonyState(); 
        }
    }


    // עיצוב סכומי כסף בכל הטופס
    function attachCurrencyFormatting() {
      const inputs = document.querySelectorAll(".currency-input");
      inputs.forEach(input => {
        input.addEventListener("focus", () => {
          const raw = input.value.replace(/[^\d.]/g, "");
          input.value = raw;
        });
        input.addEventListener("blur", () => {
          let v = input.value.replace(/[^\d.]/g, "");
          if (!v) {
            input.value = "";
            return;
          }
          const num = parseFloat(v.replace(/,/g, ""));
          if (!isNaN(num)) {
            input.value = num.toLocaleString("he-IL", {
              minimumFractionDigits: 0,
              maximumFractionDigits: 2
            }) + " ₪";
          }
        });
      });
    }

    function sendEmail() {
      const subject = encodeURIComponent('דו"ח מסכם לדיון צו שיקום');
      const body = encodeURIComponent(
        'מצורף דו"ח סיכום לדיון צו שיקום כלכלי.\n\n' +
        '(ליצירת PDF – השתמש/י בכפתור הדפסה ושמור/י כ-PDF.)'
      );
      window.location.href = 'mailto:?subject=' + subject + '&body=' + body;
    }

    // "אינו עובד" – צביעה באדום
    function setupNotWorkingToggle(checkboxId, rowId) {
      const chk = document.getElementById(checkboxId);
      const row = document.getElementById(rowId);
      if (!chk || !row) return;
      function update() {
        // רק בן/בת זוג מקבל אדום לפי הבקשה
        const isSpouse = checkboxId === 'spouseNotWorking';
        if (isSpouse) {
             if (chk.checked) {
                row.classList.add('not-working-section');
            } else {
                row.classList.remove('not-working-section');
            }
        }
      }
      chk.addEventListener('change', update);
      update();
    }

    // דו"חות חודשיים – צבע לפי סימון
    function setupReportsStatusColors() {
      const radios = document.querySelectorAll('input[name="reports_status"]');
      if (!radios.length) return;

      function update() {
        const fullLabel = document.querySelector('.reports-status-full');
        const noneLabel = document.querySelector('.reports-status-none');
        if (fullLabel) fullLabel.classList.remove('status-ok','status-bad');
        if (noneLabel) noneLabel.classList.remove('status-ok','status-bad');

        const checked = document.querySelector('input[name="reports_status"]:checked');
        if (!checked) return;

        if (checked.value === 'full' && fullLabel) {
          fullLabel.classList.add('status-ok');
        }
        if (checked.value === 'none' && noneLabel) {
          noneLabel.classList.add('status-bad');
        }
      }

      radios.forEach(r => r.addEventListener('change', update));
      update();
    }

    // עזר: המרת טקסט סכום למספר
    function parseNumberFromCurrency(val) {
      if (!val) return 0;
      const clean = String(val).replace(/[^\d.]/g,'');
      const num = parseFloat(clean);
      return isNaN(num) ? 0 : num;
    }

    // חישוב סכומים כוללים בהמלצות (נאמן/ממונה)
    function updateRecommendationTotals() {
      const tm = document.getElementById('trusteeMonthly');
      const td = document.getElementById('trusteeDuration');
      const tt = document.getElementById('trusteeTotal');

      const cm = document.getElementById('commMonthly');
      const cd = document.getElementById('commDuration');
      const ct = document.getElementById('commTotal');

      if (tm && td && tt) {
        const m = parseNumberFromCurrency(tm.value);
        const d = parseInt(td.value || '0', 10) || 0;
        const total = m * d;
        tt.value = total ? total.toLocaleString('he-IL', {minimumFractionDigits:0, maximumFractionDigits:2}) + ' ₪' : '';
      }

      if (cm && cd && ct) {
        const m2 = parseNumberFromCurrency(cm.value);
        const d2 = parseInt(cd.value || '0', 10) || 0;
        const total2 = m2 * d2;
        ct.value = total2 ? total2.toLocaleString('he-IL', {minimumFractionDigits:0, maximumFractionDigits:2}) + ' ₪' : '';
      }
    }

    function calculatePaymentsTotals() {
      const orderDateInput   = document.getElementById('orderDate');
      const monthlyInput     = document.getElementById('monthlyPayment');
      const gradedInput      = document.getElementById('gradedPayment');
      const gradedDateInput  = document.getElementById('gradedFromDate');
      const totalDateInput   = document.getElementById('paymentsTotalDate');
      const totalAmountInput = document.getElementById('paymentsTotalAmount');

      if (!orderDateInput || !monthlyInput || !totalDateInput || !totalAmountInput) return;

      const today = new Date();
      totalDateInput.value = today.toLocaleDateString('he-IL');

      if (!orderDateInput.value) {
        totalAmountInput.value = '';
        return;
      }

      const orderDate = new Date(orderDateInput.value);
      if (isNaN(orderDate)) {
        totalAmountInput.value = '';
        return;
      }

      const monthlyAmount = parseNumberFromCurrency(monthlyInput.value);
      const gradedAmount  = gradedInput ? parseNumberFromCurrency(gradedInput.value) : 0;
      const gradedDateVal = gradedDateInput ? gradedDateInput.value : '';

      if (!monthlyAmount && !gradedAmount) {
        totalAmountInput.value = '';
        return;
      }

      // פונקציה לעבודה ברמת "חודש" (שנה*12 + חודש)
      const toIndex = (y,m) => y*12 + m; // m: 0-11
      const monthDiffInclusive = (startIndex, endIndex) => {
        const diff = endIndex - startIndex + 1;
        return diff > 0 ? diff : 0;
      };

      const firstPayMonthDate = new Date(orderDate.getTime());
      firstPayMonthDate.setMonth(firstPayMonthDate.getMonth() + 1); // החודש אחרי הצו

      const firstY = firstPayMonthDate.getFullYear();
      const firstM = firstPayMonthDate.getMonth(); // 0-11

      const todayY = today.getFullYear();
      const todayM = today.getMonth();

      const firstIdx = toIndex(firstY, firstM);
      const todayIdx = toIndex(todayY, todayM);

      // אם אנחנו לפני החודש הראשון לתשלום – אין תשלום
      if (todayIdx < firstIdx) {
        totalAmountInput.value = '';
        return;
      }

      let total = 0;

      if (!gradedAmount || !gradedDateVal) {
        // אין מדורג – הכל לפי החודשי
        const monthsAll = monthDiffInclusive(firstIdx, todayIdx);
        total = monthsAll * monthlyAmount;
      } else {
        const gradedDate = new Date(gradedDateVal);
        if (isNaN(gradedDate)) {
          const monthsAll = monthDiffInclusive(firstIdx, todayIdx);
          total = monthsAll * monthlyAmount;
        } else {
          const gY = gradedDate.getFullYear();
          const gM = gradedDate.getMonth(); // המדורג מתחיל בחודש זה
          const gIdx = toIndex(gY, gM);

          // אם המדורג בעתיד ביחס להיום – מתעלמים ממנו
          if (gIdx > todayIdx) {
            const monthsAll = monthDiffInclusive(firstIdx, todayIdx);
            total = monthsAll * monthlyAmount;
          } else {
            // אם המדורג מתחיל לפני או עם תחילת התשלומים – הכל מדורג
            if (gIdx <= firstIdx) {
              const monthsAll = monthDiffInclusive(firstIdx, todayIdx);
              const useAmount = gradedAmount || monthlyAmount;
              total = monthsAll * useAmount;
            } else {
              // שלב 1: חודשים רגילים – מהחודש הראשון לתשלום עד החודש שלפני המדורג
              const beforeEndIdx = gIdx - 1;
              const monthsBefore = monthDiffInclusive(firstIdx, beforeEndIdx);

              // שלב 2: חודשים מדורגים – מחודש המדורג ועד היום
              const monthsAfter = monthDiffInclusive(gIdx, todayIdx);

              total = (monthsBefore * monthlyAmount) + (monthsAfter * gradedAmount);
            }
          }
        }
      }

      if (!total) {
        totalAmountInput.value = '';
      } else {
        totalAmountInput.value = total.toLocaleString('he-IL', {
          minimumFractionDigits: 0,
          maximumFractionDigits: 2
        }) + " ₪";
      }
    }


   // ----- סנכרון טופס ← מחשבון באייפריים -----
    let calcFrame = null;
    let calcReady = false;

    function syncCalculatorFromForm() {
      const calcFrameElement = document.querySelector('.calc-frame-card iframe');
      if (!calcFrameElement) return;

      calcFrame = calcFrameElement; 
      
      if (!calcReady || !calcFrame || !calcFrame.contentWindow) return;

      const w   = calcFrame.contentWindow;
      const doc = w.document;
      if (!doc) return;

      const debtorIncomeEl = document.getElementById('debtorNetIncome');
      const spouseIncomeEl = document.getElementById('spouseNetIncome');
      const kidsEl         = document.getElementById('minorChildrenCount');
      const alimonyChk     = document.getElementById('hasAlimony');
      const alimonyAmtEl   = document.getElementById('alimonyAmount');

      let debtorNet  = debtorIncomeEl ? parseNumberFromCurrency(debtorIncomeEl.value) : 0;
      const spouseNet  = spouseIncomeEl ? parseNumberFromCurrency(spouseIncomeEl.value) : 0;
      const kidsCount  = kidsEl ? (parseInt(kidsEl.value || '0', 10) || 0) : 0;
      const hasAlimony = alimonyChk ? alimonyChk.checked : false;
      const alimonyAmt = alimonyAmtEl ? parseNumberFromCurrency(alimonyAmtEl.value) : 0;
      
      // לוגיקת קצבאות
      const allowanceAmounts = Array.from(document.querySelectorAll('.allowance-amount'))
                                  .map(input => parseNumberFromCurrency(input.value));
      const totalAllowances = allowanceAmounts.reduce((sum, current) => sum + current, 0);

      // לוגיקת צו אפס (100% אי כושר בלבד)
      const incapacityEl = document.getElementById('incapacityPercent');
      const iVal = parseNumberFromPercent(incapacityEl ? incapacityEl.value : '0%');

      // הכנסה שתשמש לחישוב שכר (בלי קצבאות)
      let incomeForSalary = debtorNet;
      
      // סכום הקצבאות שיוזן לשדה הקצבאות במחשבון
      let allowancesForCalculator = totalAllowances;
      
      if (iVal === 100) {
          incomeForSalary = 0; // אם 100% אי כושר, השכר הרגיל הוא אפס
      }


      // שכר חייב (salaryDebtor) - מקבל שכר נטו, או 0 אם 100% אי כושר
      const salaryDebtor = doc.getElementById('salaryDebtor');
      if (salaryDebtor) {
        salaryDebtor.value = incomeForSalary || '';
        salaryDebtor.dispatchEvent(new w.Event('input', {bubbles:true}));
      }
      
      // קצבאות (allowanceIncome) - מקבלות את סך הקצבאות
      const allowanceIncome = doc.getElementById('allowanceIncome');
      if (allowanceIncome) {
          allowanceIncome.value = allowancesForCalculator || '';
          allowanceIncome.dispatchEvent(new w.Event('input', {bubbles:true}));
      }


      // שכר בן/בת זוג
      const salaryPartner = doc.getElementById('salaryPartner');
      if (salaryPartner) {
        salaryPartner.value = spouseNet || '';
        salaryPartner.dispatchEvent(new w.Event('input', {bubbles:true}));
      }

      // ילדים – עדכון childrenCount בתוך המחשבון (מוגדר שם עם let, לא על window)
      try {
        const n = Math.max(0, Math.min(10, kidsCount));
        if (typeof w.eval === 'function') {
          // מעדכנים את המשתנה הגלובלי באייפריים
          w.eval('childrenCount = ' + n + ';');
          if (typeof w.updateChildrenLabel === 'function') {
            w.updateChildrenLabel();
          }
        }
      } catch (e) {
        // אם מסיבה כלשהי אין גישה – מתעלמים
      }
      // מזונות – רק אם מסומן בטופס
      const alimonyInput = doc.getElementById('alimonyExpenses');
      if (alimonyInput) {
        if (hasAlimony && alimonyAmt > 0) {
          alimonyInput.value = alimonyAmt;
        } else {
          alimonyInput.value = '';
        }
        alimonyInput.dispatchEvent(new w.Event('input', {bubbles:true}));
      }

      // מצב משפחתי → סטטוס במחשבון
      const familyRadios = document.querySelectorAll('input[name="family_status"]');
      let familyValue = '';
      familyRadios.forEach(r => { if (r.checked) familyValue = r.value; });

      let targetType = null; // "יחיד" / "זוג" / "רווק"
      if (familyValue === 'נשוי') {
        targetType = 'זוג';
      } else if (familyValue === 'רווק' || familyValue === 'גרוש' || familyValue === 'אלמן') {
        targetType = 'רווק';
      }

      if (targetType) {
        const ftButtons = doc.querySelectorAll('.family-type');
        ftButtons.forEach(btn => {
          if (btn.dataset.type === targetType) {
            btn.click();
          }
        });
      }

      // חישוב מחדש במחשבון
      if (typeof w.calc === 'function') {
        w.calc();
      }
    }

    function initCalculatorSync() {
      calcFrame = document.querySelector('.calc-frame-card iframe');
      if (!calcFrame) return;
      calcFrame.addEventListener('load', () => {
        calcReady = true;
        syncCalculatorFromForm();
      });
    }

    // ----- שמירת/שחזור מצב טופס -----

    function saveFormState() {
      const form = document.getElementById('reportForm');
      if (!form) return;
      const fields = form.querySelectorAll('input, textarea, select');
      const data = [];
      fields.forEach((el) => {
        data.push({
          type: el.type,
          tag: el.tagName,
          value: el.value,
          checked: el.checked || false
        });
      });
      try {
        localStorage.setItem('insolvencyReportFormV2', JSON.stringify(data));
      } catch (e) {}
    }

    function restoreFormState() {
      const form = document.getElementById('reportForm');
      if (!form) return;
      let data;
      try {
        data = JSON.parse(localStorage.getItem('insolvencyReportFormV2') || 'null');
      } catch (e) {
        data = null;
      }
      if (!Array.isArray(data)) {
        alert('לא נמצאו נתונים לשחזור.');
        return;
      }
      const fields = form.querySelectorAll('input, textarea, select');
      fields.forEach((el, idx) => {
        const item = data[idx];
        if (!item) return;
        if (el.type === 'checkbox' || el.type === 'radio') {
          el.checked = !!item.checked;
        } else {
          el.value = item.value || '';
        }
      });

      setupReportsStatusColors();
      setupNotWorkingToggle('debtorNotWorking', 'debtorIncomeRow');
      setupNotWorkingToggle('spouseNotWorking', 'spouseIncomeRow');
      setupInputDisabling(); // הפעלה לאחר שחזור
      checkDisabilityHighlight(); // הפעלה לאחר שחזור
      attachCurrencyFormatting();
      updateRecommendationTotals();
      calculatePaymentsTotals();
      syncCalculatorFromForm();
      alert('הנתונים שוחזרו מהגרסה האחרונה שנשמרה.');
    }

    // חץ חזרה לראש הדף
    function setupScrollTopButton() {
      const btn = document.getElementById('scrollTopBtn');
      if (!btn) return;
      window.addEventListener('scroll', () => {
        if (window.scrollY > 200) {
          btn.style.display = 'flex';
        } else {
          btn.style.display = 'none';
        }
      });
      btn.addEventListener('click', () => {
        window.scrollTo({top: 0, behavior: 'smooth'});
      });
    }

    document.addEventListener("DOMContentLoaded", () => {
      attachCurrencyFormatting();
      setupNotWorkingToggle('debtorNotWorking', 'debtorIncomeRow');
      setupNotWorkingToggle('spouseNotWorking', 'spouseIncomeRow');
      setupInputDisabling(); 
      setupReportsStatusColors();
      setupScrollTopButton();
      initCalculatorSync();
      updateFlow(); // אתחול תצוגת המובייל
      checkDisabilityHighlight(); // בדיקה ראשונית לאחר טעינה

      const form = document.getElementById('reportForm');
      if (form) {
        form.addEventListener('input', (e) => {
          if (e.target && (
            e.target.id === 'trusteeMonthly' ||
            e.target.id === 'trusteeDuration' ||
            e.target.id === 'commMonthly' ||
            e.target.id === 'commDuration'
          )) {
            updateRecommendationTotals();
          }
          if (e.target && (
            e.target.id === 'orderDate' ||
            e.target.id === 'monthlyPayment' ||
            e.target.id === 'gradedPayment' ||
            e.target.id === 'gradedFromDate'
          )) {
            calculatePaymentsTotals();
          }
          if (e.target && (
              e.target.id === 'disabilityPercent' || 
              e.target.id === 'incapacityPercent' ||
              e.target.classList.contains('allowance-amount') ||
              e.target.classList.contains('currency-input')
          )) {
              checkDisabilityHighlight();
              syncCalculatorFromForm();
          }

          saveFormState();
          // ה-syncCalculatorFromForm כבר נקרא בתוך ה-if/else if
        });

        form.addEventListener('change', (e) => {
          if (e.target && (
            e.target.id === 'trusteeMonthly' ||
            e.target.id === 'trusteeDuration' ||
            e.target.id === 'commMonthly' ||
            e.target.id === 'commDuration'
          )) {
            updateRecommendationTotals();
          }
          if (e.target && (
            e.target.id === 'orderDate' ||
            e.target.id === 'monthlyPayment' ||
            e.target.id === 'gradedPayment' ||
            e.target.id === 'gradedFromDate'
          )) {
            calculatePaymentsTotals();
          }
          if (e.target && (
              e.target.id === 'disabilityPercent' || 
              e.target.id === 'incapacityPercent'
          )) {
              checkDisabilityHighlight();
          }
          if (e.target && (e.target.id === 'hasAlimony' || e.target.id === 'debtorNotWorking')) {
             // שינוי מזונות או אינו עובד גורר סנכרון
             syncCalculatorFromForm();
          }


          saveFormState();
          // ה-syncCalculatorFromForm כבר נקרא בתוך ה-if/else if
        });
      }

      // חישוב ראשוני
      calculatePaymentsTotals();
    });
    
    // מעדכן את הפריסה במקרה של שינוי גודל (מעבר בין מובייל לדסקטופ)
    window.addEventListener('resize', () => {
        currentStep = 1; // מאפס את המסך ל-1 במעבר דסקטופ/מובייל
        updateFlow();
    });
  </script>
</body>
</html>
