<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>דו"ח מסכם לדיון צו שיקום</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <style>
    * { box-sizing: border-box; }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      direction: rtl;
      text-align: right;
      margin: 0;
      background: #e5f6ff;
      font-size: 12px;
      -webkit-font-smoothing: antialiased;
    }

    .top-bar {
      background: #0f766e;
      color: #fff;
      padding: 10px 18px;
      font-size: 18px;
      font-weight: 700;
      text-align: center;
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .page {
      max-width: 1100px;
      margin: 8px auto;
      padding: 8px;
    }

    .card {
      background: #f8fafc;
      border-radius: 14px;
      border: 1px solid #dbeafe;
      box-shadow: 0 6px 14px rgba(15, 23, 42, 0.06);
      padding: 8px 10px;
      margin-bottom: 8px;
      page-break-inside: avoid;
      break-inside: avoid;
    }

    .section-title {
      font-size: 13px;
      font-weight: 700;
      color: #0f172a;
      margin: 0;
    }

    .section-header-flex {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      margin-bottom: 4px;
      padding-bottom: 2px;
      border-bottom: 1px solid #e2e8f0;
    }

    .sub-title {
      font-size: 12px;
      font-weight: 600;
      color: #0f766e;
      margin: 4px 0 2px;
      text-align: right;
    }

    .row {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 6px;
      margin-bottom: 4px;
    }

    label {
      font-size: 11px;
      display: inline-flex;
      align-items: center;
      gap: 2px;
    }

    input[type="text"],
    input[type="number"],
    input[type="date"],
    input[type="month"],
    input[type="time"],
    textarea,
    select {
      font-size: 11px;
      padding: 3px 5px;
      border-radius: 8px;
      border: 1px solid #cbd5f5;
      background: #ffffff;
      min-width: 0;
      font-weight: 600;
      color: #1d4ed8;
      line-height: 1.4;
    }

    textarea { resize: vertical; }

    .short   { width: 80px; }
    .tiny    { width: 50px; }
    .mini    { width: 30px; }
    .medium  { width: 120px; }
    .xshort  { width: 60px; }
    .flex-1  { flex: 1 1 0; }
    .small-text { font-size: 11px; color: #64748b; }

    hr {
      border: none;
      border-top: 1px dashed #e2e8f0;
      margin: 3px 0;
    }

    .footer {
      text-align: center;
      font-size: 11px;
      color: #475569;
      margin-top: 6px;
    }

    .buttons-inline {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
      justify-content: center;
      margin-bottom: 0;
    }

    .btn {
      border: none;
      padding: 4px 9px;
      border-radius: 999px;
      font-size: 11px;
      cursor: pointer;
      font-weight: 600;
      white-space: nowrap;
    }

    .btn-print   { background: #0ea5e9; color: #fff; }
    .btn-email   { background: #6366f1; color: #fff; }
    .btn-shot    { background: #0f766e; color: #fff; }
    .btn-reset   { background: #fef2f2; color: #b91c1c; border: 1px solid #fecaca; }
    .btn-restore { background: #eef2ff; color: #1e3a8a; border: 1px solid #c7d2fe; }

    .btn-toggle-block {
      background: #e0f2fe;
      color: #0f172a;
      border-radius: 999px;
      border: 1px solid #bfdbfe;
      font-size: 10px;
      padding: 2px 8px;
    }

    .allowance-title { color: #15803d; font-weight: 700; text-align: right; width: auto; }

    .order-box {
      border: 2px solid #0f766e;
      border-radius: 12px;
      padding: 6px 8px;
      background: #ecfeff;
    }

    .hearing-box {
      border: 1px solid #cbd5e1;
      border-radius: 8px;
      padding: 4px 6px;
      background: #eff6ff;
      margin-top: 2px;
    }

    .calc-frame-card {
      margin-top: 0;
      margin-bottom: 0;
      flex: 1 1 auto;
      page-break-inside: avoid;
      break-inside: avoid;
    }

    .calc-frame-card iframe {
      width: 100%;
      border: 0;
      border-radius: 12px;
      height: 380px;
      box-shadow: 0 4px 12px rgba(15, 23, 42, 0.1);
      background: #ffffff;
    }

    #familyIncomeTotal { color: #15803d; }
    #familyExpensesTotal { color: #b91c1c; }
    .status-ok { color: #15803d; font-weight: 700; }
    .status-bad { color: #b91c1c; font-weight: 700; }

    .not-working-section label,
    .not-working-section input,
    .not-working-section select {
      color: #b91c1c;
      border-color: #fecaca;
    }

    .pair {
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .pair-label-multiline {
      display: inline-block;
      line-height: 1.1;
      max-width: 60px;
      white-space: normal;
      text-align: right;
    }

    .narrow-col .row input[type="text"],
    .narrow-col .row input[type="number"] {
      width: 70px;
    }

    .narrow-col .debts-row .pair .pair-label-multiline {
      max-width: 50px;
    }

    .narrow-col .row {
      justify-content: flex-start;
      gap: 4px;
    }

    .narrow-col .sub-title { margin-top: 6px; }

    .debts-row { flex-wrap: nowrap; justify-content: flex-start; gap: 10px; }

    .docs-row .arrears-label { margin-inline-start: 12px; }

    .recom-grid {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 4px;
      margin-bottom: 4px;
      align-items: flex-start;
    }

    .recom-item input {
      max-width: 100%;
      width: 99%;
    }

    .recom-item .tiny { width: 40px !important; }
    .recom-item .xshort { width: 70px !important; }

    .recom-total { background: #fef9c3; font-weight: 700; }

    .order-box-comm {
      border-color: #6366f1;
      background: #eef2ff;
    }

    .scroll-top-btn {
      position: fixed;
      bottom: 16px;
      left: 16px;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      border: 1px solid #cbd5e1;
      background: #ffffff;
      box-shadow: 0 2px 6px rgba(15, 23, 42, 0.2);
      cursor: pointer;
      display: none;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      z-index: 50;
    }

    .income-expense-row {
      display: flex;
      justify-content: space-between;
      gap: 12px;
      flex-wrap: nowrap !important;
    }

    .income-expense-row .pair {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      flex: 0 0 auto;
    }

    .income-expense-row .pair label {
      font-size: 12px;
      font-weight: 600;
      color: #0f172a;
    }

    .income-expense-row .pair input {
      width: 90px;
      min-width: 70px;
    }

    .mobile-fixed-elements {
      position: fixed;
      width: 100%;
      left: 0;
      z-index: 60;
      padding: 0 8px;
    }

    .progress-container {
      top: 50px;
      background: #eff6ff;
      padding: 8px 10px;
      border-radius: 0 0 12px 12px;
      box-shadow: 0 1px 4px rgba(15, 23, 42, 0.1);
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-inline: 0;
      border: 1px solid #dbeafe;
      border-top: none;
    }

    .mobile-navigation {
      bottom: 0;
      background: #e5f6ff;
      padding: 8px 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 -2px 6px rgba(15, 23, 42, 0.1);
      border-radius: 12px 12px 0 0;
    }

    .progress-bar {
      height: 6px;
      background: #cbd5e1;
      flex-grow: 1;
      border-radius: 3px;
      margin-inline: 10px;
      position: relative;
      overflow: hidden;
    }

    .progress-fill {
      height: 100%;
      width: 0%;
      background: #0f766e;
      border-radius: 3px;
      transition: width 0.3s ease-in-out;
    }

    .step-label {
      font-size: 10px;
      color: #0f172a;
      font-weight: 600;
      white-space: nowrap;
    }

    .mobile-nav-btn {
      flex: 1;
      background: #0f766e;
      color: #fff;
      padding: 8px;
      border: none;
      border-radius: 8px;
      font-weight: 700;
      cursor: pointer;
      margin: 0 4px;
      font-size: 12px;
    }

    .mobile-nav-btn:disabled {
      background: #cbd5e1;
      cursor: default;
    }

    #form-flow-container { display: block; }

    @media (min-width: 800px) {
      .mobile-fixed-elements { display: none !important; }
    }

    @media (max-width: 800px) {
      body { padding-top: 50px; padding-bottom: 70px; }
      .top-bar { position: fixed; width: 100%; }

      #form-flow-container {
        display: flex;
        overflow-x: hidden;
        transition: transform 0.4s ease-in-out;
        width: 400%;
      }

      #form-flow-container > div {
        flex: 0 0 25%;
        padding: 0 4px;
        min-height: 100%;
        display: block !important;
      }

      .layout-main { display: block; }

      .income-expense-row {
        flex-wrap: wrap !important;
        justify-content: flex-start !important;
      }

      .income-expense-row .pair {
        flex: 1 1 100%;
        margin-bottom: 4px;
      }
    }

    @media (min-width: 800px) {
      .layout-main {
        display: grid;
        grid-template-columns: 1fr 1.6fr;
        gap: 4px;
        align-items: flex-start;
        margin-bottom: 8px;
        grid-template-rows: auto auto;
        grid-template-areas:
          "A1 A2"
          "B1 B2";
      }

      .grid-item-A1 { grid-area: A1; }
      .grid-item-A2 { grid-area: A2; margin-bottom: 0; }
      .grid-item-B1 { grid-area: B1; margin-bottom: 0; }
      .grid-item-B2 { grid-area: B2; }
    }

    @media print {
      @page { size: A4 portrait; margin: 5mm; }
      body { background: #ffffff; font-size: 11px; }
      .top-bar {
        border-bottom: 1px solid #cbd5e1;
        box-shadow: none;
        position: static;
      }
      .page {
        max-width: 100%;
        margin: 0;
        padding: 4mm;
        transform: scale(0.86);
        transform-origin: top center;
      }
      .card {
        box-shadow: none;
        border: 1px solid #e2e8f0;
      }
      .buttons-inline,
      .scroll-top-btn,
      .progress-container,
      .mobile-navigation { display: none !important; }

      .layout-main {
        display: block !important;
      }

      .card.collapsed,
      .calc-frame-card.collapsed {
        display: block !important;
      }
    }

    .row:has(input.currency-input, input.percent-field) {
      justify-content: flex-start;
    }

    .currency-input.readonly {
      background: #f8fafc;
      color: #94a3b8;
    }

    /* תאריך צו מודגש */
    #orderDate {
      border-width: 2px;
      border-color: #0f766e;
    }

    /* הדגשת שדה אי כושר */
    #incapacityRow.incapacity-low input,
    #incapacityRow.incapacity-low label {
      color: #b91c1c;
    }

    #incapacityRow.incapacity-high input,
    #incapacityRow.incapacity-high label {
      color: #b91c1c;
      border-color: #b91c1c;
    }

    #incapacityRow.incapacity-full input,
    #incapacityRow.incapacity-full label {
      color: #b91c1c;
      border-color: #b91c1c;
      background: #fee2e2;
      font-weight: 700;
    }

    /* פיגורים */
    .arrears-active input {
      border-color: #b91c1c;
      color: #b91c1c;
      background: #fef2f2;
    }

    /* מזונות */
    .alimony-active label,
    .alimony-active input {
      color: #b91c1c;
      border-color: #b91c1c;
      font-weight: 700;
    }

    /* כפתורי היקף משרה */
    .employment-toggle {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      flex-wrap: wrap;
    }

    .toggle-btn {
      border-radius: 999px;
      border: 1px solid #cbd5e1;
      background: #ffffff;
      padding: 2px 8px;
      font-size: 10px;
      cursor: pointer;
    }

    .toggle-btn.active {
      border-width: 2px;
      border-color: #0f172a;
      background: #e5e7eb;
      font-weight: 700;
    }

    /* כפתור פלוס להוספת שדות */
    .inline-add-field {
      margin: 4px 0;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .add-field-btn {
      border-radius: 999px;
      border: 1px solid #d1d5db;
      background: #f9fafb;
      font-size: 10px;
      padding: 2px 8px;
      cursor: pointer;
    }

    .add-field-select {
      font-size: 11px;
      max-width: 160px;
    }

    .extra-field-row {
      margin-top: 2px;
    }

    /* קיפול בלוקים */
    .card.collapsed,
    .calc-frame-card.collapsed {
      display: none;
    }

    /* מצב צילום מסך/לכידה */
    body.capture-mode .mobile-fixed-elements {
      display: none !important;
    }

    body.capture-mode #form-flow-container {
      display: block !important;
      transform: none !important;
      width: 100% !important;
    }

    body.capture-mode #form-flow-container > div {
      flex: 0 0 auto !important;
    }

    body.capture-mode .layout-main {
      display: block !important;
    }

    body.capture-mode input,
    body.capture-mode textarea {
      padding-top: 4px;
      padding-bottom: 4px;
      line-height: 1.6;
    }

  </style>
</head>
<body>
  <div class="top-bar">
    דו"ח מסכם לדיון צו שיקום-220
  </div>

  <div class="page">
    <form id="reportForm">
      <div id="form-flow-container">

        <!-- צעד 1: פרטי תיק וצו -->
        <div data-step="1" data-label="פרטי תיק וצו">
          <div class="card">
            <div class="section-header-flex">
              <div class="section-title">פרטי תיק וצו תשלומים</div>
              <div class="buttons-inline">
                <button type="button" class="btn btn-print" onclick="window.print()">🖨 הדפסה / PDF</button>
                <button type="button" class="btn btn-email" onclick="sendEmail()">✉ שליחה במייל</button>
                <button type="button" class="btn btn-shot" onclick="screenshotReport()">📸 צילום מסך</button>
                <button type="button" class="btn btn-reset" onclick="document.getElementById('reportForm').reset()">↺ איפוס</button>
                <button type="button" class="btn btn-restore" onclick="restoreFormState()">🔁 שחזור</button>
              </div>
            </div>

            <div style="display:grid;grid-template-columns:1.1fr 1fr 1.2fr;gap:8px;align-items:flex-start;">

              <!-- פרטי תיק -->
              <div>
                <div class="sub-title">פרטי תיק</div>

                <div class="row">
                  תיק ממונה:
                  <input type="text" class="short" maxlength="5">
                  תיק ביהמ"ש:
                  <input type="text" class="short">
                </div>

                <div class="row">
                  שם החייב/ת:
                  <input type="text" class="short">
                  שם הנאמן:
                  <input type="text" class="short">
                </div>

                <div class="row">
                  תאריך צו:
                  <input type="date" id="orderDate" class="medium">
                  לבקשת:
                  <label><input type="radio" name="order_by"> חייב</label>
                  <label><input type="radio" name="order_by"> נושה</label>
                </div>

                <div class="hearing-box">
                  <div class="row no-wrap">
                    מקום שיפוט:
                    <input type="text" class="tiny">
                    תאריך דיון:
                    <input type="date" class="medium">
                  </div>
                  <div class="row">
                    שעת דיון:
                    <input type="time" class="short" step="300">
                  </div>
                </div>
              </div>

              <!-- צו תשלומים -->
              <div>
                <div class="order-box">
                  <div class="sub-title">צו תשלומים</div>

                  <div class="row no-wrap">
                    תשלום חודשי:
                    <input type="text" id="monthlyPayment" class="xshort currency-input" maxlength="6">
                  </div>

                  <div class="row no-wrap">
                    תשלום מדורג:
                    <input type="text" id="gradedPayment" class="xshort currency-input" maxlength="6">
                    מיום:
                    <input type="date" id="gradedFromDate" class="medium">
                  </div>

                  <div class="row">
                    מסירה לנושים:
                    <label><input type="radio" name="notices"> כן</label>
                    <label><input type="radio" name="notices"> לא</label>
                  </div>

                  <hr>

                  <div class="row no-wrap">
                    סה"כ נכון ליום:
                    <input type="text" id="paymentsTotalDate" class="short" readonly>
                  </div>

                  <div class="row no-wrap">
                    <span class="pair">
                      סה"כ תשלומים:
                      <input type="text" id="paymentsTotalAmount" class="short currency-input" readonly>
                    </span>
                    <span class="pair">
                      מס' חודשים מהצו:
                      <input type="text" id="monthsSinceOrder" class="xshort" readonly>
                    </span>
                  </div>
                </div>
              </div>

              <!-- פרטים אישיים ורפואיים -->
              <div>
                <div class="sub-title">פרטים אישיים</div>

                <div class="row" style="flex-wrap:wrap;">
                  מצב משפחתי:
                  <label><input type="radio" name="family_status" value="רווק"> רווק</label>
                  <label><input type="radio" name="family_status" value="נשוי"> נשוי</label>
                  <label><input type="radio" name="family_status" value="גרוש"> גרוש</label>
                  <label><input type="radio" name="family_status" value="אלמן"> אלמן</label>
                </div>

                <div class="row">
                  ילדים קטינים:
                  <input type="number" id="minorChildrenCount" class="short" min="0" max="11">
                  <span id="alimonyWrapper" class="pair">
                    תשלום מזונות:
                    <label><input type="checkbox" id="hasAlimony"> כן</label>
                    <input type="text" id="alimonyAmount" class="short currency-input">
                  </span>
                </div>

                <hr>

                <div class="sub-title">מצב רפואי ואישורי מל"ל</div>

                <div class="row" id="incapacityRow">
                  נכות:
                  <input type="text" class="short percent-field" id="disabilityPercent" maxlength="3" placeholder="0%">
                  אי כושר:
                  <input type="text" class="short percent-field" id="incapacityPercent" maxlength="3" placeholder="0%">
                </div>

                <div class="row medical-notes-row">
                  בעיות רפואיות (תמציתי):
                  <input type="text" class="flex-1">
                </div>

              </div>

            </div>
          </div>
        </div>

        <!-- צעד 2–4: גריד ראשי -->
        <div class="layout-main">

          <!-- צעד 2: התנהלות, חובות, נכסים -->
          <div data-step="2" data-label="חובות ונכסים" class="card narrow-col grid-item-A1">
            <div class="section-title" style="border-bottom:1px solid #e2e8f0;padding-bottom:2px;margin-bottom:4px;">
              התנהלות החייב, חובות ונכסים
            </div>

            <div class="sub-title">התנהלות החייב</div>

            <div class="small-text">דו"חות חודשיים:</div>
            <div class="row">
              <label class="reports-status-full">
                <input type="radio" name="reports_status" value="full"> הוגשו
              </label>
              <label class="reports-status-partial">
                <input type="radio" name="reports_status" value="partial"> הוגשו חלקית
              </label>
              <label class="reports-status-none">
                <input type="radio" name="reports_status" value="none"> לא הוגשו כלל
              </label>
            </div>

            <div class="row">
              הערות:
              <input type="text" class="flex-1">
            </div>

            <div class="sub-title" style="margin-top:4px;">מסמכים ותשלומים</div>

            <div class="row docs-row" style="justify-content: space-between;">
              <span class="pair">
                <span>מסמכים חסרים:</span>
                <label><input type="radio" name="missing_docs"> כן</label>
                <label><input type="radio" name="missing_docs"> לא</label>
              </span>
              <span class="pair arrears-wrapper">
                <span class="arrears-label">סך פיגורים:</span>
                <input type="text" id="arrearsAmount" class="short currency-input">
              </span>
            </div>

            <hr>

            <div class="sub-title">חובות</div>

            <div class="row debts-row" style="justify-content: flex-start; gap: 4px;">
              <span class="pair">
                <span class="pair-label-multiline">מס' נושים</span>
                <input type="number" class="tiny" min="0" max="99">
              </span>

              <span class="pair">
                <span class="pair-label-multiline">סכום כולל</span>
                <input type="text" class="short currency-input">
              </span>

              <span class="pair">
                <span class="pair-label-multiline">דין קדימה</span>
                <input type="text" class="short currency-input">
              </span>
            </div>

            <div class="row">
              תביעות חוב נבדקו:
              <label><input type="radio" name="claims_checked"> כן</label>
              <label><input type="radio" name="claims_checked"> לא</label>
            </div>

            <div class="sub-title">חובות לא ברי הפטר</div>

            <div class="row" style="flex-wrap:wrap; justify-content: space-between;">
              <span class="pair">
                <label><input type="checkbox" id="alimonyDebtChk"> מזונות</label>
                <input type="text" id="alimonyDebtAmount" class="short currency-input" min="0" max="99999">
              </span>
              <span class="pair">
                <label><input type="checkbox" id="taxDebtChk"> רשויות אכיפה</label>
                <input type="text" id="taxDebtAmount" class="short currency-input" min="0" max="99999">
              </span>
            </div>

            <hr>

            <div class="sub-title">נכסים</div>

            <div class="row" style="justify-content: space-between; flex-wrap: wrap;">
              <span class="pair">
                <label><input type="checkbox"> דירת מגורים</label>
                <label><input type="checkbox"> נכס</label>
                <label><input type="checkbox"> רכב</label>
                <label><input type="checkbox"> זכויות</label>
              </span>
              <span class="pair">
                הערכת שווי:
                <input type="text" class="short currency-input">
              </span>
            </div>
          </div>

          <!-- צעד 3: הכנסות -->
          <div data-step="3" data-label="הכנסות" class="card grid-item-A2" id="incomeCard" style="display:flex;flex-direction:column; padding-bottom: 0;">
            <div class="section-title" style="border-bottom:1px solid #e2e8f0;padding-bottom:2px;margin-bottom:4px;">
              הכנסות החייב, בן/בת הזוג וסיכום
            </div>

            <div class="sub-title">הכנסות החייב</div>

            <div class="row" style="flex-wrap:wrap;">
              מקצוע:
              <input type="text" class="short">
              מקום עבודה:
              <input type="text" class="short">
            </div>

            <div class="row">
              <span class="employment-toggle" data-toggle-group="debtor-employment">
                <span class="small-text">היקף משרה:</span>
                <button type="button" class="toggle-btn" data-value="full">משרה מלאה</button>
                <button type="button" class="toggle-btn" data-value="partial">משרה חלקית</button>
              </span>
            </div>

            <div class="row not-working-toggle-row" id="debtorIncomeRow" style="flex-wrap:wrap; justify-content: flex-start; gap: 12px;">
              <span class="pair">
                <label>שכר נטו:</label>
                <input type="text" id="debtorNetIncome" class="short currency-input">
                <label><input type="checkbox" id="debtorNotWorking"> החייב אינו עובד</label>
              </span>
              <span class="pair" style="margin-inline-start: 10px;">
                <label style="white-space:nowrap;">פוטנציאל השתכרות:</label>
                <input type="text" id="earningPotential" class="short currency-input">
              </span>
            </div>

            <div class="row">
              הערות:
              <input type="text" id="earningPotentialNotes" class="flex-1">
            </div>

            <!-- קצבאות כחלק מהכנסות החייב -->
            <div class="row" style="flex-wrap:wrap; align-items:center;">
              <span class="allowance-title">קצבאות:</span>
              <label><input type="checkbox"> קצבת ילד נכה</label>
              <label><input type="checkbox"> הבטחת הכנסה</label>
              <label><input type="checkbox"> סיוע שכ"ד</label>
              <span class="pair">
                סה"כ קצבאות:
                <input type="text" id="allowancesTotal" class="short currency-input">
              </span>
            </div>

            <div class="inline-add-field">
              <button type="button" class="add-field-btn" data-menu-id="income-add-menu">＋ הוסף שדה בהכנסות</button>
              <select id="income-add-menu" class="add-field-select" style="display:none;">
                <option value="">בחר מה להוסיף…</option>
                <option value="extra-income">הכנסה נוספת</option>
                <option value="extra-job">מקום עבודה נוסף</option>
              </select>
            </div>

            <hr>

            <div class="sub-title">הכנסות בן/בת הזוג</div>

            <div class="row" style="flex-wrap:wrap;">
              מקצוע:
              <input type="text" class="short">
              מקום עבודה:
              <input type="text" class="short">
            </div>

            <div class="row">
              <span class="employment-toggle" data-toggle-group="spouse-employment">
                <span class="small-text">היקף משרה:</span>
                <button type="button" class="toggle-btn" data-value="full">משרה מלאה</button>
                <button type="button" class="toggle-btn" data-value="partial">משרה חלקית</button>
              </span>
            </div>

            <div class="row not-working-toggle-row" id="spouseIncomeRow">
              שכר נטו:
              <input type="text" id="spouseNetIncome" class="short currency-input">
              <label><input type="checkbox" id="spouseNotWorking"> בן/בת הזוג אינו/ה עובד/ת</label>
            </div>

            <hr>

            <div class="income-expense-row">
              <span class="pair">
                <label>סך הכל הכנסות:</label>
                <input type="text" id="familyIncomeTotal" class="currency-input short">
              </span>
              <span class="pair">
                <label>סך הכל הוצאות:</label>
                <input type="text" id="familyExpensesTotal" class="currency-input short">
              </span>
            </div>
          </div>

          <!-- צעד 4: המלצות -->
          <div data-step="4" data-label="המלצות" class="card grid-item-B1" id="trusteeCard">
            <div class="section-title" style="border-bottom:1px solid #e2e8f0;padding-bottom:2px;margin-bottom:4px;">
              סיכום והמלצות הנאמן
            </div>

            <div class="row" style="justify-content:space-between;align-items:center;">
              <div class="sub-title" style="margin-bottom:0;">סיכום הנאמן</div>
              <label><input type="checkbox"> הכשרה כלכלית</label>
            </div>
            <div class="row">
              <textarea rows="2" class="flex-1" placeholder="תמצית עמדת הנאמן (שתי שורות)"></textarea>
            </div>

            <div class="row" style="justify-content:flex-start;align-items:center;">
              <div class="sub-title" style="margin-bottom:0;">המלצת נאמן</div>
            </div>
            <div class="order-box" style="margin-top:2px;">
              <div class="recom-grid">
                <div class="recom-item">
                  <label>סכום חודשי</label>
                  <input type="text" id="trusteeMonthly" class="currency-input xshort" maxlength="6">
                </div>
                <div class="recom-item">
                  <label>משך</label>
                  <input type="number" id="trusteeDuration" class="tiny" min="0" max="99">
                </div>
                <div class="recom-item">
                  <label>סכום כולל</label>
                  <input type="text" id="trusteeTotal" class="currency-input xshort recom-total" readonly>
                </div>
              </div>
            </div>

            <hr>
            <div class="section-title" style="border-bottom:1px solid #e2e8f0;padding-bottom:2px;margin-bottom:4px; margin-top:8px;">
              סיכום והמלצות הממונה
            </div>

            <div class="row" style="justify-content:space-between;align-items:center;margin-top:6px;">
              <div class="sub-title" style="margin-bottom:0;">סיכום הממונה</div>
              <label><input type="checkbox"> הכשרה כלכלית</label>
            </div>
            <div class="row">
              <textarea rows="2" class="flex-1" placeholder="תמצית עמדת הממונה (שתי שורות)"></textarea>
            </div>

            <div class="row" style="justify-content:flex-start;align-items:center;">
              <div class="sub-title" style="margin-bottom:0;">המלצת הממונה</div>
            </div>
            <div class="order-box order-box-comm" style="margin-top:2px;">
              <div class="recom-grid">
                <div class="recom-item">
                  <label>סכום חודשי</label>
                  <input type="text" id="commMonthly" class="currency-input xshort" maxlength="6">
                </div>
                <div class="recom-item">
                  <label>משך</label>
                  <input type="number" id="commDuration" class="tiny" min="0" max="99">
                </div>
                <div class="recom-item">
                  <label>סכום כולל</label>
                  <input type="text" id="commTotal" class="currency-input xshort recom-total" readonly>
                </div>
              </div>
            </div>

            <div class="row">
              נימוקים להמלצת הממונה:
              <textarea rows="2" class="flex-1" placeholder="נימוקים קצרים"></textarea>
            </div>

            <hr>
            <div class="row" style="align-items:center; gap:8px;">
              <button type="button" id="showRecBtn" class="btn-toggle-block">הצג המלצות ומחשבון</button>
              <button type="button" id="hideRecBtn" class="btn-toggle-block">הסתר המלצות ומחשבון</button>
              <span class="small-text">
                כפתורים אלו שולטים בתצוגת בלוק ההמלצות והמחשבון לעבודה שוטפת בלבד. בהדפסה ובצילום מסך כל הדוח מוצג תמיד במלואו.
              </span>
            </div>
          </div>

          <!-- מחשבון -->
          <div data-step="4-calc" data-label="מחשבון" class="calc-frame-card card grid-item-B2" id="calcCard" style="padding-top: 0; padding-bottom: 0;">
            <div class="sub-title" style="margin-top:0;">מחשבון צו תשלומים</div>
            <iframe src="payment-order-calculator.html" loading="lazy"></iframe>
          </div>

        </div>
      </div>
    </form>

    <div class="footer">
      נבנה על ידי אליאב יחיאל
    </div>
  </div>

  <!-- מובייל: התקדמות וניווט -->
  <div class="mobile-fixed-elements progress-container-wrapper">
    <div class="progress-container">
      <span id="current-step-label" class="step-label">1. פרטי תיק</span>
      <div class="progress-bar">
        <div id="progress-fill" class="progress-fill"></div>
      </div>
      <span id="progress-text">1/4</span>
    </div>
  </div>

  <div class="mobile-fixed-elements mobile-navigation-wrapper">
    <div class="mobile-navigation">
      <button type="button" id="nav-prev" class="mobile-nav-btn nav-prev" disabled>← קודם</button>
      <button type="button" id="nav-next" class="mobile-nav-btn nav-next">הבא →</button>
    </div>
  </div>

  <button type="button" id="scrollTopBtn" class="scroll-top-btn">↑</button>

  <script>
    const formFlowContainer = document.getElementById('form-flow-container');
    const navPrevBtn = document.getElementById('nav-prev');
    const navNextBtn = document.getElementById('nav-next');
    const progressFill = document.getElementById('progress-fill');
    const progressText = document.getElementById('progress-text');
    const currentStepLabel = document.getElementById('current-step-label');

    const allSteps = [
      document.querySelector('[data-step="1"]'),
      document.querySelector('[data-step="2"]'),
      document.querySelector('[data-step="3"]'),
      document.querySelector('[data-step="4"]')
    ];

    const totalSteps = allSteps.length;
    let currentStep = 1;

    function isMobileView() {
      return window.innerWidth <= 800;
    }

    function updateFlow() {
      if (!isMobileView()) {
        formFlowContainer.style.transform = `translateX(0)`;
      } else {
        const offset = (currentStep - 1) * -25;
        formFlowContainer.style.transform = `translateX(${offset}%)`;
      }

      const progressPercent = (currentStep / totalSteps) * 100;
      progressFill.style.width = `${progressPercent}%`;
      progressText.textContent = `${currentStep}/${totalSteps}`;

      navPrevBtn.disabled = currentStep === 1;
      navNextBtn.disabled = currentStep === totalSteps;

      let currentLabel = 'טופס סיום';
      if (currentStep === 1) currentLabel = allSteps[0].dataset.label;
      if (currentStep === 2) currentLabel = allSteps[1].dataset.label;
      if (currentStep === 3) currentLabel = allSteps[2].dataset.label;
      if (currentStep === 4) currentLabel = "המלצות ומחשבון";

      currentStepLabel.textContent = `${currentStep}. ${currentLabel}`;

      document.body.scrollTop = 0;
      document.documentElement.scrollTop = 0;
    }

    function navigate(direction) {
      const newStep = currentStep + direction;
      if (newStep >= 1 && newStep <= totalSteps) {
        currentStep = newStep;
        updateFlow();
      }
    }

    if (navNextBtn) navNextBtn.addEventListener('click', () => navigate(1));
    if (navPrevBtn) navPrevBtn.addEventListener('click', () => navigate(-1));

    let touchStartX = 0;
    let touchEndX = 0;

    formFlowContainer.addEventListener('touchstart', e => {
      if (!isMobileView()) return;
      touchStartX = e.changedTouches[0].screenX;
    });

    formFlowContainer.addEventListener('touchend', e => {
      if (!isMobileView()) return;
      touchEndX = e.changedTouches[0].screenX;
      handleGesture();
    });

    function handleGesture() {
      const swipeThreshold = 50;
      const diff = touchEndX - touchStartX;

      if (Math.abs(diff) > swipeThreshold) {
        if (diff > 0) {
          navigate(-1);
        } else {
          navigate(1);
        }
      }
    }

    function setupPercentField(id) {
      const el = document.getElementById(id);
      if (!el) return;
      el.addEventListener('focus', () => {
        el.value = el.value.replace('%','').trim();
      });
      el.addEventListener('blur', () => {
        let v = el.value.replace(/[^\d]/g,'');
        if (!v) { el.value = ''; updateIncapacityVisualAndCalcFlags(); return; }
        if (v.length > 3) v = v.slice(0,3);
        el.value = v + '%';
        updateIncapacityVisualAndCalcFlags();
      });
    }

    setupPercentField('disabilityPercent');
    setupPercentField('incapacityPercent');

    function attachCurrencyFormatting() {
      const inputs = document.querySelectorAll(".currency-input");
      inputs.forEach(input => {
        if (input.__currencyAttached) return;
        input.__currencyAttached = true;

        input.addEventListener("focus", () => {
          if (input.hasAttribute('readonly')) return;
          const raw = input.value.replace(/[^\d.]/g, "");
          input.value = raw;
        });
        input.addEventListener("blur", () => {
          let v = input.value.replace(/[^\d.]/g, "");
          if (!v) {
            input.value = "";
            return;
          }
          const num = parseFloat(v.replace(/,/g, ""));
          if (!isNaN(num)) {
            input.value = num.toLocaleString("he-IL", {
              minimumFractionDigits: 0,
              maximumFractionDigits: 2
            }) + " ₪";
          }
        });
      });
    }

    function sendEmail() {
      const subject = encodeURIComponent('דו"ח מסכם לדיון צו שיקום');
      const body = encodeURIComponent(
        'מצורף דו"ח סיכום לדיון צו שיקום כלכלי.\n\n' +
        '(ליצירת PDF – השתמש/י בכפתור הדפסה ושמור/י כ-PDF, ולאחר מכן צרף/י את הקובץ למייל.)'
      );
      window.location.href = 'mailto:?subject=' + subject + '&body=' + body;
    }

    function screenshotReport() {
      const root = document.querySelector('.page');
      if (!root) return;

      const trusteeCard = document.getElementById('trusteeCard');
      const calcCard = document.getElementById('calcCard');
      const trusteeCollapsed = trusteeCard && trusteeCard.classList.contains('collapsed');
      const calcCollapsed = calcCard && calcCard.classList.contains('collapsed');

      document.body.classList.add('capture-mode');
      if (trusteeCard) trusteeCard.classList.remove('collapsed');
      if (calcCard) calcCard.classList.remove('collapsed');

      html2canvas(root, {
        useCORS:true,
        allowTaint:true,
        scale:2,
        backgroundColor:'#ffffff'
      }).then(canvas => {
        const data = canvas.toDataURL('image/png');
        const w = window.open('','_blank');
        w.document.write('<img src="'+data+'" style="max-width:100%;display:block;margin:0 auto">');
        w.document.title = 'צילום דו"ח סיכום';
      }).catch(() => {
        alert('שגיאה ביצירת צילום המסך');
      }).finally(() => {
        if (trusteeCard && trusteeCollapsed) trusteeCard.classList.add('collapsed');
        if (calcCard && calcCollapsed) calcCard.classList.add('collapsed');
        document.body.classList.remove('capture-mode');
      });
    }

    function setupNotWorkingToggle(checkboxId, rowId, incomeInputId) {
      const chk = document.getElementById(checkboxId);
      const row = document.getElementById(rowId);
      const incomeEl = incomeInputId ? document.getElementById(incomeInputId) : null;
      if (!chk || !row) return;
      function update() {
        if (chk.checked) {
          row.classList.add('not-working-section');
          if (incomeEl) {
            incomeEl.value = '';
            incomeEl.setAttribute('readonly','readonly');
            incomeEl.classList.add('readonly');
          }
        } else {
          row.classList.remove('not-working-section');
          if (incomeEl) {
            incomeEl.removeAttribute('readonly');
            incomeEl.classList.remove('readonly');
          }
        }
      }
      chk.addEventListener('change', update);
      update();
    }

    function setupReportsStatusColors() {
      const radios = document.querySelectorAll('input[name="reports_status"]');
      if (!radios.length) return;

      function update() {
        const fullLabel = document.querySelector('.reports-status-full');
        const noneLabel = document.querySelector('.reports-status-none');
        if (fullLabel) fullLabel.classList.remove('status-ok','status-bad');
        if (noneLabel) noneLabel.classList.remove('status-ok','status-bad');

        const checked = document.querySelector('input[name="reports_status"]:checked');
        if (!checked) return;

        if (checked.value === 'full' && fullLabel) {
          fullLabel.classList.add('status-ok');
        }
        if (checked.value === 'none' && noneLabel) {
          noneLabel.classList.add('status-bad');
        }
      }

      radios.forEach(r => r.addEventListener('change', update));
      update();
    }

    function parseNumberFromCurrency(val) {
      if (!val) return 0;
      const clean = String(val).replace(/[^\d.]/g,'');
      const num = parseFloat(clean);
      return isNaN(num) ? 0 : num;
    }

    function updateRecommendationTotals() {
      const tm = document.getElementById('trusteeMonthly');
      const td = document.getElementById('trusteeDuration');
      const tt = document.getElementById('trusteeTotal');

      const cm = document.getElementById('commMonthly');
      const cd = document.getElementById('commDuration');
      const ct = document.getElementById('commTotal');

      if (tm && td && tt) {
        const m = parseNumberFromCurrency(tm.value);
        const d = parseInt(td.value || '0', 10) || 0;
        const total = m * d;
        tt.value = total ? total.toLocaleString('he-IL', {minimumFractionDigits:0, maximumFractionDigits:2}) + ' ₪' : '';
      }

      if (cm && cd && ct) {
        const m2 = parseNumberFromCurrency(cm.value);
        const d2 = parseInt(cd.value || '0', 10) || 0;
        const total2 = m2 * d2;
        ct.value = total2 ? total2.toLocaleString('he-IL', {minimumFractionDigits:0, maximumFractionDigits:2}) + ' ₪' : '';
      }
    }

    function calculatePaymentsTotals() {
      const orderDateInput   = document.getElementById('orderDate');
      const monthlyInput     = document.getElementById('monthlyPayment');
      const gradedInput      = document.getElementById('gradedPayment');
      const gradedDateInput  = document.getElementById('gradedFromDate');
      const totalDateInput   = document.getElementById('paymentsTotalDate');
      const totalAmountInput = document.getElementById('paymentsTotalAmount');
      const monthsSinceInput = document.getElementById('monthsSinceOrder');

      if (!orderDateInput || !monthlyInput || !totalDateInput || !totalAmountInput) return;

      const today = new Date();
      totalDateInput.value = today.toLocaleDateString('he-IL');

      if (!orderDateInput.value) {
        totalAmountInput.value = '';
        if (monthsSinceInput) monthsSinceInput.value = '';
        return;
      }

      const orderDate = new Date(orderDateInput.value);
      if (isNaN(orderDate)) {
        totalAmountInput.value = '';
        if (monthsSinceInput) monthsSinceInput.value = '';
        return;
      }

      // חישוב מספר חודשים מהצו להיום (ללא קשר למדורג)
      if (monthsSinceInput) {
        const oY = orderDate.getFullYear();
        const oM = orderDate.getMonth();
        const tY = today.getFullYear();
        const tM = today.getMonth();
        const diffIdx = (tY * 12 + tM) - (oY * 12 + oM) + 1;
        const months = diffIdx > 0 ? diffIdx : 0;
        monthsSinceInput.value = months ? months.toString() : '';
      }

      const monthlyAmount = parseNumberFromCurrency(monthlyInput.value);
      const gradedAmount  = gradedInput ? parseNumberFromCurrency(gradedInput.value) : 0;
      const gradedDateVal = gradedDateInput ? gradedDateInput.value : '';

      if (!monthlyAmount && !gradedAmount) {
        totalAmountInput.value = '';
        return;
      }

      const toIndex = (y,m) => y*12 + m;

      const firstPayMonthDate = new Date(orderDate.getTime());
      firstPayMonthDate.setMonth(firstPayMonthDate.getMonth() + 1);

      const firstY = firstPayMonthDate.getFullYear();
      const firstM = firstPayMonthDate.getMonth();

      const todayY = today.getFullYear();
      const todayM = today.getMonth();

      const firstIdx = toIndex(firstY, firstM);
      const todayIdx = toIndex(todayY, todayM);

      const monthDiffInclusive = (startIndex, endIndex) => {
        const diff = endIndex - startIndex + 1;
        return diff > 0 ? diff : 0;
      };

      if (todayIdx < firstIdx) {
        totalAmountInput.value = '';
        return;
      }

      let total = 0;

      if (!gradedAmount || !gradedDateVal) {
        const monthsAll = monthDiffInclusive(firstIdx, todayIdx);
        total = monthsAll * monthlyAmount;
      } else {
        const gradedDate = new Date(gradedDateVal);
        if (isNaN(gradedDate)) {
          const monthsAll = monthDiffInclusive(firstIdx, todayIdx);
          total = monthsAll * monthlyAmount;
        } else {
          const gY = gradedDate.getFullYear();
          const gM = gradedDate.getMonth();
          const gIdx = toIndex(gY, gM);

          if (gIdx > todayIdx) {
            const monthsAll = monthDiffInclusive(firstIdx, todayIdx);
            total = monthsAll * monthlyAmount;
          } else {
            if (gIdx <= firstIdx) {
              const monthsAll = monthDiffInclusive(firstIdx, todayIdx);
              const useAmount = gradedAmount || monthlyAmount;
              total = monthsAll * useAmount;
            } else {
              const beforeEndIdx = gIdx - 1;
              const monthsBefore = monthDiffInclusive(firstIdx, beforeEndIdx);
              const monthsAfter = monthDiffInclusive(gIdx, todayIdx);
              total = (monthsBefore * monthlyAmount) + (monthsAfter * gradedAmount);
            }
          }
        }
      }

      if (!total) {
        totalAmountInput.value = '';
      } else {
        totalAmountInput.value = total.toLocaleString('he-IL', {
          minimumFractionDigits: 0,
          maximumFractionDigits: 2
        }) + ' ₪';
      }
    }

    let calcFrame = null;
    let calcReady = false;
    window.__incapacityFullOnly = false;

    function syncCalculatorFromForm() {
      const calcFrameElement = document.querySelector('.calc-frame-card iframe');
      if (!calcFrameElement) return;

      calcFrame = calcFrameElement;
      if (!calcReady || !calcFrame || !calcFrame.contentWindow) return;

      const w   = calcFrame.contentWindow;
      const doc = w.document;
      if (!doc) return;

      const debtorIncomeEl = document.getElementById('debtorNetIncome');
      const spouseIncomeEl = document.getElementById('spouseNetIncome');
      const kidsEl         = document.getElementById('minorChildrenCount');
      const alimonyChk     = document.getElementById('hasAlimony');
      const alimonyAmtEl   = document.getElementById('alimonyAmount');
      const allowancesEl   = document.getElementById('allowancesTotal');

      const debtorNetRaw  = debtorIncomeEl ? parseNumberFromCurrency(debtorIncomeEl.value) : 0;
      const spouseNet     = spouseIncomeEl ? parseNumberFromCurrency(spouseIncomeEl.value) : 0;
      const kidsCount     = kidsEl ? (parseInt(kidsEl.value || '0', 10) || 0) : 0;
      const hasAlimony    = alimonyChk ? alimonyChk.checked : false;
      const alimonyAmt    = alimonyAmtEl ? parseNumberFromCurrency(alimonyAmtEl.value) : 0;
      const allowancesNet = allowancesEl ? parseNumberFromCurrency(allowancesEl.value) : 0;

      let debtorForCalc = debtorNetRaw;
      if (window.__incapacityFullOnly) {
        debtorForCalc = allowancesNet;
      }

      const salaryDebtor = doc.getElementById('salaryDebtor');
      if (salaryDebtor) {
        salaryDebtor.value = debtorForCalc || '';
        salaryDebtor.dispatchEvent(new w.Event('input', {bubbles:true}));
      }

      const salaryPartner = doc.getElementById('salaryPartner');
      if (salaryPartner) {
        salaryPartner.value = spouseNet || '';
        salaryPartner.dispatchEvent(new w.Event('input', {bubbles:true}));
      }

      try {
        const n = Math.max(0, Math.min(10, kidsCount));
        if (typeof w.eval === 'function') {
          w.eval('childrenCount = ' + n + ';');
          if (typeof w.updateChildrenLabel === 'function') {
            w.updateChildrenLabel();
          }
        }
      } catch (e) {}

      const alimonyInput = doc.getElementById('alimonyExpenses');
      if (alimonyInput) {
        if (hasAlimony && alimonyAmt > 0) {
          alimonyInput.value = alimonyAmt;
        } else {
          alimonyInput.value = '';
        }
        alimonyInput.dispatchEvent(new w.Event('input', {bubbles:true}));
      }

      const familyRadios = document.querySelectorAll('input[name="family_status"]');
      let familyValue = '';
      familyRadios.forEach(r => { if (r.checked) familyValue = r.value; });

      let targetType = null;
      if (familyValue === 'נשוי') {
        targetType = 'זוג';
      } else if (familyValue === 'רווק' || familyValue === 'גרוש' || familyValue === 'אלמן') {
        targetType = 'רווק';
      }

      if (targetType) {
        const ftButtons = doc.querySelectorAll('.family-type');
        ftButtons.forEach(btn => {
          if (btn.dataset.type === targetType) {
            btn.click();
          }
        });
      }

      if (typeof w.calc === 'function') {
        w.calc();
      }
    }

    function initCalculatorSync() {
      calcFrame = document.querySelector('.calc-frame-card iframe');
      if (!calcFrame) return;
      calcFrame.addEventListener('load', () => {
        calcReady = true;
        syncCalculatorFromForm();
      });
    }

    function saveFormState() {
      const form = document.getElementById('reportForm');
      if (!form) return;
      const fields = form.querySelectorAll('input, textarea, select');
      const data = [];
      fields.forEach((el) => {
        data.push({
          type: el.type,
          tag: el.tagName,
          id: el.id || null,
          name: el.name || null,
          value: el.value,
          checked: el.checked || false
        });
      });
      try {
        localStorage.setItem('insolvencyReportFormV2', JSON.stringify(data));
      } catch (e) {}
    }

    function restoreFormState() {
      const form = document.getElementById('reportForm');
      if (!form) return;
      let data;
      try {
        data = JSON.parse(localStorage.getItem('insolvencyReportFormV2') || 'null');
      } catch (e) {
        data = null;
      }
      if (!Array.isArray(data)) {
        alert('לא נמצאו נתונים לשחזור.');
        return;
      }
      const fields = form.querySelectorAll('input, textarea, select');
      fields.forEach((el, idx) => {
        const item = data[idx];
        if (!item) return;
        if (el.type === 'checkbox' || el.type === 'radio') {
          el.checked = !!item.checked;
        } else {
          el.value = item.value || '';
        }
      });

      setupReportsStatusColors();
      setupNotWorkingToggle('debtorNotWorking', 'debtorIncomeRow', 'debtorNetIncome');
      setupNotWorkingToggle('spouseNotWorking', 'spouseIncomeRow', 'spouseNetIncome');
      attachCurrencyFormatting();
      updateRecommendationTotals();
      calculatePaymentsTotals();
      updateArrearsHighlight();
      updateAlimonyHighlight();
      updateIncapacityVisualAndCalcFlags();
      syncCalculatorFromForm();
      alert('הנתונים שוחזרו מהגרסה האחרונה שנשמרה.');
    }

    function setupScrollTopButton() {
      const btn = document.getElementById('scrollTopBtn');
      if (!btn) return;
      window.addEventListener('scroll', () => {
        if (window.scrollY > 200) {
          btn.style.display = 'flex';
        } else {
          btn.style.display = 'none';
        }
      });
      btn.addEventListener('click', () => {
        window.scrollTo({top: 0, behavior: 'smooth'});
      });
    }

    function updateArrearsHighlight() {
      const arrearsInput = document.getElementById('arrearsAmount');
      if (!arrearsInput) return;
      const wrapper = arrearsInput.closest('.arrears-wrapper');
      if (!wrapper) return;
      const val = parseNumberFromCurrency(arrearsInput.value);
      if (val > 0) {
        wrapper.classList.add('arrears-active');
      } else {
        wrapper.classList.remove('arrears-active');
      }
    }

    function updateAlimonyHighlight() {
      const chk = document.getElementById('hasAlimony');
      const amt = document.getElementById('alimonyAmount');
      const wrap = document.getElementById('alimonyWrapper');
      if (!chk || !amt || !wrap) return;
      const has = chk.checked || parseNumberFromCurrency(amt.value) > 0;
      if (has) {
        wrap.classList.add('alimony-active');
      } else {
        wrap.classList.remove('alimony-active');
      }
    }

    function updateIncapacityVisualAndCalcFlags() {
      const incapEl = document.getElementById('incapacityPercent');
      const disEl = document.getElementById('disabilityPercent');
      const row = document.getElementById('incapacityRow');
      if (!incapEl || !row) return;

      const incapVal = parseInt(incapEl.value.replace(/[^\d]/g,'') || '0', 10) || 0;
      const disVal = disEl ? (parseInt(disEl.value.replace(/[^\d]/g,'') || '0', 10) || 0) : 0;

      row.classList.remove('incapacity-low','incapacity-high','incapacity-full');
      let fullOnly = false;

      if (incapVal > 0 && incapVal < 75) {
        row.classList.add('incapacity-low');
      } else if (incapVal >= 75 && incapVal < 100) {
        row.classList.add('incapacity-high');
      } else if (incapVal === 100) {
        row.classList.add('incapacity-full');
        if (!disVal) {
          fullOnly = true;
        }
      }

      window.__incapacityFullOnly = fullOnly;
    }

    function setupToggleButtons() {
      const groups = document.querySelectorAll('[data-toggle-group]');
      groups.forEach(group => {
        const buttons = group.querySelectorAll('button.toggle-btn');
        buttons.forEach(btn => {
          btn.addEventListener('click', () => {
            buttons.forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            group.dataset.value = btn.dataset.value || '';
          });
        });
      });
    }

    function setupDynamicAddField() {
      const triggers = document.querySelectorAll('.add-field-btn');
      triggers.forEach(btn => {
        const menuId = btn.dataset.menuId;
        const menu = document.getElementById(menuId);
        if (!menu) return;

        btn.addEventListener('click', () => {
          menu.style.display = (menu.style.display === 'none' || !menu.style.display) ? 'inline-block' : 'none';
        });

        menu.addEventListener('change', () => {
          const val = menu.value;
          if (!val) return;
          if (val === 'extra-income') addExtraIncomeRow();
          if (val === 'extra-job') addExtraJobRow();
          menu.value = '';
          menu.style.display = 'none';
        });
      });
    }

    function addExtraIncomeRow() {
      const card = document.getElementById('incomeCard');
      if (!card) return;
      const row = document.createElement('div');
      row.className = 'row extra-field-row';
      row.innerHTML = 'הכנסה נוספת: <input type="text" class="short currency-input">';
      card.appendChild(row);
      attachCurrencyFormatting();
    }

    function addExtraJobRow() {
      const card = document.getElementById('incomeCard');
      if (!card) return;
      const row = document.createElement('div');
      row.className = 'row extra-field-row';
      row.innerHTML = 'מקום עבודה נוסף: <input type="text" class="short">';
      card.appendChild(row);
    }

    function setupRecommendationsToggle() {
      const trusteeCard = document.getElementById('trusteeCard');
      const calcCard = document.getElementById('calcCard');
      const showBtn = document.getElementById('showRecBtn');
      const hideBtn = document.getElementById('hideRecBtn');
      if (!trusteeCard || !calcCard || !showBtn || !hideBtn) return;

      function setVisible(visible) {
        if (visible) {
          trusteeCard.classList.remove('collapsed');
          calcCard.classList.remove('collapsed');
          showBtn.disabled = true;
          hideBtn.disabled = false;
        } else {
          trusteeCard.classList.add('collapsed');
          calcCard.classList.add('collapsed');
          showBtn.disabled = false;
          hideBtn.disabled = true;
        }
      }

      showBtn.addEventListener('click', () => setVisible(true));
      hideBtn.addEventListener('click', () => setVisible(false));

      // מצב ברירת מחדל: הכל מוצג
      setVisible(true);
    }

    document.addEventListener("DOMContentLoaded", () => {
      attachCurrencyFormatting();
      setupNotWorkingToggle('debtorNotWorking', 'debtorIncomeRow', 'debtorNetIncome');
      setupNotWorkingToggle('spouseNotWorking', 'spouseIncomeRow', 'spouseNetIncome');
      setupReportsStatusColors();
      setupScrollTopButton();
      initCalculatorSync();
      updateFlow();
      setupToggleButtons();
      setupDynamicAddField();
      setupRecommendationsToggle();

      const form = document.getElementById('reportForm');
      if (form) {
        form.addEventListener('input', (e) => {
          if (e.target && (
            e.target.id === 'trusteeMonthly' ||
            e.target.id === 'trusteeDuration' ||
            e.target.id === 'commMonthly' ||
            e.target.id === 'commDuration'
          )) {
            updateRecommendationTotals();
          }
          if (e.target && (
            e.target.id === 'orderDate' ||
            e.target.id === 'monthlyPayment' ||
            e.target.id === 'gradedPayment' ||
            e.target.id === 'gradedFromDate'
          )) {
            calculatePaymentsTotals();
          }
          if (e.target && e.target.id === 'arrearsAmount') {
            updateArrearsHighlight();
          }
          if (e.target && (e.target.id === 'hasAlimony' || e.target.id === 'alimonyAmount')) {
            updateAlimonyHighlight();
          }
          if (e.target && (e.target.id === 'disabilityPercent' || e.target.id === 'incapacityPercent')) {
            updateIncapacityVisualAndCalcFlags();
          }

          saveFormState();
          syncCalculatorFromForm();
        });

        form.addEventListener('change', (e) => {
          if (e.target && (
            e.target.id === 'trusteeMonthly' ||
            e.target.id === 'trusteeDuration' ||
            e.target.id === 'commMonthly' ||
            e.target.id === 'commDuration'
          )) {
            updateRecommendationTotals();
          }
          if (e.target && (
            e.target.id === 'orderDate' ||
            e.target.id === 'monthlyPayment' ||
            e.target.id === 'gradedPayment' ||
            e.target.id === 'gradedFromDate'
          )) {
            calculatePaymentsTotals();
          }
          if (e.target && (e.target.id === 'hasAlimony' || e.target.id === 'alimonyAmount')) {
            updateAlimonyHighlight();
          }
          if (e.target && e.target.id === 'arrearsAmount') {
            updateArrearsHighlight();
          }
          if (e.target && (e.target.id === 'disabilityPercent' || e.target.id === 'incapacityPercent')) {
            updateIncapacityVisualAndCalcFlags();
          }

          saveFormState();
          syncCalculatorFromForm();
        });
      }

      calculatePaymentsTotals();
      updateArrearsHighlight();
      updateAlimonyHighlight();
      updateIncapacityVisualAndCalcFlags();
    });

    window.addEventListener('resize', () => {
      currentStep = 1;
      updateFlow();
    });
  </script>
</body>
</html>

